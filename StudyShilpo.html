<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EduEnv - English Learning</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide.min.js"></script>

    <style>
      /* Custom styles for a premium feel */
      body {
        font-family: "Inter", sans-serif;
        background-color: #f8fafc; /* Tailwind gray-50 */
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1; /* Tailwind slate-300 */
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8; /* Tailwind slate-400 */
      }

      /* Reader text selection */
      ::selection {
        background-color: #cce7ff; /* A light blue */
        color: #1e293b;
      }

      /* Custom class for word spans */
      .word-span {
        cursor: pointer;
        transition: background-color 0.15s ease-in-out;
        border-radius: 3px;
      }
      .word-span:hover {
        background-color: #e0f2fe; /* Tailwind sky-100 */
      }

      /* Word status highlighting */
      .word-status-1 {
        /* New */
        background-color: #fef9c3; /* Tailwind yellow-100 */
        border-bottom: 2px solid #facc15; /* Tailwind yellow-400 */
      }
      .word-status-2 {
        /* Learning */
        background-color: #dbeafe; /* Tailwind blue-100 */
        border-bottom: 2px solid #60a5fa; /* Tailwind blue-400 */
      }
      .word-status-3 {
        /* Known */
        /* No special highlight, or a very subtle one */
        color: #64748b; /* Tailwind slate-500 */
      }

      /* Sidebar transition */
      #word-definition-sidebar {
        transition: transform 0.3s ease-in-out;
      }

      /* View transitions */
      .view {
        display: none; /* Hidden by default */
      }

      /* Simple fade-in animation */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .view.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out forwards;
      }

      /* Loading spinner */
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        border-left-color: #3b82f6; /* Tailwind blue-500 */
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="text-gray-800">
    <!-- Global Loading Overlay -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center"
    >
      <div class="spinner"></div>
    </div>

    <!-- Login View -->
    <div
      id="login-view"
      class="min-h-screen flex items-center justify-center bg-gray-50 p-4"
    >
      <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center text-blue-600 mb-2">
          Welcome to EduEnv
        </h1>
        <p class="text-center text-gray-500 mb-6">
          Your premium English learning partner.
        </p>

        <!-- Email/Password Form -->
        <form id="login-form" class="space-y-4">
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700"
              >Email</label
            >
            <input
              type="email"
              id="email"
              name="email"
              required
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div>
            <label
              for="password"
              class="block text-sm font-medium text-gray-700"
              >Password</label
            >
            <input
              type="password"
              id="password"
              name="password"
              required
              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
          <div class="flex items-center justify-between pt-2">
            <button
              id="login-button"
              type="submit"
              class="w-full mr-2 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Login
            </button>
            <button
              id="signup-button"
              type="button"
              class="w-full ml-2 inline-flex justify-center py-2 px-4 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Sign Up
            </button>
          </div>
        </form>

        <!-- OR Separator -->
        <div class="my-6 flex items-center justify-center">
          <div class="border-t border-gray-200 flex-grow"></div>
          <span class="px-4 text-sm text-gray-400">OR</span>
          <div class="border-t border-gray-200 flex-grow"></div>
        </div>

        <!-- Social Login -->
        <button
          id="google-login-button"
          class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"
        >
          <svg
            class="w-5 h-5 mr-2"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 48 48"
          >
            <path
              fill="#FFC107"
              d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"
            />
            <path
              fill="#FF3D00"
              d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"
            />
            <path
              fill="#4CAF50"
              d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"
            />
            <path
              fill="#1976D2"
              d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C42.012,36.218,44,30.498,44,24C44,22.659,43.862,21.35,43.611,20.083z"
            />
          </svg>
          Sign in with Google
        </button>
        <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
      </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden min-h-screen">
      <!-- Header -->
      <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between h-16">
            <div class="flex items-center">
              <a
                href="#"
                class="flex-shrink-0 flex items-center nav-link"
                data-view="library-view"
              >
                <span class="text-2xl font-bold text-blue-600">EduEnv</span>
              </a>
              <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                <a
                  href="#"
                  class="nav-link border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 text-sm font-medium"
                  data-view="library-view"
                >
                  <i data-lucide="library" class="mr-2 h-5 w-5"></i> Library
                </a>
                <a
                  href="#"
                  class="nav-link border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 text-sm font-medium"
                  data-view="vocab-view"
                >
                  <i data-lucide="book-check" class="mr-2 h-5 w-5"></i> My
                  Vocabulary
                </a>
              </div>
            </div>
            <div class="flex items-center">
              <div id="user-info" class="flex items-center">
                <span id="user-email" class="text-sm text-gray-600 mr-3"></span>
                <button
                  id="logout-button"
                  class="bg-blue-100 text-blue-700 hover:bg-blue-200 px-3 py-1.5 rounded-md text-sm font-medium"
                >
                  Sign Out
                </button>
              </div>
            </div>
          </div>
        </nav>
      </header>

      <!-- Main Content -->
      <main
        id="main-content"
        class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"
      >
        <!-- Library View -->
        <div id="library-view" class="view">
          <h1 class="text-3xl font-bold text-gray-900 mb-6">
            Your Learning Library
          </h1>
          <div
            id="library-grid"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
          >
            <!-- Library items will be injected by JS -->
          </div>
          <div id="library-loading" class="flex justify-center mt-8">
            <div class="spinner"></div>
          </div>
          <div
            id="library-empty"
            class="text-center text-gray-500 mt-8"
            style="display: none;"
          >
            <i
              data-lucide="folder-search"
              class="h-12 w-12 mx-auto mb-2 text-gray-400"
            ></i>
            <p>No lessons found in the library.</p>
          </div>
        </div>

        <!-- Reader View -->
        <div id="reader-view" class="view">
          <button
            id="back-to-library"
            class="mb-4 inline-flex items-center text-blue-600 hover:text-blue-800"
          >
            <i data-lucide="arrow-left" class="mr-2 h-4 w-4"></i> Back to
            Library
          </button>
          <div class="flex flex-col lg:flex-row gap-6">
            <!-- Reader Text -->
            <div class="lg:w-2/3 bg-white p-6 sm:p-8 rounded-xl shadow-lg">
              <h1
                id="reader-title"
                class="text-3xl font-bold text-gray-900 mb-6"
              ></h1>
              <div
                id="reader-content"
                class="text-lg leading-loose text-gray-700"
                style="white-space: pre-line;"
              >
                <!-- Reader text will be injected here -->
              </div>
            </div>
            <!-- Definition Sidebar (Static on desktop, part of flex on mobile) -->
            <div class="lg:w-1/3">
              <div
                id="word-definition-sidebar-content"
                class="bg-white p-6 rounded-xl shadow-lg sticky top-24"
              >
                <!-- Content will be injected by JS -->
                <div
                  id="definition-placeholder"
                  class="text-center text-gray-400"
                >
                  <i
                    data-lucide="mouse-pointer-click"
                    class="h-10 w-10 mx-auto mb-2"
                  ></i>
                  <p>Click on a word in the text to see its definition.</p>
                </div>
                <div
                  id="definition-loading"
                  class="text-center text-gray-400"
                  style="display: none;"
                >
                  <div class="spinner mx-auto"></div>
                  <p class="mt-2">Looking up word...</p>
                </div>
                <div id="definition-content" style="display: none;">
                  <h2 id="defined-word" class="text-2xl font-bold mb-2"></h2>
                  <p id="defined-phonetic" class="text-gray-500 mb-4"></p>
                  <div
                    id="defined-meanings"
                    class="space-y-4 max-h-60 overflow-y-auto pr-2"
                  >
                    <!-- Meanings injected here -->
                  </div>
                  <div class="mt-6">
                    <p class="text-sm font-medium mb-2">Save this word as:</p>
                    <div class="flex space-x-2">
                      <button
                        data-status="1"
                        class="save-word-btn flex-1 text-sm bg-yellow-100 text-yellow-800 hover:bg-yellow-200 px-3 py-2 rounded-md"
                      >
                        New
                      </button>
                      <button
                        data-status="2"
                        class="save-word-btn flex-1 text-sm bg-blue-100 text-blue-800 hover:bg-blue-200 px-3 py-2 rounded-md"
                      >
                        Learning
                      </button>
                      <button
                        data-status="3"
                        class="save-word-btn flex-1 text-sm bg-gray-100 text-gray-800 hover:bg-gray-200 px-3 py-2 rounded-md"
                      >
                        Known
                      </button>
                    </div>
                    <p
                      id="save-success"
                      class="text-green-600 text-sm mt-2"
                      style="display: none;"
                    >
                      Word saved!
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Vocabulary View -->
        <div id="vocab-view" class="view">
          <h1 class="text-3xl font-bold text-gray-900 mb-6">My Vocabulary</h1>
          <div id="vocab-loading" class="flex justify-center mt-8">
            <div class="spinner"></div>
          </div>
          <div
            id="vocab-empty"
            class="text-center text-gray-500 mt-8"
            style="display: none;"
          >
            <i
              data-lucide="book-check"
              class="h-12 w-12 mx-auto mb-2 text-gray-400"
            ></i>
            <p>You haven't saved any words yet.</p>
            <p class="text-sm">
              Start reading in the Library to build your vocabulary!
            </p>
          </div>
          <div id="vocab-lists" class="space-y-8" style="display: none;">
            <!-- Vocab sections will be injected by JS -->
            <div>
              <h2
                class="text-2xl font-semibold mb-4 pb-2 border-b-2 border-yellow-400 flex items-center"
              >
                <span class="w-3 h-3 bg-yellow-400 rounded-full mr-3"></span>
                New Words
              </h2>
              <div id="vocab-list-1" class="space-y-3"></div>
            </div>
            <div>
              <h2
                class="text-2xl font-semibold mb-4 pb-2 border-b-2 border-blue-400 flex items-center"
              >
                <span class="w-3 h-3 bg-blue-400 rounded-full mr-3"></span>
                Learning
              </h2>
              <div id="vocab-list-2" class="space-y-3"></div>
            </div>
            <div>
              <h2
                class="text-2xl font-semibold mb-4 pb-2 border-b-2 border-gray-400 flex items-center"
              >
                <span class="w-3 h-3 bg-gray-400 rounded-full mr-3"></span>
                Known Words
              </h2>
              <div id="vocab-list-3" class="space-y-3"></div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
      // Import Firebase modules
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
        onAuthStateChanged,
        setPersistence,
        browserLocalPersistence,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        addDoc,
        collection,
        query,
        where,
        getDocs,
        onSnapshot,
        deleteDoc,
        writeBatch,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

      // --- GLOBAL VARIABLES ---
      let app, auth, db;
      let currentUserId = null;
      let currentWordData = null; // Holds data for the currently selected word
      let vocabUnsubscribe = null; // To detach Firestore listener
      let userVocabulary = new Map(); // Cache for user's vocab

      // --- CONFIG & APP ID ---
      // User's explicitly provided Firebase configuration (as a fallback)
      const defaultFirebaseConfig = {
        apiKey: "AIzaSyCFVD4Ts03OXJ14aJ5h_HGAAuiIg5nme7A",
        authDomain: "edu-env.firebaseapp.com",
        projectId: "edu-env",
        storageBucket: "edu-env.firebasestorage.app",
        messagingSenderId: "259668089849",
        appId: "1:259668089849:web:70a92e04ce3331ed533b28",
        measurementId: "G-VK9WTY47JB",
      };

      // These variables are expected to be provided by the environment
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-app-id";
      const firebaseConfigStr =
        typeof __firebase_config !== "undefined" ? __firebase_config : "{}";
      const initialAuthToken =
        typeof __initial_auth_token !== "undefined"
          ? __initial_auth_token
          : null;

      // Start with the default/fallback config
      let firebaseConfig = defaultFirebaseConfig;

      // Try to override with environment config if available and valid
      try {
        const envConfig = JSON.parse(firebaseConfigStr);
        if (envConfig && envConfig.apiKey) {
          firebaseConfig = envConfig; // Use environment config if it's valid
        }
      } catch (e) {
        console.error(
          "Error parsing environment Firebase config. Using default config.",
          e
        );
        // firebaseConfig remains defaultFirebaseConfig
      }

      // --- UI ELEMENTS ---
      const loginView = document.getElementById("login-view");
      const appContainer = document.getElementById("app-container");
      const loadingOverlay = document.getElementById("loading-overlay");
      const loginError = document.getElementById("login-error");

      const libraryView = document.getElementById("library-view");
      const readerView = document.getElementById("reader-view");
      const vocabView = document.getElementById("vocab-view");
      const mainContent = document.getElementById("main-content");

      const definitionSidebar = document.getElementById(
        "word-definition-sidebar-content"
      );
      const defPlaceholder = document.getElementById("definition-placeholder");
      const defLoading = document.getElementById("definition-loading");
      const defContent = document.getElementById("definition-content");
      const definedWord = document.getElementById("defined-word");
      const definedPhonetic = document.getElementById("defined-phonetic");
      const definedMeanings = document.getElementById("defined-meanings");
      const saveSuccess = document.getElementById("save-success");

      const vocabLists = document.getElementById("vocab-lists");
      const vocabLoading = document.getElementById("vocab-loading");
      const vocabEmpty = document.getElementById("vocab-empty");
      const vocabList1 = document.getElementById("vocab-list-1");
      const vocabList2 = document.getElementById("vocab-list-2");
      const vocabList3 = document.getElementById("vocab-list-3");

      // --- INITIALIZATION ---
      async function main() {
        if (!firebaseConfig.apiKey) {
          console.error(
            "Firebase config is missing, even the default configuration failed."
          );
          loadingOverlay.innerHTML =
            "<p class='text-red-500'>Error: Firebase configuration is critically missing.</p>";
          return;
        }

        try {
          // Initialize Firebase
          app = initializeApp(firebaseConfig);
          auth = getAuth(app);
          db = getFirestore(app);
          setLogLevel("Debug"); // For development

          // Set auth persistence
          await setPersistence(auth, browserLocalPersistence);

          let authReadyPromise;

          // Handle Auth State
          authReadyPromise = new Promise((resolve) => {
            const unsubscribe = onAuthStateChanged(auth, async (user) => {
              if (user) {
                // User is signed in
                currentUserId = user.uid;
                document.getElementById("user-email").textContent =
                  user.email || "Profile";
                loginView.style.display = "none";
                appContainer.style.display = "block";

                // Attach vocabulary listener
                attachVocabListener();

                // Ensure data operations only happen AFTER successful sign-in
                await seedLibraryData();
                loadLibrary();

                // Load initial view (Library)
                showView("library-view");

                loadingOverlay.style.display = "none";
                resolve(); // Resolve promise when auth is ready
              } else {
                // User is signed out
                currentUserId = null;
                appContainer.style.display = "none";
                loginView.style.display = "flex";
                loadingOverlay.style.display = "none";

                // Detach listener if it exists
                if (vocabUnsubscribe) {
                  vocabUnsubscribe();
                  vocabUnsubscribe = null;
                }
                userVocabulary.clear();
                resolve(); // Resolve promise even if signed out, allowing UI setup
              }
              // Stop listening after the first state change, whether signed in or out
              unsubscribe();
            });
          });

          // --- Initial Sign-In Logic (Removed Anonymous Sign-in) ---
          if (initialAuthToken) {
            try {
              // Attempt custom token sign-in if token is present
              await auth.signInWithCustomToken(initialAuthToken);
            } catch (e) {
              console.warn(
                "Custom token sign-in failed. Displaying login screen for manual authentication.",
                e
              );
              // If custom sign-in fails, onAuthStateChanged handles the unauthenticated state.
            }
          }

          // Wait for auth state change to process before proceeding
          await authReadyPromise;

          // Add Event Listeners
          setupEventListeners();

          // Initialize Lucide icons
          setTimeout(() => {
            if (typeof lucide !== "undefined" && lucide.createIcons) {
              lucide.createIcons();
            }
          }, 100);
        } catch (error) {
          console.error("Firebase initialization failed:", error);
          loadingOverlay.innerHTML = `<p class='text-red-500'>Error: ${error.message}</p>`;
        }
      }

      // --- EVENT LISTENERS ---
      function setupEventListeners() {
        // Login/Signup
        document
          .getElementById("login-form")
          .addEventListener("submit", handleLogin);
        document
          .getElementById("signup-button")
          .addEventListener("click", handleSignup);
        document
          .getElementById("google-login-button")
          .addEventListener("click", handleGoogleLogin);
        document
          .getElementById("logout-button")
          .addEventListener("click", handleLogout);

        // Navigation
        document.querySelectorAll(".nav-link").forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const viewId = e.currentTarget.dataset.view;
            showView(viewId);
          });
        });

        // Reader
        document
          .getElementById("back-to-library")
          .addEventListener("click", () => showView("library-view"));
        document
          .getElementById("reader-content")
          .addEventListener("click", handleWordClick);
        document.querySelectorAll(".save-word-btn").forEach((btn) => {
          btn.addEventListener("click", saveWord);
        });
      }

      // --- AUTH FUNCTIONS ---
      async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        loginError.textContent = "";

        try {
          await signInWithEmailAndPassword(auth, email, password);
          // onAuthStateChanged will handle the rest
        } catch (error) {
          console.error("Login failed:", error);
          loginError.textContent = error.message;
        }
      }

      async function handleSignup(e) {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        loginError.textContent = "";

        if (password.length < 6) {
          loginError.textContent =
            "Password must be at least 6 characters long.";
          return;
        }

        try {
          await createUserWithEmailAndPassword(auth, email, password);
          // onAuthStateChanged will handle the rest
        } catch (error) {
          console.error("Signup failed:", error);
          loginError.textContent = error.message;
        }
      }

      async function handleGoogleLogin() {
        loginError.textContent = "";
        try {
          const provider = new GoogleAuthProvider();
          await signInWithPopup(auth, provider);
          // onAuthStateChanged will handle the rest
        } catch (error) {
          console.error("Google login failed:", error);
          loginError.textContent = error.message;
        }
      }

      async function handleLogout() {
        try {
          await signOut(auth);
          // onAuthStateChanged will handle the rest
        } catch (error) {
          console.error("Logout failed:", error);
        }
      }

      // --- VIEW MANAGEMENT ---
      function showView(viewId) {
        // Hide all views
        document.querySelectorAll(".view").forEach((view) => {
          view.classList.remove("active");
        });

        // Show the requested view
        const activeView = document.getElementById(viewId);
        if (activeView) {
          activeView.classList.add("active");
        }

        // Handle view-specific logic
        if (viewId === "library-view") {
          loadLibrary();
        } else if (viewId === "vocab-view") {
          // The onSnapshot listener handles rendering, just need to show it
          renderVocabulary();
        } else if (viewId === "reader-view") {
          // This view is shown by clicking a lesson,
          // so we just reset the definition panel
          resetDefinitionPanel();
        }

        // Update nav link active state
        document.querySelectorAll(".nav-link").forEach((link) => {
          if (link.dataset.view === viewId) {
            link.classList.add("border-blue-500", "text-gray-900");
            link.classList.remove("border-transparent", "text-gray-500");
          } else {
            link.classList.remove("border-blue-500", "text-gray-900");
            link.classList.add("border-transparent", "text-gray-500");
          }
        });
      }

      // --- FIRESTORE: LIBRARY & SEEDING ---
      async function seedLibraryData() {
        if (!currentUserId) {
          console.log("Skipping library seeding: User not authenticated.");
          return;
        }

        const libraryCol = collection(
          db,
          "artifacts",
          appId,
          "public",
          "data",
          "library"
        );

        try {
          const snapshot = await getDocs(query(libraryCol));
          if (snapshot.empty) {
            console.log("Seeding library data...");
            const batch = writeBatch(db);

            const sampleTexts = [
              {
                title: "The Fox and the Grapes",
                level: "Easy",
                content:
                  "A hungry fox saw some fine bunches of grapes hanging from a vine. He tried to reach them but they were too high. 'I don't want them anyway,' he said as he walked away. 'I'm sure they are sour.'\n\nIt is easy to despise what you cannot get.",
              },
              {
                title: "A Brief History of Coffee",
                level: "Medium",
                content:
                  "Coffee is a beloved beverage for millions of people. Its history begins in Ethiopia, where, according to legend, a goat herder named Kaldi discovered its energetic effects. From the Arabian Peninsula, coffee spread to Europe and then to the Americas.\n\nToday, it is a global commodity, with complex flavors and cultural rituals. Many people cannot imagine starting their day without a cup of this dark, aromatic drink. The industry supports economies and connects people across the world.",
              },
              {
                title: "Introduction to Artificial Intelligence",
                level: "Hard",
                content:
                  "Artificial Intelligence (AI) refers to the simulation of human intelligence in machines. These machines are programmed to think like humans and mimic their actions. The term may also be applied to any machine that exhibits traits associated with a human mind such as learning and problem-solving.\n\nSubsets of AI include machine learning, deep learning, and natural language processing. These technologies are rapidly evolving, impacting industries from healthcare to finance and raising profound questions about the future of humanity.",
              },
            ];

            sampleTexts.forEach((text) => {
              const docRef = doc(libraryCol); // Auto-generates ID
              batch.set(docRef, text);
            });

            await batch.commit();
            console.log("Library data seeded.");
          } else {
            console.log("Library data already exists.");
          }
        } catch (error) {
          console.error("Error checking/seeding library data:", error);
        }
      }

      async function loadLibrary() {
        if (!currentUserId) {
          document.getElementById("library-loading").style.display = "none";
          document.getElementById("library-grid").innerHTML =
            '<p class="text-red-500">Please sign in to view the library content.</p>';
          return;
        }

        const grid = document.getElementById("library-grid");
        const loading = document.getElementById("library-loading");
        const empty = document.getElementById("library-empty");

        grid.innerHTML = ""; // Clear existing
        loading.style.display = "flex";
        empty.style.display = "none";

        try {
          const libraryCol = collection(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "library"
          );
          const snapshot = await getDocs(query(libraryCol));

          if (snapshot.empty) {
            empty.style.display = "block";
          } else {
            snapshot.forEach((doc) => {
              const lesson = doc.data();
              const lessonId = doc.id;
              const card = document.createElement("div");
              card.className =
                "bg-white p-6 rounded-xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer";
              card.dataset.lessonId = lessonId;

              let levelColor = "bg-green-100 text-green-800";
              if (lesson.level === "Medium")
                levelColor = "bg-yellow-100 text-yellow-800";
              if (lesson.level === "Hard")
                levelColor = "bg-red-100 text-red-800";

              card.innerHTML = `
                            <span class="inline-block px-3 py-1 text-xs font-medium rounded-full ${levelColor} mb-2">${
                lesson.level
              }</span>
                            <h2 class="text-xl font-bold text-gray-800 mb-2">${
                              lesson.title
                            }</h2>
                            <p class="text-gray-500 text-sm mb-4">${lesson.content.substring(
                              0,
                              100
                            )}...</p>
                            <a href="#" class="font-medium text-blue-600 hover:text-blue-800">Start Reading &rarr;</a>
                        `;

              card.addEventListener("click", () => loadLesson(lessonId));
              grid.appendChild(card);
            });
          }
        } catch (error) {
          console.error("Error loading library:", error);
          grid.innerHTML = `<p class="text-red-500">Could not load library. Please check permissions. ${error.message}</p>`;
        } finally {
          loading.style.display = "none";
        }
      }

      // --- FIRESTORE: VOCABULARY ---
      function attachVocabListener() {
        if (vocabUnsubscribe) {
          vocabUnsubscribe(); // Detach old listener
        }
        if (!currentUserId) {
          console.log(
            "Skipping vocab listener attachment: User not authenticated."
          );
          return;
        }

        const vocabCol = collection(
          db,
          "artifacts",
          appId,
          "users",
          currentUserId,
          "vocabulary"
        );

        vocabUnsubscribe = onSnapshot(
          query(vocabCol),
          (snapshot) => {
            userVocabulary.clear();
            snapshot.forEach((doc) => {
              userVocabulary.set(doc.id, doc.data());
            });
            console.log(
              `Vocabulary cache updated: ${userVocabulary.size} words.`
            );

            // If vocab view is active, re-render it
            if (
              document.getElementById("vocab-view").classList.contains("active")
            ) {
              renderVocabulary();
            }

            // If reader view is active, re-highlight words
            if (
              document
                .getElementById("reader-view")
                .classList.contains("active")
            ) {
              highlightWordsInReader();
            }
          },
          (error) => {
            console.error("Error listening to vocabulary:", error);
          }
        );
      }

      function renderVocabulary() {
        if (!currentUserId) return;

        vocabLoading.style.display = "none";
        vocabList1.innerHTML = "";
        vocabList2.innerHTML = "";
        vocabList3.innerHTML = "";

        if (userVocabulary.size === 0) {
          vocabEmpty.style.display = "block";
          vocabLists.style.display = "none";
          return;
        }

        vocabEmpty.style.display = "none";
        vocabLists.style.display = "block";

        // Sort vocabulary by date saved, descending
        const sortedVocab = Array.from(userVocabulary.entries()).sort(
          (a, b) => {
            const timeA = a[1].savedAt?.toMillis() || 0;
            const timeB = b[1].savedAt?.toMillis() || 0;
            return timeB - timeA;
          }
        );

        for (const [word, data] of sortedVocab) {
          const card = document.createElement("div");
          card.className =
            "bg-white p-4 rounded-lg shadow-sm border border-gray-200";
          card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">${word}</h3>
                            <p class="text-gray-600 text-sm">${data.definition}</p>
                            <p class="text-gray-400 text-xs italic mt-2">"${data.context}"</p>
                        </div>
                        <button data-word="${word}" class="delete-word-btn text-gray-400 hover:text-red-500 ml-4">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `;

          if (data.status == 1) vocabList1.appendChild(card);
          else if (data.status == 2) vocabList2.appendChild(card);
          else if (data.status == 3) vocabList3.appendChild(card);
        }

        // Add delete listeners
        document.querySelectorAll(".delete-word-btn").forEach((btn) => {
          btn.addEventListener("click", async (e) => {
            const word = e.currentTarget.dataset.word;
            // NOTE: Using inline text but logging a reminder
            console.warn(
              "NOTE: Using window.confirm. Replace with custom modal for production environment."
            );
            if (window.confirm(`Are you sure you want to delete "${word}"?`)) {
              await deleteWord(word);
            }
          });
        });

        // Re-render icons
        setTimeout(() => {
          if (typeof lucide !== "undefined" && lucide.createIcons) {
            lucide.createIcons();
          }
        }, 0);
      }

      async function deleteWord(word) {
        if (!currentUserId) return;
        const wordDocRef = doc(
          db,
          "artifacts",
          appId,
          "users",
          currentUserId,
          "vocabulary",
          word.toLowerCase()
        );
        try {
          await deleteDoc(wordDocRef);
          console.log(`Word "${word}" deleted.`);
          // onSnapshot will handle the UI update
        } catch (error) {
          console.error("Error deleting word:", error);
        }
      }

      // --- READER LOGIC ---
      async function loadLesson(lessonId) {
        if (!currentUserId) return;

        console.log(`Loading lesson: ${lessonId}`);
        showView("reader-view");

        const readerTitle = document.getElementById("reader-title");
        const readerContent = document.getElementById("reader-content");

        readerTitle.textContent = "Loading...";
        readerContent.innerHTML = '<div class="spinner mx-auto"></div>';

        try {
          const lessonRef = doc(
            db,
            "artifacts",
            appId,
            "public",
            "data",
            "library",
            lessonId
          );
          const lessonDoc = await getDoc(lessonRef);

          if (lessonDoc.exists()) {
            const lesson = lessonDoc.data();
            readerTitle.textContent = lesson.title;

            // Tokenize and render text
            const words = lesson.content.split(/([ \n,.;!?"'()])/); // Split on words and punctuation/whitespace
            const fragment = document.createDocumentFragment();

            words.forEach((word) => {
              const span = document.createElement("span");
              // Check if it's a word or just whitespace/punctuation
              if (word.match(/[a-zA-Z]+/)) {
                span.textContent = word;
                span.className = "word-span";
                span.dataset.word = word.toLowerCase().replace(/[^a-z]/g, ""); // Normalize

                // Apply highlighting from cache
                const vocabData = userVocabulary.get(span.dataset.word);
                if (vocabData) {
                  span.classList.add(`word-status-${vocabData.status}`);
                }
              } else {
                // It's whitespace or punctuation, not interactive
                span.textContent = word;
              }
              fragment.appendChild(span);
            });

            readerContent.innerHTML = "";
            readerContent.appendChild(fragment);
          } else {
            readerTitle.textContent = "Error";
            readerContent.textContent = "Lesson not found.";
          }
        } catch (error) {
          console.error("Error loading lesson:", error);
          readerTitle.textContent = "Error";
          readerContent.textContent = `Could not load lesson: ${error.message}`;
        }
      }

      function highlightWordsInReader() {
        document
          .querySelectorAll("#reader-content .word-span")
          .forEach((span) => {
            // Remove all existing status classes
            span.classList.remove(
              "word-status-1",
              "word-status-2",
              "word-status-3"
            );

            // Add new one if it exists in cache
            const word = span.dataset.word;
            const vocabData = userVocabulary.get(word);
            if (vocabData) {
              span.classList.add(`word-status-${vocabData.status}`);
            }
          });
      }

      function resetDefinitionPanel() {
        defPlaceholder.style.display = "block";
        defLoading.style.display = "none";
        defContent.style.display = "none";
        saveSuccess.style.display = "none";
        currentWordData = null;
      }

      async function handleWordClick(e) {
        if (!e.target.classList.contains("word-span")) {
          return; // Not a word
        }

        const word = e.target.dataset.word;
        if (!word) return;

        console.log(`Clicked word: ${word}`);

        // Show loading
        defPlaceholder.style.display = "none";
        defLoading.style.display = "block";
        defContent.style.display = "none";
        saveSuccess.style.display = "none";

        try {
          // 1. Check our Firestore cache first
          const savedWordData = userVocabulary.get(word);
          let definition, phonetic, meanings;

          if (savedWordData && savedWordData.apiData) {
            // Use cached API data
            console.log("Loading word from cache.");
            const apiData = savedWordData.apiData;
            phonetic = apiData.phonetic;
            meanings = apiData.meanings;
          } else {
            // 2. Fetch from Dictionary API
            console.log("Fetching from Dictionary API...");
            // Exponential backoff retry logic for external API calls
            const MAX_RETRIES = 3;
            let lastError = null;
            let data = null;

            for (let i = 0; i < MAX_RETRIES; i++) {
              try {
                const response = await fetch(
                  `https://api.dictionaryapi.dev/api/v2/entries/en/${word}`
                );
                if (!response.ok) {
                  throw new Error("Word not found in dictionary or API error.");
                }
                data = await response.json();
                break; // Success
              } catch (error) {
                lastError = error;
                if (i < MAX_RETRIES - 1) {
                  const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
                  console.log(`Retrying API call in ${delay}ms...`);
                  await new Promise((resolve) => setTimeout(resolve, delay));
                }
              }
            }

            if (!data) {
              throw (
                lastError ||
                new Error("Failed to fetch definition after multiple retries.")
              );
            }

            const entry = data[0];
            phonetic = entry.phonetic || entry.phonetics[0]?.text || "";
            meanings = entry.meanings.map((m) => ({
              partOfSpeech: m.partOfSpeech,
              definition:
                m.definitions[0]?.definition || "No definition available.",
            }));
          }

          // 3. Get context sentence
          const context = getContextSentence(e.target);

          // 4. Store current word data globally for saving
          currentWordData = {
            word: word,
            definition: meanings[0].definition,
            context: context,
            apiData: { phonetic, meanings }, // Cache the full API response
          };

          // 5. Display definition
          definedWord.textContent = word;
          definedPhonetic.textContent = phonetic;
          definedMeanings.innerHTML = ""; // Clear old meanings

          meanings.forEach((meaning) => {
            definedMeanings.innerHTML += `
                        <div class="mb-3">
                            <h4 class="font-semibold text-blue-700">${meaning.partOfSpeech}</h4>
                            <p class="text-gray-700">${meaning.definition}</p>
                        </div>
                    `;
          });

          defLoading.style.display = "none";
          defContent.style.display = "block";
        } catch (error) {
          console.error("Error fetching definition:", error);
          defLoading.style.display = "none";
          defContent.style.display = "block";
          definedWord.textContent = word;
          definedPhonetic.textContent = "";
          definedMeanings.innerHTML = `<p class="text-red-500">${error.message}</p>`;
        }
      }

      function getContextSentence(wordSpan) {
        // Find all spans in the reader
        const allSpans = Array.from(
          document.querySelectorAll("#reader-content span")
        );
        const currentIndex = allSpans.indexOf(wordSpan);

        let startIndex = currentIndex;
        let endIndex = currentIndex;

        // Go back to find start of sentence
        while (
          startIndex > 0 &&
          !allSpans[startIndex].textContent.match(/[.!?]/)
        ) {
          startIndex--;
        }
        if (startIndex > 0) startIndex++; // Don't include the period from prev sentence

        // Go forward to find end of sentence
        while (
          endIndex < allSpans.length - 1 &&
          !allSpans[endIndex].textContent.match(/[.!?]/)
        ) {
          endIndex++;
        }

        const contextSpans = allSpans.slice(startIndex, endIndex + 1);
        let context = contextSpans.map((s) => s.textContent).join("");

        return context.trim().replace(/\n/g, " ");
      }

      async function saveWord(e) {
        if (!currentWordData || !currentUserId) return;

        const status = e.currentTarget.dataset.status;
        const word = currentWordData.word;

        const wordDocRef = doc(
          db,
          "artifacts",
          appId,
          "users",
          currentUserId,
          "vocabulary",
          word.toLowerCase()
        );

        try {
          await setDoc(
            wordDocRef,
            {
              word: word,
              status: parseInt(status, 10),
              definition: currentWordData.definition,
              context: currentWordData.context,
              apiData: currentWordData.apiData, // Save the full API data
              savedAt: serverTimestamp(),
            },
            { merge: true }
          ); // Use merge:true to update if exists

          console.log(`Word "${word}" saved with status ${status}`);

          // Show success message
          saveSuccess.style.display = "block";
          setTimeout(() => {
            saveSuccess.style.display = "none";
          }, 2000);

          // onSnapshot will handle highlighting
        } catch (error) {
          console.error("Error saving word:", error);
        }
      }

      // --- START THE APP ---
      main();
    </script>
  </body>
</html>
