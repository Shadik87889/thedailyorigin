<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Title will be set dynamically -->
    <title>The Daily Origin</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap"
      rel="stylesheet"
    />

    <!-- NEW: Google Fonts for Logo -->
    <link
      href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&display=swap"
      rel="stylesheet"
    />

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles (Reused from index.html for consistency) -->
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #020617; /* slate-950 */
        color: #d1d5db; /* gray-300 */
        overflow-x: hidden;
      }
      .header-glass {
        background-color: rgba(2, 6, 23, 0.6); /* slate-950 with 60% opacity */
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-bottom: 1px solid #1e293b; /* slate-800 */
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #0f172a;
      }
      ::-webkit-scrollbar-thumb {
        background: #0891b2;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #22d3ee;
      }

      /* NEW: Logo Font Styles */
      .logo-artisan {
        font-family: "Caveat", cursive;
      }
      .logo-main {
        font-family: "Oswald", sans-serif;
        font-weight: 700;
      }

      /* Loading Spinner */
      #loading-spinner {
        border: 4px solid #1e293b; /* slate-800 */
        border-top: 4px solid #22d3ee; /* cyan-400 */
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Premium Section Title Style */
      .section-title {
        position: relative;
        padding-bottom: 0.75rem; /* 12px */
        margin-bottom: 2rem; /* 32px */
        border-bottom: 1px solid #1e293b; /* slate-800 */
      }
      .section-title::after {
        content: "";
        position: absolute;
        bottom: -1px; /* sits on top of the border */
        left: 0;
        width: 100px; /* fixed width for the gradient line */
        height: 2px;
        background: linear-gradient(
          to right,
          #22d3ee,
          #0891b2
        ); /* cyan-400 to cyan-700 */
      }

      /* Gradient text */
      .text-gradient {
        background: linear-gradient(
          to right,
          #22d3ee,
          #60a5fa
        ); /* cyan-400 to blue-400 */
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-fill-color: transparent;
      }

      /* NEW: Text ellipsis utility classes (from home.html) */
      .text-ellipsis-lines-2 {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .text-ellipsis-lines-3 {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* --- NEW: Premium Desktop Nav Link Hover Effect --- */
      .desktop-nav-link {
        position: relative;
        padding-bottom: 4px; /* Give space for the line */
      }

      .desktop-nav-link::after {
        content: "";
        position: absolute;
        bottom: 0; /* Align to the bottom of the 4px padding */
        left: 0;
        width: 100%;
        height: 2px;
        /* Use the same premium gradient from .text-gradient */
        background: linear-gradient(to right, #22d3ee, #60a5fa);
        transform: scaleX(0);
        transform-origin: left; /* Grow from left to right */
        transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1); /* Smoother ease */
      }

      .desktop-nav-link:hover::after {
        transform: scaleX(1);
      }

      /* Make the text slightly brighter on hover, instead of full cyan */
      .desktop-nav-link:hover {
        color: #e5e7eb; /* gray-200 */
      }
      /* --- End of Premium Effect --- */

      /* --- NEW: Advanced Mobile Menu Animations --- */

      /* Set initial state for nav links */
      #mobile-menu nav a {
        opacity: 0;
        transform: translateX(20px);
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
      }

      /* Set "open" state for nav links when menu-open class is added */
      #mobile-menu.menu-open nav a {
        opacity: 1;
        transform: translateX(0);
      }

      /* Staggered delay for links */
      #mobile-menu.menu-open nav a:nth-child(1) {
        transition-delay: 0.1s;
      }
      #mobile-menu.menu-open nav a:nth-child(2) {
        transition-delay: 0.15s;
      }
      #mobile-menu.menu-open nav a:nth-child(3) {
        transition-delay: 0.2s;
      }
      #mobile-menu.menu-open nav a:nth-child(4) {
        transition-delay: 0.25s;
      }
      #mobile-menu.menu-open nav a:nth-child(5) {
        transition-delay: 0.3s;
      }
      #mobile-menu.menu-open nav a:nth-child(6) {
        transition-delay: 0.35s;
      }
      #mobile-menu.menu-open nav a:nth-child(7) {
        transition-delay: 0.4s;
      }

      /* Set initial state for social links */
      #mobile-menu .mobile-social-links {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        transition-delay: 0.5s; /* Fires after the nav links */
      }

      /* Set "open" state for social links */
      #mobile-menu.menu-open .mobile-social-links {
        opacity: 1;
        transform: translateY(0);
      }
      /* --- End of Mobile Menu Animations --- */
    </style>
  </head>
  <body class="antialiased flex flex-col min-h-screen">
    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-slate-950 z-50 flex flex-col justify-center items-center"
    >
      <div id="loading-spinner"></div>
      <p class="text-cyan-400 mt-4 text-lg" id="loading-text">
        Loading Feed...
      </p>
    </div>

    <!-- Header (Reused from index.html) -->
    <header class="header-glass sticky top-0 z-40 w-full">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-20">
          <!-- Logo -->
          <a href="./home.html" class="flex items-baseline space-x-2">
            <span class="text-3xl text-white logo-main">The Daily</span>
            <span class="relative">
              <span class="text-4xl font-bold text-cyan-400 logo-artisan"
                >Origin</span
              >
              <!-- NEW: Handwritten SVG underline -->
              <svg
                class="absolute left-0 w-full h-4 -bottom-1 text-cyan-500"
                viewBox="0 0 100 20"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
                preserveAspectRatio="none"
              >
                <path
                  d="M2 12 C 30 22 70 22 98 12"
                  stroke="currentColor"
                  stroke-width="3"
                  stroke-linecap="round"
                ></path>
              </svg>
              <!-- NEW: Beta Tag -->
              <span
                class="absolute top-0 -right-5 transform -translate-y-1/2 rotate-12 bg-yellow-400 text-yellow-900 text-[10px] font-bold px-1.5 py-0.5 rounded-sm"
              >
                BETA
              </span>
            </span>
          </a>

          <!-- Desktop Navigation -->
          <!-- UPDATED: Added 'desktop-nav-link' class and removed hover:text-cyan-400 -->
          <nav class="hidden md:flex space-x-8">
            <a
              href="./category.html?category=World"
              class="text-sm font-medium text-gray-300 transition-colors desktop-nav-link"
              >World</a
            >
            <a
              href="./category.html?category=Tech"
              class="text-sm font-medium text-gray-300 transition-colors desktop-nav-link"
              >Tech</a
            >
            <a
              href="./category.html?category=Politics"
              class="text-sm font-medium text-gray-300 transition-colors desktop-nav-link"
              >Politics</a
            >
            <a
              href="./category.html?category=Culture"
              class="text-sm font-medium text-gray-300 transition-colors desktop-nav-link"
              >Culture</a
            >
            <a
              href="./category.html?category=Science"
              class="text-sm font-medium text-gray-300 transition-colors desktop-nav-link"
              >Science</a
            >
            <a
              href="./category.html?category=Sports"
              class="text-sm font-medium text-gray-300 transition-colors desktop-nav-link"
              >Sports</a
            >
            <a
              href="./category.html?category=Education"
              class="text-sm font-medium text-gray-300 transition-colors desktop-nav-link"
              >Education</a
            >
          </nav>

          <!-- Search and Mobile Menu Button -->
          <div class="flex items-center space-x-4">
            <!-- TODO: Re-add search button ID and logic -->
            <button class="text-gray-400 hover:text-cyan-400 transition-colors">
              <i data-lucide="search" class="w-6 h-6"></i>
            </button>
            <!-- UPDATED: Mobile Menu Button markup for icon switching -->
            <button
              class="md:hidden text-gray-400 hover:text-cyan-400 transition-colors"
              id="mobile-menu-btn"
            >
              <i
                data-lucide="menu"
                class="w-6 h-6"
                id="mobile-menu-open-icon"
              ></i>
              <i
                data-lucide="x"
                class="w-6 h-6 hidden"
                id="mobile-menu-close-icon"
              ></i>
            </button>
          </div>
        </div>
      </div>
      <!-- REMOVED: Old Mobile Menu (was here) -->
    </header>

    <!-- NEW: Mobile Menu Overlay -->
    <div
      id="mobile-menu-overlay"
      class="fixed inset-0 bg-black/70 z-40 opacity-0 invisible transition-opacity duration-300 ease-in-out md:hidden"
    ></div>

    <!-- NEW: Advanced Mobile Menu (Slides from right) -->
    <div
      id="mobile-menu"
      class="fixed top-0 right-0 h-full w-80 max-w-full bg-slate-950 z-50 transform translate-x-full transition-transform duration-300 ease-in-out md:hidden shadow-2xl shadow-black flex flex-col"
    >
      <!-- Menu Header (Stays at top) -->
      <div
        class="flex-shrink-0 flex justify-between items-center p-6 border-b border-slate-800"
      >
        <span class="text-xl font-bold text-white">Menu</span>
        <button
          class="text-gray-400 hover:text-cyan-400"
          id="mobile-menu-close-btn"
        >
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>

      <!-- Menu Links (Grows to fill space and scrolls if needed) -->
      <nav class="flex-grow flex flex-col p-6 overflow-y-auto">
        <a
          href="./category.html?category=World"
          class="block px-4 py-3 text-base font-medium text-gray-300 hover:text-cyan-400 hover:bg-slate-800 transition-colors border-b border-slate-800"
          >World</a
        >
        <a
          href="./category.html?category=Tech"
          class="block px-4 py-3 text-base font-medium text-gray-300 hover:text-cyan-400 hover:bg-slate-800 transition-colors border-b border-slate-800"
          >Tech</a
        >
        <a
          href="./category.html?category=Politics"
          class="block px-4 py-3 text-base font-medium text-gray-300 hover:text-cyan-400 hover:bg-slate-800 transition-colors border-b border-slate-800"
          >Politics</a
        >
        <a
          href="./category.html?category=Culture"
          class="block px-4 py-3 text-base font-medium text-gray-300 hover:text-cyan-400 hover:bg-slate-800 transition-colors border-b border-slate-800"
          >Culture</a
        >
        <a
          href="./category.html?category=Science"
          class="block px-4 py-3 text-base font-medium text-gray-300 hover:text-cyan-400 hover:bg-slate-800 transition-colors border-b border-slate-800"
          >Science</a
        >
        <a
          href="./category.html?category=Sports"
          class="block px-4 py-3 text-base font-medium text-gray-300 hover:text-cyan-400 hover:bg-slate-800 transition-colors border-b border-slate-800"
          >Sports</a
        >
        <a
          href="./category.html?category=Education"
          class="block px-4 py-3 text-base font-medium text-gray-300 hover:text-cyan-400 hover:bg-slate-800 transition-colors border-b border-slate-800"
          >Education</a
        >
      </nav>

      <!-- NEW: Social Links (Stays at bottom) -->
      <div
        class="flex-shrink-0 p-6 border-t border-slate-800 mobile-social-links"
      >
        <div class="flex space-x-6 justify-center">
          <a
            href="#"
            class="text-gray-400 hover:text-cyan-400 transition-colors"
            aria-label="Twitter"
          >
            <i data-lucide="twitter" class="w-6 h-6"></i>
          </a>
          <a
            href="#"
            class="text-gray-400 hover:text-cyan-400 transition-colors"
            aria-label="Facebook"
          >
            <i data-lucide="facebook" class="w-6 h-6"></i>
          </a>
          <a
            href="#"
            class="text-gray-400 hover:text-cyan-400 transition-colors"
            aria-label="Instagram"
          >
            <i data-lucide="instagram" class="w-6 h-6"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <main
      class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12 flex-grow"
    >
      <!-- Dynamic Category Section -->
      <section>
        <!-- Title will be dynamically inserted here -->
        <h1
          id="category-title"
          class="text-4xl md:text-5xl font-black text-white section-title tracking-tight"
        >
          Loading Category...
        </h1>

        <!-- Grid for articles -->
        <div
          id="articles-grid"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8"
        >
          <!-- Articles will be injected by JS -->
        </div>

        <div id="no-articles-message" class="hidden text-center py-16">
          <p class="text-2xl font-bold text-gray-400">No Articles Found</p>
          <p class="text-gray-500 mt-2">
            There are no articles in this category yet. Check back soon!
          </p>
          <a
            href="./home.html"
            class="mt-6 inline-block bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-bold py-2 px-6 rounded-lg transition-colors"
          >
            Back to Home
          </a>
        </div>
      </section>
    </main>

    <!-- Footer (Reused from index.html) -->
    <footer class="bg-slate-900 border-t border-slate-800 mt-16">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-8">
          <!-- Logo & About -->
          <div class="col-span-2 lg:col-span-2">
            <a href="./home.html" class="flex items-baseline space-x-2 mb-4">
              <span class="text-2xl text-white logo-main">The Daily</span>
              <span class="relative">
                <span class="text-3xl font-bold text-cyan-400 logo-artisan"
                  >Origin</span
                >
                <!-- NEW: Handwritten SVG underline (slightly smaller) -->
                <svg
                  class="absolute left-0 w-full h-3 -bottom-1 text-cyan-500"
                  viewBox="0 0 100 20"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  preserveAspectRatio="none"
                >
                  <path
                    d="M2 12 C 30 22 70 22 98 12"
                    stroke="currentColor"
                    stroke-width="3"
                    stroke-linecap="round"
                  ></path>
                </svg>
                <!-- NEW: Beta Tag -->
                <span
                  class="absolute top-0 -right-4 transform -translate-y-1/2 rotate-12 bg-yellow-400 text-yellow-900 text-[9px] font-bold px-1.5 py-0.5 rounded-sm"
                >
                  BETA
                </span>
              </span>
            </a>
            <p class="text-sm text-gray-400 max-w-xs">
              The future of information, delivered today. Unbiased, unfiltered,
              and uncompromising.
            </p>
          </div>

          <!-- Quick Links -->
          <div>
            <h3
              class="text-sm font-semibold text-gray-400 uppercase tracking-wider"
            >
              Categories
            </h3>
            <ul class="mt-4 space-y-2">
              <li>
                <a
                  href="./category.html?category=World"
                  class="text-sm text-gray-300 hover:text-cyan-400"
                  >World</a
                >
              </li>
              <li>
                <a
                  href="./category.html?category=Tech"
                  class="text-sm text-gray-300 hover:text-cyan-400"
                  >Tech</a
                >
              </li>
              <li>
                <a
                  href="./category.html?category=Politics"
                  class="text-sm text-gray-300 hover:text-cyan-400"
                  >Politics</a
                >
              </li>
              <li>
                <a
                  href="./category.html?category=Science"
                  class="text-sm text-gray-300 hover:text-cyan-400"
                  >Science</a
                >
              </li>
              <li>
                <a
                  href="./category.html?category=Culture"
                  class="text-sm text-gray-300 hover:text-cyan-400"
                  >Culture</a
                >
              </li>
              <li>
                <a
                  href="./category.html?category=Sports"
                  class="text-sm text-gray-300 hover:text-cyan-400"
                  >Sports</a
                >
              </li>
              <li>
                <a
                  href="./category.html?category=Education"
                  class="text-sm text-gray-300 hover:text-cyan-400"
                  >Education</a
                >
              </li>
            </ul>
          </div>

          <!-- Company -->
          <div>
            <h3
              class="text-sm font-semibold text-gray-400 uppercase tracking-wider"
            >
              Company
            </h3>
            <ul class="mt-4 space-y-2">
              <li>
                <a href="#" class="text-sm text-gray-300 hover:text-cyan-400"
                  >About Us</a
                >
              </li>
              <li>
                <a href="#" class="text-sm text-gray-300 hover:text-cyan-400"
                  >Careers</a
                >
              </li>
              <li>
                <a href="#" class="text-sm text-gray-300 hover:text-cyan-400"
                  >Ethics Policy</a
                >
              </li>
              <li>
                <a href="#" class="text-sm text-gray-300 hover:text-cyan-400"
                  >Contact</a
                >
              </li>
            </ul>
          </div>

          <!-- Legal -->
          <div>
            <h3
              class="text-sm font-semibold text-gray-400 uppercase tracking-wider"
            >
              Legal
            </h3>
            <ul class="mt-4 space-y-2">
              <li>
                <a href="#" class="text-sm text-gray-300 hover:text-cyan-400"
                  >Privacy Policy</a
                >
              </li>
              <li>
                <a href="#" class="text-sm text-gray-300 hover:text-cyan-400"
                  >Terms of Service</a
                >
              </li>
            </ul>
          </div>

          <!-- App -->
          <div>
            <h3
              class="text-sm font-semibold text-gray-400 uppercase tracking-wider"
            >
              Get the App
            </h3>
            <div class="mt-4 space-y-3">
              <a
                href="#"
                class="flex items-center justify-center bg-slate-800 hover:bg-slate-700 text-white py-2 px-3 rounded-lg text-sm"
                ><span>App Store</span></a
              >
              <a
                href="#"
                class="flex items-center justify-center bg-slate-800 hover:bg-slate-700 text-white py-2 px-3 rounded-lg text-sm"
                ><span>Google Play</span></a
              >
            </div>
          </div>
        </div>

        <!-- Bottom Bar -->
        <div
          class="mt-8 border-t border-slate-800 pt-8 flex flex-col md:flex-row justify-between items-center"
        >
          <p class="text-sm text-gray-400">
            &copy; 2025 The Daily Origin. All rights reserved.
          </p>
          <div class="flex space-x-6 mt-4 md:mt-0">
            <a
              href="#"
              class="text-gray-400 hover:text-cyan-400 transition-colors"
              ><i data-lucide="twitter" class="w-5 h-5"></i
            ></a>
            <a
              href="#"
              class="text-gray-400 hover:text-cyan-400 transition-colors"
              ><i data-lucide="facebook" class="w-5 h-5"></i
            ></a>
            <a
              href="#"
              class="text-gray-400 hover:text-cyan-400 transition-colors"
              ><i data-lucide="instagram" class="w-5 h-5"></i
            ></a>
          </div>
        </div>
      </div>
    </footer>

    <!-- Firebase and App Logic -->
    <script type="module">
      // Import Firebase functions
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        onSnapshot,
        query,
        where, // <-- NEW: Import 'where' for filtering
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- Your Provided Firebase Config ---
      const firebaseConfig = {
        apiKey: "AIzaSyCFVD4Ts03OXJ14aJ5h_HGAAuiIg5nme7A",
        authDomain: "edu-env.firebaseapp.com",
        projectId: "edu-env",
        storageBucket: "edu-env.firebasestorage.app",
        messagingSenderId: "259668089849",
        appId: "1:259668089849:web:70a92e04ce3331ed533b28",
        measurementId: "G-VK9WTY47JB",
      };

      // --- Global Variables ---
      let app, db, auth;
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "default-news-app";

      // --- UI Element References ---
      const loadingOverlay = document.getElementById("loading-overlay");
      const loadingText = document.getElementById("loading-text");
      const articlesGrid = document.getElementById("articles-grid");
      const categoryTitle = document.getElementById("category-title");
      const noArticlesMessage = document.getElementById("no-articles-message");
      const mobileMenu = document.getElementById("mobile-menu");
      const mobileMenuBtn = document.getElementById("mobile-menu-btn");

      // NEW: Mobile Menu Elements
      const mobileMenuOverlay = document.getElementById("mobile-menu-overlay");
      const mobileMenuOpenIcon = document.getElementById(
        "mobile-menu-open-icon"
      );
      const mobileMenuCloseIcon = document.getElementById(
        "mobile-menu-close-icon"
      );
      const mobileMenuCloseBtn = document.getElementById(
        "mobile-menu-close-btn"
      ); // Button inside the menu

      // REMOVED: Old Mobile Menu Toggle
      /*
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        */

      // NEW: Advanced Mobile Menu Functions
      function openMenu() {
        // Show Menu
        mobileMenu.classList.remove("translate-x-full");
        mobileMenu.classList.add("menu-open"); // NEW: Add class to trigger animations

        // Show Overlay
        mobileMenuOverlay.classList.remove("opacity-0", "invisible");

        // Toggle Icons
        mobileMenuOpenIcon.classList.add("hidden");
        mobileMenuCloseIcon.classList.remove("hidden");

        // Prevent Body Scroll
        document.body.style.overflow = "hidden";
      }

      function closeMenu() {
        // Hide Menu
        mobileMenu.classList.add("translate-x-full");
        mobileMenu.classList.remove("menu-open"); // NEW: Remove class

        // Hide Overlay
        mobileMenuOverlay.classList.add("opacity-0", "invisible");

        // Toggle Icons
        mobileMenuOpenIcon.classList.remove("hidden");
        mobileMenuCloseIcon.classList.add("hidden");

        // Restore Body Scroll
        document.body.style.overflow = "";
      }

      // NEW: Mobile Menu Event Listeners
      mobileMenuBtn.addEventListener("click", openMenu);
      mobileMenuCloseBtn.addEventListener("click", closeMenu);
      mobileMenuOverlay.addEventListener("click", closeMenu);

      // --- Helper Functions (Reused) ---
      function formatRelativeTime(date) {
        if (date.toDate) {
          date = date.toDate();
        }
        const now = new Date();
        const seconds = Math.floor((now - date) / 1000);

        // Handle "just now" for very recent posts
        if (seconds < 5) return "just now";

        let interval = seconds / 31536000;
        if (interval >= 1) {
          // MODIFIED: > 1 to >= 1
          const count = Math.floor(interval);
          return count === 1 ? "1 year ago" : `${count} years ago`; // MODIFIED: Added singular check
        }
        interval = seconds / 2592000;
        if (interval >= 1) {
          // MODIFIED: > 1 to >= 1
          const count = Math.floor(interval);
          return count === 1 ? "1 month ago" : `${count} months ago`; // MODIFIED: Added singular check
        }
        interval = seconds / 86400;
        if (interval >= 1) {
          // MODIFIED: > 1 to >= 1
          const count = Math.floor(interval);
          return count === 1 ? "1 day ago" : `${count} days ago`; // MODIFIED: Added singular check
        }
        interval = seconds / 3600;
        if (interval >= 1) {
          // MODIFIED: > 1 to >= 1
          const count = Math.floor(interval);
          return count === 1 ? "1 hour ago" : `${count} hours ago`; // MODIFIED: Added singular check
        }
        interval = seconds / 60;
        if (interval >= 1) {
          // MODIFIED: > 1 to >= 1
          const count = Math.floor(interval);
          return count === 1 ? "1 minute ago" : `${count} minutes ago`; // MODIFIED: Added singular check
        }
        // MODIFIED: Handle singular 'second'
        const count = Math.floor(seconds);
        return count === 1 ? "1 second ago" : `${count} seconds ago`;
      }

      /**
       * Creates HTML for a card in the Top Stories grid.
       * We reuse this for the category page grid.
       */
      function createTopStoryCardHTML(article) {
        // We'll make the category link click-through, but since we are
        // already on a category page, we can just display it.
        // Or, we could link to a new search page, but for now, just text.
        const timeAgo = article.publishedAt
          ? formatRelativeTime(article.publishedAt)
          : "Just now";
        // --- UPDATE: Changed href from # to article.html ---
        const articleLink = `./article.html?id=${article.id}`;
        // --- MODIFICATION START: Replicating home.html card structure ---
        return `
                <a href="${articleLink}" class="block group bg-slate-900 rounded-lg overflow-hidden border border-slate-800 transition-all duration-300 shadow-lg shadow-slate-950/50 hover:border-cyan-600 hover:shadow-2xl hover:shadow-cyan-800/20 flex flex-col">
                    <img src="${article.imageUrl}" alt="${article.title}" 
                         onerror="this.src='https://source.unsplash.com/800x500/?news,story';"
                         class="w-full h-48 object-cover">
                    <div class="p-6 flex flex-col flex-grow">
                        <div class="flex-grow">
                            <span class="text-gradient text-xs font-bold uppercase tracking-wider">${
                              article.category
                            }</span>
                            <h3 class="text-xl font-bold text-white mt-2 group-hover:text-cyan-300 transition-colors text-ellipsis-lines-2">
                                ${article.title}
                            </h3>
                            <!-- NEW: Added summary with 2-line ellipsis -->
                            <p class="text-sm text-gray-400 mt-2 text-ellipsis-lines-2">${
                              article.summary || ""
                            }</p>
                        </div>
                        <span class="text-xs font-medium text-gray-400 mt-4">${timeAgo}</span>
                    </div>
                </a>
            `;
        // --- MODIFICATION END ---
      }

      /**
       * Renders all articles to the grid.
       */
      function renderArticles(articles) {
        articlesGrid.innerHTML = ""; // Clear existing

        if (articles.length === 0) {
          noArticlesMessage.classList.remove("hidden");
          return;
        }

        noArticlesMessage.classList.add("hidden");
        articles.forEach((article) => {
          articlesGrid.innerHTML += createTopStoryCardHTML(article);
        });

        loadingOverlay.style.display = "none";
      }

      /**
       * Gets category from URL and sanitizes it.
       */
      function getCategoryFromURL() {
        const params = new URLSearchParams(window.location.search);
        const category = params.get("category");
        if (!category) return null;
        // Basic sanitization: allow only alphanumeric characters
        return category.replace(/[^a-zA-Z0-9]/g, "");
      }

      // --- Main App Initialization ---
      async function initApp() {
        console.log("Initializing Category Page...");

        // Render icons
        lucide.createIcons();

        const categoryName = getCategoryFromURL();

        if (!categoryName) {
          categoryTitle.innerText = "Category Not Found";
          loadingText.innerText = "Invalid category. Redirecting...";
          // Redirect back to home after 2 seconds
          setTimeout(() => {
            window.location.href = "./home.html";
          }, 2000);
          return;
        }

        // Set title dynamically
        categoryTitle.innerText = categoryName;
        document.title = `${categoryName} | The Daily Origin`;
        loadingText.innerText = `Loading ${categoryName} feed...`;

        try {
          // Initialize Firebase
          app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          // Sign in anonymously to read data (if rules require it,
          // but our current rules allow public read)
          // --- REMOVING THIS LINE TO FIX AUTH ERROR ---
          // await signInAnonymously(auth);
          // console.log("Signed in anonymously for data access.");

          // 2. Set up real-time listener for articles IN THIS CATEGORY
          const articlesCollectionPath = `artifacts/${appId}/public/data/articles`;

          // --- THIS IS THE KEY ---
          // We create a query that filters by the category name
          const q = query(
            collection(db, articlesCollectionPath),
            where("category", "==", categoryName)
          );

          console.log(
            `Listening for changes at: ${articlesCollectionPath} where category == ${categoryName}`
          );

          onSnapshot(
            q,
            (snapshot) => {
              console.log("Received data snapshot for category.");
              const articles = [];
              snapshot.forEach((doc) => {
                articles.push({ id: doc.id, ...doc.data() });
              });

              // Sort by date (newest first)
              articles.sort((a, b) => {
                const dateA = a.publishedAt?.toDate
                  ? a.publishedAt.toDate()
                  : new Date(0);
                const dateB = b.publishedAt?.toDate
                  ? b.publishedAt.toDate()
                  : new Date(0);
                return dateB - dateA;
              });

              // Render all articles to the DOM
              renderArticles(articles);
            },
            (error) => {
              console.error("Error with Firestore snapshot: ", error);
              loadingOverlay.innerHTML = `<p class="text-red-500">Error: Could not load news feed. (Check Firestore Rules)</p>`;
            }
          );
        } catch (error) {
          console.error("Error initializing Firebase:", error);
          loadingOverlay.innerHTML =
            '<p class="text-red-500">Fatal Error: Could not initialize application.</p>';
        }
      }

      // Start the application on window load
      window.onload = initApp;
    </script>
  </body>
</html>
