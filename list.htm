<!DOCTYPE html>
<html lang="bn">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ভিলেজ ম্যানেজমেন্ট সিস্টেম</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Font (Noto Sans Bengali) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* Apply Bengali font */
      body {
        font-family: "Noto Sans Bengali", system-ui, -apple-system,
          BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial,
          "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
          "Segoe UI Symbol", "Noto Color Emoji";
      }
      /* Custom scrollbar */
      .modal-body::-webkit-scrollbar {
        width: 6px;
      }
      .modal-body::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .modal-body::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
      }
      .modal-body::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      /* Modal transitions */
      .modal {
        transition: opacity 0.25s ease, visibility 0.25s ease;
      }
      .modal-content {
        transition: transform 0.25s ease;
      }

      /* Sidebar active state */
      .sidebar-link.active {
        background-color: #1d4ed8; /* bg-blue-700 */
        color: white;
        font-weight: 600;
      }
      /* Hide scrollbar for main layout */
      html,
      body {
        overflow: hidden;
        height: 100vh;
      }
      #main-content {
        height: 100vh;
        overflow-y: auto;
      }
      #sidebar {
        height: 100vh;
        overflow-y: auto;
        transition: transform 0.3s ease-in-out;
      }

      /* Global Loader */
      .loader-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9998;
        transition: opacity 0.3s ease, visibility 0.3s ease;
      }
      .loader {
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Helper class for hidden */
      .hidden-transition {
        visibility: hidden;
        opacity: 0;
      }

      /* Population Table Sort */
      .sortable-th {
        cursor: pointer;
        user-select: none;
      }
      .sortable-th:hover {
        background-color: #e5e7eb;
      }
      .sortable-th .sort-arrow {
        display: inline-block;
        opacity: 0.3;
        transition: opacity 0.2s;
      }
      .sortable-th.sort-asc .sort-arrow.arrow-up,
      .sortable-th.sort-desc .sort-arrow.arrow-down {
        opacity: 1;
      }

      /* Dashboard Progress Bars */
      .progress-bar {
        transition: width 1s ease-in-out;
      }

      /* Filter Transitions */
      .filter-panel {
        transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
        max-height: 0;
        overflow: hidden;
        opacity: 0;
      }
      .filter-panel.open {
        max-height: 500px; /* Arbitrary large height */
        opacity: 1;
      }

      /* Volunteer Icons */
      .vol-icon-blood {
        color: #ef4444;
      }
      .vol-icon-money {
        color: #16a34a;
      }
      .vol-icon-edu {
        color: #2563eb;
      }
      .vol-icon-health {
        color: #0891b2;
      }
      .vol-icon-social {
        color: #d97706;
      }

      /* Notice Card Styles */
      .notice-card {
        transition: all 0.3s ease;
        border-left: 5px solid #f59e0b; /* yellow-500 */
      }
      .notice-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      .notice-pin {
        position: absolute;
        top: -10px;
        right: 20px;
        color: #ef4444;
        filter: drop-shadow(1px 2px 2px rgba(0, 0, 0, 0.2));
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <!-- Global Loader -->
    <div id="global-loader" class="loader-overlay hidden-transition">
      <div class="loader"></div>
    </div>

    <!-- Auth Container (Login/Signup) -->
    <div
      id="auth-container"
      class="min-h-screen flex items-center justify-center p-4"
    >
      <div class="max-w-md w-full bg-white rounded-lg shadow-xl p-8">
        <h1 class="text-3xl font-bold text-center text-blue-600 mb-4">
          ভিলেজ ম্যানেজমেন্ট সিস্টেম
        </h1>

        <!-- Tab Buttons -->
        <div class="flex border-b border-gray-200 mb-6">
          <button
            id="show-login-tab"
            class="flex-1 py-2 text-center font-medium text-blue-600 border-b-2 border-blue-600"
          >
            লগইন
          </button>
          <button
            id="show-signup-tab"
            class="flex-1 py-2 text-center font-medium text-gray-500"
          >
            সাইন আপ
          </button>
        </div>

        <!-- Error Message Display -->
        <div
          id="auth-error"
          class="hidden text-red-600 bg-red-100 border border-red-400 rounded-md p-3 mb-4 text-sm"
        ></div>

        <!-- Login Form -->
        <form id="login-form">
          <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">
            লগইন করুন
          </h2>
          <div class="mb-4">
            <label
              for="login-email"
              class="block text-sm font-medium text-gray-700 mb-1"
              >ইমেইল</label
            >
            <input
              type="email"
              id="login-email"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="your@email.com"
            />
          </div>
          <div class="mb-4">
            <label
              for="login-password"
              class="block text-sm font-medium text-gray-700 mb-1"
              >পাসওয়ার্ড</label
            >
            <input
              type="password"
              id="login-password"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="••••••••"
            />
          </div>
          <div class="text-right mb-6">
            <a
              href="#"
              id="forgot-password-link"
              class="text-sm font-medium text-blue-600 hover:underline"
              >পাসওয়ার্ড ভুলে গেছেন?</a
            >
          </div>
          <button
            type="submit"
            class="w-full bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200"
          >
            লগইন
          </button>
        </form>

        <!-- Signup Form (Hidden by default) -->
        <form id="signup-form" class="hidden">
          <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">
            নতুন একাউন্ট খুলুন
          </h2>
          <div class="mb-4">
            <label
              for="signup-email"
              class="block text-sm font-medium text-gray-700 mb-1"
              >ইমেইল</label
            >
            <input
              type="email"
              id="signup-email"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="your@email.com"
            />
          </div>
          <div class="mb-6">
            <label
              for="signup-password"
              class="block text-sm font-medium text-gray-700 mb-1"
              >পাসওয়ার্ড (কমপক্ষে ৬ অক্ষর)</label
            >
            <input
              type="password"
              id="signup-password"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="••••••••"
            />
          </div>
          <button
            type="submit"
            class="w-full bg-green-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition duration-200"
          >
            সাইন আপ
          </button>
        </form>
      </div>
    </div>

    <!-- App Container (Hidden by default) -->
    <div id="app-container" class="hidden flex h-screen">
      <!-- Sidebar -->
      <aside
        id="sidebar"
        class="w-64 bg-blue-900 text-blue-100 flex flex-col fixed inset-y-0 left-0 z-20 transform -translate-x-full md:translate-x-0"
      >
        <!-- Sidebar Header -->
        <div class="p-4 flex items-center justify-between">
          <h1 class="text-2xl font-bold text-white">ম্যানেজমেন্ট</h1>
          <button
            id="close-sidebar-btn"
            class="md:hidden text-blue-200 hover:text-white"
          >
            <i data-lucide="x" class="w-6 h-6"></i>
          </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-2 py-4 space-y-2">
          <a
            href="#"
            class="sidebar-link active flex items-center px-4 py-2.5 rounded-lg hover:bg-blue-700"
            data-page="page-dashboard"
          >
            <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
            ড্যাশবোর্ড
          </a>
          <a
            href="#"
            class="sidebar-link flex items-center px-4 py-2.5 rounded-lg hover:bg-blue-700"
            data-page="page-volunteers"
          >
            <i data-lucide="hand-heart" class="w-5 h-5 mr-3 text-red-300"></i>
            স্বেচ্ছাসেবী
          </a>
          <a
            href="#"
            class="sidebar-link flex items-center px-4 py-2.5 rounded-lg hover:bg-blue-700"
            data-page="page-bongshos"
          >
            <i data-lucide="shell" class="w-5 h-5 mr-3"></i>
            বংশ তালিকা
          </a>
          <a
            href="#"
            class="sidebar-link flex items-center px-4 py-2.5 rounded-lg hover:bg-blue-700"
            data-page="page-households"
          >
            <i data-lucide="home" class="w-5 h-5 mr-3"></i>
            হোল্ডিং তালিকা
          </a>
          <a
            href="#"
            class="sidebar-link flex items-center px-4 py-2.5 rounded-lg hover:bg-blue-700"
            data-page="page-population"
          >
            <i data-lucide="users" class="w-5 h-5 mr-3"></i>
            জনগণ
          </a>
          <a
            href="#"
            class="sidebar-link flex items-center px-4 py-2.5 rounded-lg hover:bg-blue-700"
            data-page="page-notices"
          >
            <i data-lucide="bell" class="w-5 h-5 mr-3"></i>
            নোটিশ বোর্ড
          </a>
          <a
            href="#"
            class="sidebar-link flex items-center px-4 py-2.5 rounded-lg hover:bg-blue-700"
            data-page="page-admin"
          >
            <i data-lucide="settings" class="w-5 h-5 mr-3"></i>
            প্রশাসন
          </a>
        </nav>

        <!-- Sidebar Footer -->
        <div class="p-4 border-t border-blue-800">
          <p id="user-email-display" class="text-sm text-blue-200 truncate"></p>
          <button
            id="logout-button"
            class="w-full mt-3 bg-red-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-red-700 transition duration-200 flex items-center justify-center"
          >
            <i data-lucide="log-out" class="w-5 h-5 mr-2"></i>
            লগআউট
          </button>
        </div>
      </aside>

      <!-- Main Content -->
      <main id="main-content" class="flex-1 md:ml-64">
        <!-- Top bar for mobile -->
        <header
          class="md:hidden bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10"
        >
          <h1 class="text-xl font-bold text-blue-800">ভিলেজ ম্যানেজমেন্ট</h1>
          <button
            id="open-sidebar-btn"
            class="text-gray-600 hover:text-gray-900"
          >
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
        </header>

        <div class="p-6 md:p-10">
          <!-- Page: Dashboard (UPDATED) -->
          <div id="page-dashboard" class="page-content">
            <!-- Header & Welcome -->
            <div
              class="mb-8 flex flex-col md:flex-row justify-between items-center"
            >
              <div>
                <h2 class="text-3xl font-bold text-gray-800">ড্যাশবোর্ড</h2>
                <p class="text-gray-600 mt-1">
                  আজকের তারিখ:
                  <span
                    id="dashboard-current-date"
                    class="font-medium text-blue-600"
                    >...</span
                  >
                </p>
              </div>
              <!-- Quick Search Widget -->
              <div class="w-full md:w-1/3 mt-4 md:mt-0">
                <div class="relative">
                  <input
                    type="text"
                    id="dashboard-quick-search"
                    class="w-full p-3 pl-10 border border-gray-300 rounded-full shadow-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    placeholder="হোল্ডিং বা ব্যক্তি খুঁজুন..."
                    onkeyup="handleDashboardSearch(this.value)"
                  />
                  <i
                    data-lucide="search"
                    class="w-5 h-5 text-gray-400 absolute left-3 top-3.5"
                  ></i>
                </div>
              </div>
            </div>

            <!-- Stats Cards Row -->
            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
            >
              <div
                class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-lg shadow-lg cursor-pointer hover:shadow-xl transition-transform transform hover:-translate-y-1"
                onclick="showPage('page-households');"
              >
                <div class="flex justify-between items-center">
                  <div>
                    <h4
                      class="text-blue-100 font-medium text-sm uppercase tracking-wider"
                    >
                      মোট হোল্ডিং
                    </h4>
                    <p
                      id="stat-total-households"
                      class="text-4xl font-bold mt-2"
                    >
                      ...
                    </p>
                  </div>
                  <i
                    data-lucide="home"
                    class="w-10 h-10 text-blue-200 opacity-50"
                  ></i>
                </div>
              </div>

              <div
                class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-lg shadow-lg cursor-pointer hover:shadow-xl transition-transform transform hover:-translate-y-1"
                onclick="showPage('page-population');"
              >
                <div class="flex justify-between items-center">
                  <div>
                    <h4
                      class="text-green-100 font-medium text-sm uppercase tracking-wider"
                    >
                      মোট জনগণ
                    </h4>
                    <p
                      id="stat-total-population"
                      class="text-4xl font-bold mt-2"
                    >
                      ...
                    </p>
                  </div>
                  <i
                    data-lucide="users"
                    class="w-10 h-10 text-green-200 opacity-50"
                  ></i>
                </div>
              </div>

              <div
                class="bg-gradient-to-br from-red-500 to-red-600 text-white p-6 rounded-lg shadow-lg cursor-pointer hover:shadow-xl transition-transform transform hover:-translate-y-1"
                onclick="showPage('page-volunteers');"
              >
                <div class="flex justify-between items-center">
                  <div>
                    <h4
                      class="text-red-100 font-medium text-sm uppercase tracking-wider"
                    >
                      স্বেচ্ছাসেবী
                    </h4>
                    <p
                      id="stat-total-volunteers"
                      class="text-4xl font-bold mt-2"
                    >
                      ...
                    </p>
                  </div>
                  <i
                    data-lucide="hand-heart"
                    class="w-10 h-10 text-red-200 opacity-50"
                  ></i>
                </div>
              </div>

              <div
                class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-lg shadow-lg cursor-pointer hover:shadow-xl transition-transform transform hover:-translate-y-1"
                onclick="showPage('page-bongshos');"
              >
                <div class="flex justify-between items-center">
                  <div>
                    <h4
                      class="text-purple-100 font-medium text-sm uppercase tracking-wider"
                    >
                      মোট বংশ
                    </h4>
                    <p id="stat-total-bongshos" class="text-4xl font-bold mt-2">
                      ...
                    </p>
                  </div>
                  <i
                    data-lucide="sitemap"
                    class="w-10 h-10 text-purple-200 opacity-50"
                  ></i>
                </div>
              </div>

              <div
                class="bg-gradient-to-br from-yellow-500 to-yellow-600 text-white p-6 rounded-lg shadow-lg cursor-pointer hover:shadow-xl transition-transform transform hover:-translate-y-1"
                onclick="showPage('page-notices');"
              >
                <div class="flex justify-between items-center">
                  <div>
                    <h4
                      class="text-yellow-100 font-medium text-sm uppercase tracking-wider"
                    >
                      নোটিশ
                    </h4>
                    <p id="stat-total-notices" class="text-4xl font-bold mt-2">
                      ...
                    </p>
                  </div>
                  <i
                    data-lucide="bell"
                    class="w-10 h-10 text-yellow-200 opacity-50"
                  ></i>
                </div>
              </div>
            </div>

            <!-- Content Grid -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
              <!-- Left Column: Analytics & Admin -->
              <div class="space-y-8">
                <!-- Admin Summary Card -->
                <div
                  class="bg-white rounded-lg shadow-md p-6 border-t-4 border-blue-500"
                >
                  <h3
                    class="text-lg font-bold text-gray-800 mb-4 flex items-center"
                  >
                    <i
                      data-lucide="phone-call"
                      class="w-5 h-5 mr-2 text-blue-600"
                    ></i>
                    প্রশাসনিক যোগাযোগ
                  </h3>
                  <div class="space-y-3">
                    <div
                      class="flex justify-between items-center pb-2 border-b border-gray-100"
                    >
                      <span class="text-gray-500 text-sm">চেয়ারম্যান</span>
                      <div class="text-right">
                        <p
                          id="dash-admin-chairman"
                          class="font-semibold text-gray-800"
                        >
                          --
                        </p>
                        <a
                          href="#"
                          id="dash-admin-chairman-call"
                          class="text-xs text-blue-500 hover:underline"
                          >--</a
                        >
                      </div>
                    </div>
                    <div
                      class="flex justify-between items-center pb-2 border-b border-gray-100"
                    >
                      <span class="text-gray-500 text-sm">মেম্বার</span>
                      <div class="text-right">
                        <p
                          id="dash-admin-member"
                          class="font-semibold text-gray-800"
                        >
                          --
                        </p>
                        <a
                          href="#"
                          id="dash-admin-member-call"
                          class="text-xs text-blue-500 hover:underline"
                          >--</a
                        >
                      </div>
                    </div>
                    <div class="flex justify-between items-center">
                      <span class="text-gray-500 text-sm">গ্রাম পুলিশ</span>
                      <div class="text-right">
                        <p
                          id="dash-admin-police"
                          class="font-semibold text-gray-800"
                        >
                          --
                        </p>
                        <a
                          href="#"
                          id="dash-admin-police-call"
                          class="text-xs text-blue-500 hover:underline"
                          >--</a
                        >
                      </div>
                    </div>
                  </div>
                  <button
                    onclick="showPage('page-admin')"
                    class="w-full mt-4 text-center text-sm text-blue-600 hover:bg-blue-50 py-2 rounded"
                  >
                    বিস্তারিত দেখুন &rarr;
                  </button>
                </div>

                <!-- Age Demographics Card -->
                <div class="bg-white rounded-lg shadow-md p-6">
                  <h3
                    class="text-lg font-bold text-gray-800 mb-4 flex items-center"
                  >
                    <i
                      data-lucide="bar-chart-2"
                      class="w-5 h-5 mr-2 text-green-600"
                    ></i>
                    বয়স ভিত্তিক তথ্য
                  </h3>
                  <div class="space-y-4">
                    <div>
                      <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">শিশু (০-১৭)</span>
                        <span
                          class="font-bold text-gray-800"
                          id="age-stat-child"
                          >0</span
                        >
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-2">
                        <div
                          id="bar-child"
                          class="bg-green-400 h-2 rounded-full progress-bar"
                          style="width: 0%;"
                        ></div>
                      </div>
                    </div>
                    <div>
                      <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">প্রাপ্তবয়স্ক (১৮-৫৯)</span>
                        <span
                          class="font-bold text-gray-800"
                          id="age-stat-adult"
                          >0</span
                        >
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-2">
                        <div
                          id="bar-adult"
                          class="bg-blue-500 h-2 rounded-full progress-bar"
                          style="width: 0%;"
                        ></div>
                      </div>
                    </div>
                    <div>
                      <div class="flex justify-between text-sm mb-1">
                        <span class="text-gray-600">প্রবীণ (৬০+)</span>
                        <span
                          class="font-bold text-gray-800"
                          id="age-stat-senior"
                          >0</span
                        >
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-2">
                        <div
                          id="bar-senior"
                          class="bg-purple-500 h-2 rounded-full progress-bar"
                          style="width: 0%;"
                        ></div>
                      </div>
                    </div>
                    <p class="text-xs text-gray-400 text-center mt-2">
                      * যাদের জন্ম তারিখ দেয়া আছে তাদের ভিত্তিতে
                    </p>
                  </div>
                </div>
              </div>

              <!-- Center & Right Column (Merged for mobile/tablet): Quick Actions & Lists -->
              <div class="lg:col-span-2 space-y-8">
                <!-- Quick Action Buttons -->
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                  <button
                    class="flex flex-col items-center justify-center p-4 bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-blue-50 hover:border-blue-300 transition-all group"
                    onclick="showPage('page-households'); document.getElementById('add-household-btn').click();"
                  >
                    <div
                      class="bg-blue-100 p-3 rounded-full text-blue-600 mb-2 group-hover:bg-blue-600 group-hover:text-white transition-colors"
                    >
                      <i data-lucide="plus" class="w-6 h-6"></i>
                    </div>
                    <span
                      class="font-medium text-gray-700 group-hover:text-blue-700"
                      >হোল্ডিং যোগ</span
                    >
                  </button>

                  <button
                    class="flex flex-col items-center justify-center p-4 bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-purple-50 hover:border-purple-300 transition-all group"
                    onclick="showPage('page-bongshos'); document.getElementById('add-bongsho-btn').click();"
                  >
                    <div
                      class="bg-purple-100 p-3 rounded-full text-purple-600 mb-2 group-hover:bg-purple-600 group-hover:text-white transition-colors"
                    >
                      <i data-lucide="plus" class="w-6 h-6"></i>
                    </div>
                    <span
                      class="font-medium text-gray-700 group-hover:text-purple-700"
                      >বংশ যোগ</span
                    >
                  </button>

                  <button
                    class="flex flex-col items-center justify-center p-4 bg-white rounded-lg shadow-sm border border-gray-200 hover:bg-yellow-50 hover:border-yellow-300 transition-all group"
                    onclick="showPage('page-notices'); document.getElementById('add-notice-btn').click();"
                  >
                    <div
                      class="bg-yellow-100 p-3 rounded-full text-yellow-600 mb-2 group-hover:bg-yellow-600 group-hover:text-white transition-colors"
                    >
                      <i data-lucide="plus" class="w-6 h-6"></i>
                    </div>
                    <span
                      class="font-medium text-gray-700 group-hover:text-yellow-700"
                      >নোটিশ দিন</span
                    >
                  </button>
                </div>

                <!-- Recent Activity Log -->
                <div class="bg-white rounded-lg shadow-md overflow-hidden">
                  <div
                    class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50"
                  >
                    <h3 class="text-lg font-bold text-gray-800">
                      সম্প্রতিক কার্যক্রম
                    </h3>
                    <span
                      class="text-xs font-medium text-gray-500 bg-gray-200 px-2 py-1 rounded"
                      >সর্বশেষ ৫টি হোল্ডিং</span
                    >
                  </div>
                  <div
                    id="dashboard-recent-activity"
                    class="divide-y divide-gray-100"
                  >
                    <p class="p-6 text-center text-gray-500">লোড হচ্ছে...</p>
                    <!-- Activity Items Injected Here -->
                  </div>
                </div>

                <!-- Recent Notices -->
                <div>
                  <h3 class="text-lg font-bold text-gray-800 mb-4">
                    সাম্প্রতিক নোটিশ
                  </h3>
                  <div id="dashboard-recent-notices" class="space-y-3">
                    <p id="dashboard-notices-loading" class="text-gray-500">
                      লোড হচ্ছে...
                    </p>
                    <!-- Recent notices will be injected here -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Page: Volunteers -->
          <div id="page-volunteers" class="page-content hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
            >
              <h2 class="text-3xl font-bold text-gray-800 flex items-center">
                <i
                  data-lucide="hand-heart"
                  class="w-8 h-8 mr-2 text-red-600"
                ></i>
                স্বেচ্ছাসেবী ও সেবা
              </h2>
            </div>

            <!-- Volunteer Filter -->
            <div
              class="mb-6 bg-white p-4 rounded-lg shadow-sm border border-gray-200"
            >
              <h3 class="text-lg font-semibold text-gray-700 mb-3">
                সেবার ধরন খুঁজুন:
              </h3>
              <div
                class="flex flex-wrap gap-4 items-center"
                id="volunteer-filters"
              >
                <div class="flex flex-wrap gap-2">
                  <button
                    onclick="filterVolunteers('all')"
                    class="px-4 py-2 rounded-full border border-gray-300 bg-blue-600 text-white hover:bg-blue-700 transition shadow-sm active-vol-filter"
                    data-type="all"
                  >
                    সব
                  </button>
                  <button
                    onclick="filterVolunteers('blood')"
                    class="px-4 py-2 rounded-full border border-red-200 bg-white text-red-600 hover:bg-red-50 transition shadow-sm flex items-center gap-2"
                    data-type="blood"
                  >
                    <i data-lucide="droplet" class="w-4 h-4"></i>রক্তদান
                  </button>
                  <button
                    onclick="filterVolunteers('money')"
                    class="px-4 py-2 rounded-full border border-green-200 bg-white text-green-600 hover:bg-green-50 transition shadow-sm flex items-center gap-2"
                    data-type="money"
                  >
                    <i data-lucide="banknote" class="w-4 h-4"></i>আর্থিক
                  </button>
                  <button
                    onclick="filterVolunteers('education')"
                    class="px-4 py-2 rounded-full border border-blue-200 bg-white text-blue-600 hover:bg-blue-50 transition shadow-sm flex items-center gap-2"
                    data-type="education"
                  >
                    <i data-lucide="book-open" class="w-4 h-4"></i>শিক্ষা
                  </button>
                  <button
                    onclick="filterVolunteers('health')"
                    class="px-4 py-2 rounded-full border border-cyan-200 bg-white text-cyan-600 hover:bg-cyan-50 transition shadow-sm flex items-center gap-2"
                    data-type="health"
                  >
                    <i data-lucide="stethoscope" class="w-4 h-4"></i>চিকিৎসা
                  </button>
                  <button
                    onclick="filterVolunteers('social')"
                    class="px-4 py-2 rounded-full border border-orange-200 bg-white text-orange-600 hover:bg-orange-50 transition shadow-sm flex items-center gap-2"
                    data-type="social"
                  >
                    <i data-lucide="users" class="w-4 h-4"></i>সামাজিক
                  </button>
                </div>

                <!-- Blood Group Filter (Secondary) -->
                <select
                  id="filter-vol-blood-group"
                  class="p-2 border rounded-md ml-auto text-sm text-gray-700"
                  onchange="applyVolunteerFilters()"
                >
                  <option value="">সব রক্তের গ্রুপ</option>
                  <option value="A+">A+</option>
                  <option value="A-">A-</option>
                  <option value="B+">B+</option>
                  <option value="B-">B-</option>
                  <option value="O+">O+</option>
                  <option value="O-">O-</option>
                  <option value="AB+">AB+</option>
                  <option value="AB-">AB-</option>
                </select>
              </div>
            </div>

            <!-- Volunteers Grid -->
            <div
              id="volunteer-grid"
              class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-6 min-h-[200px]"
            >
              <p class="col-span-full text-center text-gray-500 py-8">
                স্বেচ্ছাসেবী লোড হচ্ছে...
              </p>
              <!-- Cards will be injected here -->
            </div>

            <!-- Pagination Volunteer -->
            <div
              class="flex flex-col md:flex-row justify-between items-center mt-6 text-sm text-gray-600 bg-white p-4 rounded-lg shadow-sm border"
            >
              <div id="pagination-info-volunteers">
                Showing 0 to 0 of 0 entries
              </div>
              <div class="flex gap-2 mt-2 md:mt-0 items-center">
                <span class="hidden md:inline mr-2">Rows per page:</span>
                <select
                  id="rows-per-page-volunteers"
                  class="border rounded p-1"
                  onchange="changeRowsPerPage('volunteers', this.value)"
                >
                  <option value="12" selected>12</option>
                  <option value="24">24</option>
                  <option value="48">48</option>
                </select>
                <div class="flex gap-1 ml-2">
                  <button
                    id="prev-btn-volunteers"
                    class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    onclick="changePage('volunteers', -1)"
                  >
                    Prev
                  </button>
                  <span
                    id="page-display-volunteers"
                    class="px-3 py-1 font-medium"
                    >1</span
                  >
                  <button
                    id="next-btn-volunteers"
                    class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    onclick="changePage('volunteers', 1)"
                  >
                    Next
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Page: Bongshos -->
          <div id="page-bongshos" class="page-content hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
            >
              <h2 class="text-3xl font-bold text-gray-800">বংশ তালিকা</h2>
              <button
                id="add-bongsho-btn"
                class="w-full md:w-auto bg-purple-600 text-white py-2 px-5 rounded-lg font-medium hover:bg-purple-700 flex items-center justify-center gap-2"
              >
                <i data-lucide="plus" class="w-5 h-5"></i>
                নতুন বংশ যোগ করুন
              </button>
            </div>
            <div class="mb-4">
              <input
                type="text"
                id="bongsho-search"
                class="w-full p-3 border border-gray-300 rounded-lg"
                placeholder="বংশের নাম বা বিবরণ দিয়ে খুঁজুন..."
              />
            </div>
            <div class="bg-white rounded-lg shadow-lg overflow-x-auto">
              <table class="w-full min-w-max">
                <thead class="bg-gray-100">
                  <tr>
                    <th
                      class="p-4 text-left text-sm font-semibold text-gray-600"
                    >
                      বংশের নাম
                    </th>
                    <th
                      class="p-4 text-left text-sm font-semibold text-gray-600"
                    >
                      বিবরণ
                    </th>
                    <th
                      class="p-4 text-left text-sm font-semibold text-gray-600"
                    >
                      হোল্ডিং সংখ্যা
                    </th>
                    <th
                      class="p-4 text-right text-sm font-semibold text-gray-600"
                    >
                      পদক্ষেপ
                    </th>
                  </tr>
                </thead>
                <tbody id="bongsho-list">
                  <tr id="bongsho-list-loading">
                    <td colspan="4" class="p-4 text-center text-gray-500">
                      বংশ তালিকা লোড হচ্ছে...
                    </td>
                  </tr>
                  <!-- Bongsho rows will be injected here -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Page: Households -->
          <div id="page-households" class="page-content hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
            >
              <h2 class="text-3xl font-bold text-gray-800">হোল্ডিং তালিকা</h2>
              <button
                id="add-household-btn"
                class="w-full md:w-auto bg-blue-600 text-white py-2 px-5 rounded-lg font-medium hover:bg-blue-700 flex items-center justify-center gap-2"
              >
                <i data-lucide="plus" class="w-5 h-5"></i>
                নতুন হোল্ডিং যোগ করুন
              </button>
            </div>

            <!-- Advanced Filter Section -->
            <div
              class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100"
            >
              <div
                class="flex justify-between items-center cursor-pointer"
                onclick="toggleFilter('household-filter-panel')"
              >
                <h3 class="font-semibold text-gray-700 flex items-center">
                  <i
                    data-lucide="filter"
                    class="w-4 h-4 mr-2 text-blue-600"
                  ></i>
                  উন্নত ফিল্টার (Advanced Filter)
                </h3>
                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
              </div>
              <div
                id="household-filter-panel"
                class="filter-panel grid grid-cols-1 md:grid-cols-3 gap-4 mt-4"
              >
                <input
                  type="text"
                  id="filter-household-search"
                  class="w-full p-2 border rounded-md"
                  placeholder="নাম, হোল্ডিং বা মোবাইল..."
                />
                <select
                  id="filter-household-bongsho"
                  class="w-full p-2 border rounded-md"
                >
                  <option value="">-- সব বংশ --</option>
                </select>
                <select
                  id="filter-household-village"
                  class="w-full p-2 border rounded-md"
                >
                  <option value="">-- সব গ্রাম/পাড়া --</option>
                </select>
                <div class="md:col-span-3 flex justify-end gap-2">
                  <button
                    onclick="resetHouseholdFilters()"
                    class="px-4 py-2 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200"
                  >
                    রিসেট
                  </button>
                  <button
                    onclick="applyHouseholdFilters()"
                    class="px-4 py-2 text-sm text-white bg-blue-600 rounded hover:bg-blue-700"
                  >
                    ফিল্টার করুন
                  </button>
                </div>
              </div>
            </div>

            <div id="household-list" class="space-y-4 min-h-[200px]">
              <p
                id="household-list-loading"
                class="text-center text-gray-500 py-4"
              >
                তালিকা লোড হচ্ছে...
              </p>
              <!-- Household cards will be injected here -->
            </div>

            <!-- Pagination -->
            <div
              class="flex flex-col md:flex-row justify-between items-center mt-6 text-sm text-gray-600 bg-white p-4 rounded-lg shadow-sm border"
            >
              <div id="pagination-info-household">
                Showing 0 to 0 of 0 entries
              </div>
              <div class="flex gap-2 mt-2 md:mt-0 items-center">
                <span class="hidden md:inline mr-2">Rows per page:</span>
                <select
                  id="rows-per-page-household"
                  class="border rounded p-1"
                  onchange="changeRowsPerPage('households', this.value)"
                >
                  <option value="5">5</option>
                  <option value="10" selected>10</option>
                  <option value="20">20</option>
                  <option value="50">50</option>
                </select>
                <div class="flex gap-1 ml-2">
                  <button
                    id="prev-btn-household"
                    class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    onclick="changePage('households', -1)"
                  >
                    Prev
                  </button>
                  <span
                    id="page-display-household"
                    class="px-3 py-1 font-medium"
                    >1</span
                  >
                  <button
                    id="next-btn-household"
                    class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    onclick="changePage('households', 1)"
                  >
                    Next
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Page: Population -->
          <div id="page-population" class="page-content hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
            >
              <h2 class="text-3xl font-bold text-gray-800">
                সকল জনগণের তালিকা
              </h2>
              <button
                id="export-csv-btn"
                class="w-full md:w-auto bg-green-600 text-white py-2 px-5 rounded-lg font-medium hover:bg-green-700 flex items-center justify-center gap-2"
              >
                <i data-lucide="download" class="w-5 h-5"></i>
                CSV এক্সপোর্ট করুন
              </button>
            </div>

            <!-- Advanced Filter Section Population -->
            <div
              class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100"
            >
              <div
                class="flex justify-between items-center cursor-pointer"
                onclick="toggleFilter('population-filter-panel')"
              >
                <h3 class="font-semibold text-gray-700 flex items-center">
                  <i
                    data-lucide="filter"
                    class="w-4 h-4 mr-2 text-green-600"
                  ></i>
                  উন্নত ফিল্টার (Advanced Filter)
                </h3>
                <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
              </div>
              <div
                id="population-filter-panel"
                class="filter-panel grid grid-cols-1 md:grid-cols-4 gap-4 mt-4"
              >
                <input
                  type="text"
                  id="filter-pop-search"
                  class="w-full p-2 border rounded-md md:col-span-2"
                  placeholder="নাম, NID বা মোবাইল..."
                />
                <div class="flex gap-2">
                  <input
                    type="number"
                    id="filter-pop-age-min"
                    class="w-1/2 p-2 border rounded-md"
                    placeholder="Min Age"
                  />
                  <input
                    type="number"
                    id="filter-pop-age-max"
                    class="w-1/2 p-2 border rounded-md"
                    placeholder="Max Age"
                  />
                </div>
                <select
                  id="filter-pop-village"
                  class="w-full p-2 border rounded-md"
                >
                  <option value="">-- সব গ্রাম --</option>
                </select>
                <select
                  id="filter-pop-bongsho"
                  class="w-full p-2 border rounded-md md:col-span-4"
                >
                  <option value="">-- সব বংশ --</option>
                </select>

                <div class="md:col-span-4 flex justify-end gap-2">
                  <button
                    onclick="resetPopulationFilters()"
                    class="px-4 py-2 text-sm text-gray-600 bg-gray-100 rounded hover:bg-gray-200"
                  >
                    রিসেট
                  </button>
                  <button
                    onclick="applyPopulationFilters()"
                    class="px-4 py-2 text-sm text-white bg-green-600 rounded hover:bg-green-700"
                  >
                    ফিল্টার করুন
                  </button>
                </div>
              </div>
            </div>

            <div
              class="bg-white rounded-lg shadow-lg overflow-x-auto min-h-[300px]"
            >
              <table class="w-full min-w-max">
                <thead class="bg-gray-100">
                  <tr>
                    <th
                      class="p-4 text-left text-sm font-semibold text-gray-600 sortable-th"
                      data-sort="name"
                    >
                      নাম <span class="sort-arrow arrow-up">▲</span
                      ><span class="sort-arrow arrow-down">▼</span>
                    </th>
                    <th
                      class="p-4 text-left text-sm font-semibold text-gray-600 hidden md:table-cell"
                    >
                      পেশা ও সেবা
                    </th>
                    <th
                      class="p-4 text-left text-sm font-semibold text-gray-600 hidden md:table-cell sortable-th"
                      data-sort="nid"
                    >
                      NID নম্বর <span class="sort-arrow arrow-up">▲</span
                      ><span class="sort-arrow arrow-down">▼</span>
                    </th>
                    <th
                      class="p-4 text-left text-sm font-semibold text-gray-600 hidden md:table-cell"
                    >
                      মোবাইল
                    </th>
                    <th
                      class="p-4 text-left text-sm font-semibold text-gray-600 sortable-th"
                      data-sort="householdNo"
                    >
                      বাড়ি / বংশ <span class="sort-arrow arrow-up">▲</span
                      ><span class="sort-arrow arrow-down">▼</span>
                    </th>
                  </tr>
                </thead>
                <tbody id="population-list">
                  <tr id="population-list-loading">
                    <td colspan="5" class="p-4 text-center text-gray-500">
                      তালিকা লোড হচ্ছে...
                    </td>
                  </tr>
                  <!-- Population rows will be injected here -->
                </tbody>
              </table>
            </div>

            <!-- Pagination Population -->
            <div
              class="flex flex-col md:flex-row justify-between items-center mt-6 text-sm text-gray-600 bg-white p-4 rounded-lg shadow-sm border"
            >
              <div id="pagination-info-population">
                Showing 0 to 0 of 0 entries
              </div>
              <div class="flex gap-2 mt-2 md:mt-0 items-center">
                <span class="hidden md:inline mr-2">Rows per page:</span>
                <select
                  id="rows-per-page-population"
                  class="border rounded p-1"
                  onchange="changeRowsPerPage('population', this.value)"
                >
                  <option value="10">10</option>
                  <option value="20">20</option>
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                </select>
                <div class="flex gap-1 ml-2">
                  <button
                    id="prev-btn-population"
                    class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    onclick="changePage('population', -1)"
                  >
                    Prev
                  </button>
                  <span
                    id="page-display-population"
                    class="px-3 py-1 font-medium"
                    >1</span
                  >
                  <button
                    id="next-btn-population"
                    class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    onclick="changePage('population', 1)"
                  >
                    Next
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Page: Notices -->
          <div id="page-notices" class="page-content hidden">
            <div
              class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4"
            >
              <h2 class="text-3xl font-bold text-gray-800">নোটিশ বোর্ড</h2>
              <button
                id="add-notice-btn"
                class="w-full md:w-auto bg-blue-600 text-white py-2 px-5 rounded-lg font-medium hover:bg-blue-700 flex items-center justify-center gap-2"
              >
                <i data-lucide="plus" class="w-5 h-5"></i>
                নতুন নোটিশ দিন
              </button>
            </div>

            <div
              id="notice-list"
              class="grid grid-cols-1 md:grid-cols-2 gap-6 min-h-[200px]"
            >
              <p
                id="notice-list-loading"
                class="text-center text-gray-500 py-4 col-span-full"
              >
                নোটিশ লোড হচ্ছে...
              </p>
              <!-- Notice items will be injected here -->
            </div>

            <!-- Pagination Notices -->
            <div
              class="flex flex-col md:flex-row justify-between items-center mt-6 text-sm text-gray-600 bg-white p-4 rounded-lg shadow-sm border"
            >
              <div id="pagination-info-notices">
                Showing 0 to 0 of 0 entries
              </div>
              <div class="flex gap-2 mt-2 md:mt-0 items-center">
                <span class="hidden md:inline mr-2">Rows per page:</span>
                <select
                  id="rows-per-page-notices"
                  class="border rounded p-1"
                  onchange="changeRowsPerPage('notices', this.value)"
                >
                  <option value="6" selected>6</option>
                  <option value="12">12</option>
                  <option value="24">24</option>
                </select>
                <div class="flex gap-1 ml-2">
                  <button
                    id="prev-btn-notices"
                    class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    onclick="changePage('notices', -1)"
                  >
                    Prev
                  </button>
                  <span id="page-display-notices" class="px-3 py-1 font-medium"
                    >1</span
                  >
                  <button
                    id="next-btn-notices"
                    class="px-3 py-1 border rounded hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"
                    onclick="changePage('notices', 1)"
                  >
                    Next
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Page: Administration -->
          <div id="page-admin" class="page-content hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">
              প্রশাসনিক তথ্য
            </h2>
            <div class="bg-white rounded-lg shadow-lg p-6 max-w-2xl mx-auto">
              <form id="admin-info-form">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">
                  প্রধান পরিচিতি
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label
                      for="admin-chairman-name"
                      class="block text-sm font-medium text-gray-700 mb-1"
                      >চেয়ারম্যানের নাম</label
                    >
                    <input
                      type="text"
                      id="admin-chairman-name"
                      class="w-full p-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  <div>
                    <label
                      for="admin-chairman-mobile"
                      class="block text-sm font-medium text-gray-700 mb-1"
                      >চেয়ারম্যানের মোবাইল</label
                    >
                    <input
                      type="tel"
                      id="admin-chairman-mobile"
                      class="w-full p-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  <div>
                    <label
                      for="admin-member-name"
                      class="block text-sm font-medium text-gray-700 mb-1"
                      >সদস্য (মেম্বার)-এর নাম</label
                    >
                    <input
                      type="text"
                      id="admin-member-name"
                      class="w-full p-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  <div>
                    <label
                      for="admin-member-mobile"
                      class="block text-sm font-medium text-gray-700 mb-1"
                      >সদস্য (মেম্বার)-এর মোবাইল</label
                    >
                    <input
                      type="tel"
                      id="admin-member-mobile"
                      class="w-full p-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  <div>
                    <label
                      for="admin-police-name"
                      class="block text-sm font-medium text-gray-700 mb-1"
                      >গ্রাম পুলিশের নাম</label
                    >
                    <input
                      type="text"
                      id="admin-police-name"
                      class="w-full p-2 border border-gray-300 rounded-md"
                    />
                  </div>
                  <div>
                    <label
                      for="admin-police-mobile"
                      class="block text-sm font-medium text-gray-700 mb-1"
                      >গ্রাম পুলিশের মোবাইল</label
                    >
                    <input
                      type="tel"
                      id="admin-police-mobile"
                      class="w-full p-2 border border-gray-300 rounded-md"
                    />
                  </div>
                </div>
                <button
                  id="admin-submit-btn"
                  type="submit"
                  class="w-full md:w-auto mt-6 bg-blue-600 text-white py-2.5 px-6 rounded-lg font-semibold hover:bg-blue-700"
                >
                  তথ্য সংরক্ষণ করুন
                </button>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div>

    <!-- Modals -->
    <!-- ... (No changes to other modals, keeping them for completeness) ... -->
    <!-- Add Dropdown Option Modal (Generic) -->
    <div
      id="add-dropdown-option-modal"
      class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden-transition z-50"
    >
      <div
        class="modal-content bg-white rounded-lg shadow-xl max-w-sm w-full transform scale-95"
      >
        <div class="p-6">
          <h3
            class="text-lg font-bold text-gray-800 mb-4"
            id="dropdown-modal-title"
          >
            নতুন অপশন যোগ করুন
          </h3>
          <div class="mb-4">
            <label
              id="dropdown-input-label"
              class="block text-sm font-medium text-gray-700 mb-1"
              >নাম</label
            >
            <input
              type="text"
              id="dropdown-new-value"
              class="w-full p-2 border border-gray-300 rounded-md"
              placeholder="নতুন নাম লিখুন..."
            />
          </div>
          <div class="flex justify-end gap-3">
            <button
              id="dropdown-cancel-btn"
              class="py-2 px-4 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300"
            >
              বাতিল
            </button>
            <button
              id="dropdown-add-btn"
              class="py-2 px-4 bg-blue-600 text-white rounded-md hover:bg-blue-700"
            >
              যোগ করুন
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add/Edit Bongsho Modal -->
    <div
      id="add-bongsho-modal"
      class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden-transition z-30"
    >
      <div
        class="modal-content bg-white rounded-lg shadow-xl max-w-lg w-full transform scale-95"
      >
        <div class="flex justify-between items-center p-5 border-b">
          <h3
            class="text-2xl font-semibold text-gray-800"
            id="bongsho-modal-title"
          >
            নতুন বংশ
          </h3>
          <button
            class="modal-close-btn text-gray-400 hover:text-gray-600 text-3xl"
          >
            &times;
          </button>
        </div>
        <form id="add-bongsho-form" class="p-6 space-y-4">
          <input type="hidden" id="bongsho-id" />
          <div>
            <label
              for="bongsho-name"
              class="block text-sm font-medium text-gray-700 mb-1"
              >বংশের নাম <span class="text-red-500">*</span></label
            >
            <input
              type="text"
              id="bongsho-name"
              required
              class="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div>
            <label
              for="bongsho-description"
              class="block text-sm font-medium text-gray-700 mb-1"
              >সংক্ষিপ্ত বিবরণ (ঐচ্ছিক)</label
            >
            <textarea
              id="bongsho-description"
              rows="3"
              class="w-full p-2 border border-gray-300 rounded-md"
            ></textarea>
          </div>
          <button
            type="submit"
            id="bongsho-form-submit"
            class="w-full bg-purple-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-purple-700"
          >
            বংশ সংরক্ষণ করুন
          </button>
        </form>
      </div>
    </div>

    <!-- Add/Edit Household Modal -->
    <div
      id="add-household-modal"
      class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden-transition z-30"
    >
      <div
        class="modal-content bg-white rounded-lg shadow-xl max-w-lg w-full transform scale-95"
      >
        <div class="flex justify-between items-center p-5 border-b">
          <h3
            class="text-2xl font-semibold text-gray-800"
            id="household-modal-title"
          >
            নতুন হোল্ডিং যোগ করুন
          </h3>
          <button
            class="modal-close-btn text-gray-400 hover:text-gray-600 text-3xl"
          >
            &times;
          </button>
        </div>
        <form
          id="add-household-form"
          class="p-6 space-y-4 max-h-[80vh] overflow-y-auto"
        >
          <input type="hidden" id="household-id" />
          <div>
            <label
              for="household-bongsho"
              class="block text-sm font-medium text-gray-700 mb-1"
              >বংশ <span class="text-red-500">*</span></label
            ><select
              id="household-bongsho"
              required
              class="w-full p-2 border border-gray-300 rounded-md"
              ><option value="">-- বংশ নির্বাচন করুন --</option></select
            >
          </div>
          <div>
            <label
              for="household-common-name"
              class="block text-sm font-medium text-gray-700 mb-1"
              >বাড়ির পরিচিত নাম <span class="text-red-500">*</span></label
            ><input
              type="text"
              id="household-common-name"
              required
              class="w-full p-2 border border-gray-300 rounded-md"
              placeholder="বাড়ির পরিচিত নাম লিখুন"
            />
          </div>
          <div>
            <label
              for="household-owner-name"
              class="block text-sm font-medium text-gray-700 mb-1"
              >বাড়ির প্রধানের নাম <span class="text-red-500">*</span></label
            ><input
              type="text"
              id="household-owner-name"
              required
              class="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div>
            <label
              for="household-owner-father"
              class="block text-sm font-medium text-gray-700 mb-1"
              >পিতার নাম</label
            ><input
              type="text"
              id="household-owner-father"
              class="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div>
            <label
              for="household-official-no"
              class="block text-sm font-medium text-gray-700 mb-1"
              >অফিসিয়াল হোল্ডিং নম্বর (ঐচ্ছিক)</label
            ><input
              type="text"
              id="household-official-no"
              class="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div>
            <label
              for="household-area"
              class="block text-sm font-medium text-gray-700 mb-1"
              >গ্রাম/পাড়া</label
            >
            <div class="flex gap-2">
              <select
                id="household-area"
                class="w-full p-2 border border-gray-300 rounded-md"
                ><option value="">-- পাড়া নির্বাচন করুন --</option></select
              ><button
                type="button"
                id="add-area-btn"
                class="bg-gray-200 p-2 rounded-md hover:bg-gray-300 text-gray-700"
              >
                <i data-lucide="plus" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
          <div>
            <label
              for="household-mobile"
              class="block text-sm font-medium text-gray-700 mb-1"
              >মোবাইল নম্বর</label
            ><input
              type="tel"
              id="household-mobile"
              class="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
            <p class="text-sm font-semibold text-blue-700 uppercase mb-3">
              অতিরিক্ত তথ্য (মালিক)
            </p>
            <div class="grid grid-cols-2 gap-4 mb-3">
              <div>
                <label
                  for="household-owner-occupation"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >পেশা</label
                ><input
                  type="text"
                  id="household-owner-occupation"
                  class="w-full p-2 border border-gray-300 rounded-md"
                />
              </div>
              <div>
                <label
                  for="household-owner-blood"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >রক্তের গ্রুপ</label
                ><select
                  id="household-owner-blood"
                  class="w-full p-2 border border-gray-300 rounded-md"
                  ><option value="">-- বাছাই --</option
                  ><option value="A+">A+</option
                  ><option value="A-">A-</option
                  ><option value="B+">B+</option
                  ><option value="B-">B-</option
                  ><option value="O+">O+</option
                  ><option value="O-">O-</option
                  ><option value="AB+">AB+</option
                  ><option value="AB-">AB-</option></select
                >
              </div>
            </div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >স্বেচ্ছাসেবী কাজে আগ্রহ:</label
            >
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="h-vol-blood"
                  value="blood"
                  class="h-4 w-4 text-blue-600 rounded border-gray-300"
                /><label for="h-vol-blood" class="ml-2 text-gray-700"
                  >রক্তদান</label
                >
              </div>
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="h-vol-money"
                  value="money"
                  class="h-4 w-4 text-blue-600 rounded border-gray-300"
                /><label for="h-vol-money" class="ml-2 text-gray-700"
                  >আর্থিক সাহায্য</label
                >
              </div>
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="h-vol-education"
                  value="education"
                  class="h-4 w-4 text-blue-600 rounded border-gray-300"
                /><label for="h-vol-education" class="ml-2 text-gray-700"
                  >শিক্ষা দান</label
                >
              </div>
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="h-vol-health"
                  value="health"
                  class="h-4 w-4 text-blue-600 rounded border-gray-300"
                /><label for="h-vol-health" class="ml-2 text-gray-700"
                  >চিকিৎসা সেবা</label
                >
              </div>
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="h-vol-social"
                  value="social"
                  class="h-4 w-4 text-blue-600 rounded border-gray-300"
                /><label for="h-vol-social" class="ml-2 text-gray-700"
                  >সামাজিক কাজ</label
                >
              </div>
            </div>
          </div>
          <button
            type="submit"
            id="household-form-submit"
            class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-blue-700"
          >
            সংরক্ষণ করুন
          </button>
        </form>
      </div>
    </div>

    <div
      id="household-details-modal"
      class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden-transition z-30"
    >
      <div
        class="modal-content bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] flex flex-col transform scale-95"
      >
        <div class="flex justify-between items-center p-5 border-b">
          <h3
            class="text-2xl font-semibold text-gray-800"
            id="details-modal-title"
          >
            হোল্ডিং বিবরণ
          </h3>
          <button
            class="modal-close-btn text-gray-400 hover:text-gray-600 text-3xl"
          >
            &times;
          </button>
        </div>
        <div class="modal-body p-6 overflow-y-auto">
          <div class="mb-6 pb-4 border-b">
            <div class="flex justify-between items-start">
              <div>
                <h4 class="text-xl font-semibold text-gray-700 mb-3">
                  হোল্ডিং তথ্য
                </h4>
                <p class="text-gray-600">
                  <strong class="font-medium text-gray-800">পরিচিত নাম:</strong>
                  <span id="detail-common-name"></span>
                </p>
                <p class="text-gray-600">
                  <strong class="font-medium text-gray-800"
                    >বাড়ির প্রধান:</strong
                  >
                  <span id="detail-owner-name"></span>
                </p>
                <p class="text-gray-600">
                  <strong class="font-medium text-gray-800">বংশ:</strong>
                  <span id="detail-bongsho-name"></span>
                </p>
                <p class="text-gray-600">
                  <strong class="font-medium text-gray-800">পিতার নাম:</strong>
                  <span id="detail-owner-father"></span>
                </p>
                <p class="text-gray-600">
                  <strong class="font-medium text-gray-800"
                    >অফিসিয়াল হোল্ডিং নং:</strong
                  >
                  <span id="detail-holding-no"></span>
                </p>
                <p class="text-gray-600">
                  <strong class="font-medium text-gray-800"
                    >গ্রাম/পাড়া:</strong
                  >
                  <span id="detail-area"></span>
                </p>
                <p class="text-gray-600">
                  <strong class="font-medium text-gray-800">মোবাইল:</strong>
                  <span id="detail-mobile"></span>
                </p>
              </div>
              <button
                id="details-edit-household-btn"
                class="bg-yellow-500 text-white py-2 px-4 rounded-lg font-medium hover:bg-yellow-600 text-sm flex items-center gap-2"
              >
                <i data-lucide="pencil" class="w-4 h-4"></i> সম্পাদনা
              </button>
            </div>
          </div>
          <div>
            <div class="flex justify-between items-center mb-3">
              <h4 class="text-xl font-semibold text-gray-700">
                পরিবারের সদস্যদের তালিকা
              </h4>
              <button
                id="open-add-member-modal-btn"
                class="bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 text-sm flex items-center gap-2"
              >
                <i data-lucide="plus" class="w-4 h-4"></i> নতুন সদস্য
              </button>
            </div>
            <div id="family-member-list" class="space-y-3">
              <p
                id="family-list-loading"
                class="text-center text-gray-500 py-3"
              >
                লোড হচ্ছে...
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div
      id="add-member-modal"
      class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden-transition z-40"
    >
      <div
        class="modal-content bg-white rounded-lg shadow-xl max-w-lg w-full transform scale-95"
      >
        <div class="flex justify-between items-center p-5 border-b">
          <h3
            id="member-modal-title"
            class="text-2xl font-semibold text-gray-800"
          >
            নতুন পরিবারের সদস্য
          </h3>
          <button
            class="modal-close-btn text-gray-400 hover:text-gray-600 text-3xl"
          >
            &times;
          </button>
        </div>
        <form
          id="add-member-form"
          class="p-6 space-y-4 max-h-[80vh] overflow-y-auto"
        >
          <input type="hidden" id="member-id" />
          <div>
            <label
              for="member-name"
              class="block text-sm font-medium text-gray-700 mb-1"
              >সদস্যের নাম <span class="text-red-500">*</span></label
            ><input
              type="text"
              id="member-name"
              required
              class="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div>
            <label
              for="member-relation"
              class="block text-sm font-medium text-gray-700 mb-1"
              >সম্পর্ক</label
            >
            <div class="flex gap-2">
              <select
                id="member-relation"
                required
                class="w-full p-2 border border-gray-300 rounded-md"
                ><option value="">-- সম্পর্ক নির্বাচন করুন --</option></select
              ><button
                type="button"
                id="add-relation-btn"
                class="bg-gray-200 p-2 rounded-md hover:bg-gray-300 text-gray-700"
              >
                <i data-lucide="plus" class="w-5 h-5"></i>
              </button>
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="member-dob"
                class="block text-sm font-medium text-gray-700 mb-1"
                >জন্ম তারিখ</label
              ><input
                type="date"
                id="member-dob"
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label
                for="member-occupation"
                class="block text-sm font-medium text-gray-700 mb-1"
                >পেশা</label
              ><input
                type="text"
                id="member-occupation"
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label
                for="member-nid"
                class="block text-sm font-medium text-gray-700 mb-1"
                >NID / জন্ম সনদ</label
              ><input
                type="text"
                id="member-nid"
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label
                for="member-mobile"
                class="block text-sm font-medium text-gray-700 mb-1"
                >মোবাইল</label
              ><input
                type="tel"
                id="member-mobile"
                class="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
          </div>
          <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex flex-col gap-3">
              <div>
                <label
                  for="member-blood"
                  class="block text-sm font-medium text-gray-700 mb-1"
                  >রক্তের গ্রুপ</label
                ><select
                  id="member-blood"
                  class="w-full p-2 border border-gray-300 rounded-md"
                  ><option value="">-- বাছাই --</option
                  ><option value="A+">A+</option
                  ><option value="A-">A-</option
                  ><option value="B+">B+</option
                  ><option value="B-">B-</option
                  ><option value="O+">O+</option
                  ><option value="O-">O-</option
                  ><option value="AB+">AB+</option
                  ><option value="AB-">AB-</option></select
                >
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >স্বেচ্ছাসেবী কাজে আগ্রহ:</label
                >
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div class="flex items-center">
                    <input
                      type="checkbox"
                      id="vol-blood"
                      value="blood"
                      class="h-4 w-4 text-blue-600 rounded border-gray-300"
                    /><label for="vol-blood" class="ml-2 text-gray-700"
                      >রক্তদান</label
                    >
                  </div>
                  <div class="flex items-center">
                    <input
                      type="checkbox"
                      id="vol-money"
                      value="money"
                      class="h-4 w-4 text-blue-600 rounded border-gray-300"
                    /><label for="vol-money" class="ml-2 text-gray-700"
                      >আর্থিক সাহায্য</label
                    >
                  </div>
                  <div class="flex items-center">
                    <input
                      type="checkbox"
                      id="vol-education"
                      value="education"
                      class="h-4 w-4 text-blue-600 rounded border-gray-300"
                    /><label for="vol-education" class="ml-2 text-gray-700"
                      >শিক্ষা দান</label
                    >
                  </div>
                  <div class="flex items-center">
                    <input
                      type="checkbox"
                      id="vol-health"
                      value="health"
                      class="h-4 w-4 text-blue-600 rounded border-gray-300"
                    /><label for="vol-health" class="ml-2 text-gray-700"
                      >চিকিৎসা সেবা</label
                    >
                  </div>
                  <div class="flex items-center">
                    <input
                      type="checkbox"
                      id="vol-social"
                      value="social"
                      class="h-4 w-4 text-blue-600 rounded border-gray-300"
                    /><label for="vol-social" class="ml-2 text-gray-700"
                      >সামাজিক কাজ</label
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
          <button
            type="submit"
            id="member-form-submit"
            class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-blue-700"
          >
            সদস্য সংরক্ষণ করুন
          </button>
        </form>
      </div>
    </div>
    <div
      id="add-notice-modal"
      class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden-transition z-30"
    >
      <div
        class="modal-content bg-white rounded-lg shadow-xl max-w-lg w-full transform scale-95"
      >
        <div class="flex justify-between items-center p-5 border-b">
          <h3
            class="text-2xl font-semibold text-gray-800"
            id="notice-modal-title"
          >
            নতুন নোটিশ
          </h3>
          <button
            class="modal-close-btn text-gray-400 hover:text-gray-600 text-3xl"
          >
            &times;
          </button>
        </div>
        <form id="add-notice-form" class="p-6 space-y-4">
          <input type="hidden" id="notice-id" />
          <div>
            <label
              for="notice-title"
              class="block text-sm font-medium text-gray-700 mb-1"
              >শিরোনাম</label
            ><input
              type="text"
              id="notice-title"
              required
              class="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <div>
            <label
              for="notice-details"
              class="block text-sm font-medium text-gray-700 mb-1"
              >বিস্তারিত</label
            ><textarea
              id="notice-details"
              rows="5"
              required
              class="w-full p-2 border border-gray-300 rounded-md"
            ></textarea>
          </div>
          <button
            type="submit"
            id="notice-form-submit"
            class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-blue-700"
          >
            নোটিশ পোস্ট করুন
          </button>
        </form>
      </div>
    </div>
    <div
      id="forgot-password-modal"
      class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden-transition z-30"
    >
      <div
        class="modal-content bg-white rounded-lg shadow-xl max-w-md w-full transform scale-95"
      >
        <div class="flex justify-between items-center p-5 border-b">
          <h3 class="text-2xl font-semibold text-gray-800">পাসওয়ার্ড রিসেট</h3>
          <button
            class="modal-close-btn text-gray-400 hover:text-gray-600 text-3xl"
          >
            &times;
          </button>
        </div>
        <form id="forgot-password-form" class="p-6 space-y-4">
          <p class="text-gray-600 text-sm">
            আপনার ইমেইল অ্যাড্রেস লিখুন। আমরা আপনাকে পাসওয়ার্ড রিসেট করার জন্য
            একটি লিঙ্ক পাঠাবো।
          </p>
          <div>
            <label
              for="reset-email"
              class="block text-sm font-medium text-gray-700 mb-1"
              >ইমেইল</label
            ><input
              type="email"
              id="reset-email"
              required
              class="w-full p-2 border border-gray-300 rounded-md"
            />
          </div>
          <button
            type="submit"
            id="forgot-password-submit"
            class="w-full bg-blue-600 text-white py-2.5 px-4 rounded-lg font-semibold hover:bg-blue-700"
          >
            রিসেট লিঙ্ক পাঠান
          </button>
        </form>
      </div>
    </div>
    <div
      id="confirmation-modal"
      class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden-transition z-50"
    >
      <div
        class="modal-content bg-white rounded-lg shadow-xl max-w-sm w-full transform scale-95"
      >
        <div class="p-6 text-center">
          <i
            data-lucide="alert-triangle"
            class="w-16 h-16 text-red-500 mx-auto mb-4"
          ></i>
          <h3
            id="confirm-title"
            class="text-2xl font-semibold text-gray-800 mb-2"
          >
            আপনি কি নিশ্চিত?
          </h3>
          <p id="confirm-message" class="text-gray-600 mb-6">
            এই কাজটি আর ফেরানো যাবে না।
          </p>
          <div class="flex justify-center gap-4">
            <button
              id="confirm-cancel-btn"
              class="py-2 px-6 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300"
            >
              বাতিল</button
            ><button
              id="confirm-delete-btn"
              class="py-2 px-6 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700"
            >
              হ্যাঁ, মুছুন
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      id="toast-notification"
      class="fixed bottom-5 right-5 text-white py-3 px-6 rounded-lg shadow-lg hidden-transition z-50"
    >
      <span id="toast-message"></span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
      import {
        getAuth,
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        sendPasswordResetEmail,
        setPersistence,
        browserLocalPersistence,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        doc,
        setDoc,
        getDoc,
        getDocs,
        deleteDoc,
        updateDoc,
        onSnapshot,
        query,
        setLogLevel,
        Timestamp,
        collectionGroup,
        getCountFromServer,
        writeBatch,
        where,
        limit,
        orderBy,
        arrayUnion,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyCzrawBYP2xHj1sev0FSVJAYch8V7EpuMQ",
        authDomain: "rp-village-management.firebaseapp.com",
        projectId: "rp-village-management",
        storageBucket: "rp-village-management.firebasestorage.app",
        messagingSenderId: "499504549624",
        appId: "1:499504549624:web:42d9e868493cb2fee4350d",
        measurementId: "G-1YZJRLYN4G",
      };
      const appId = firebaseConfig.projectId || "default-village-app";
      if (!firebaseConfig.apiKey) {
        document.body.innerHTML =
          '<div class="p-8 text-center text-red-600">Firebase কনফিগারেশন ত্রুটিপূর্ণ।</div>';
        throw new Error("Invalid Firebase Config");
      }

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);
      const db = getFirestore(app);
      setLogLevel("Debug");

      let currentUserId = null;
      let currentHouseholdId = null;
      let currentHouseholdData = null;
      let householdUnsubscribe = null;
      let familyMemberUnsubscribe = null;
      let populationUnsubscribe = null;
      let noticesUnsubscribe = null;
      let dashboardNoticesUnsubscribe = null;
      let bongshosUnsubscribe = null;
      let populationDataCache = [];
      let householdDataCache = [];
      let bongshoDataCache = [];
      let noticesDataCache = [];
      let dropdownCache = { villages: [], relations: [] };
      let currentDropdownAddingType = null;

      let householdFilters = { search: "", bongsho: "", village: "" };
      let populationFilters = {
        search: "",
        ageMin: "",
        ageMax: "",
        village: "",
        bongsho: "",
      };
      let paginationState = {
        households: { page: 1, limit: 10 },
        population: { page: 1, limit: 50 },
        volunteers: { page: 1, limit: 12 },
        notices: { page: 1, limit: 6 },
      };
      let currentVolType = "all";

      const bongshosCollectionPath = `/artifacts/${appId}/public/data/bongshos`;
      const householdsCollectionPath = `/artifacts/${appId}/public/data/households`;
      const allPeopleCollectionPath = `/artifacts/${appId}/public/data/allPeople`;
      const noticesCollectionPath = `/artifacts/${appId}/public/data/notices`;
      const adminDocPath = `/artifacts/${appId}/public/data/config/administration`;
      const configCollectionPath = `/artifacts/${appId}/public/data/config`;

      const globalLoader = document.getElementById("global-loader");
      const authContainer = document.getElementById("auth-container");
      const appContainer = document.getElementById("app-container");
      const sidebar = document.getElementById("sidebar");
      const openSidebarBtn = document.getElementById("open-sidebar-btn");
      const closeSidebarBtn = document.getElementById("close-sidebar-btn");
      const loginForm = document.getElementById("login-form");
      const signupForm = document.getElementById("signup-form");
      const showLoginTab = document.getElementById("show-login-tab");
      const showSignupTab = document.getElementById("show-signup-tab");
      const authError = document.getElementById("auth-error");
      const logoutButton = document.getElementById("logout-button");
      const userEmailDisplay = document.getElementById("user-email-display");
      const forgotPasswordLink = document.getElementById(
        "forgot-password-link"
      );
      const forgotPasswordModal = document.getElementById(
        "forgot-password-modal"
      );
      const forgotPasswordForm = document.getElementById(
        "forgot-password-form"
      );
      const forgotPasswordSubmit = document.getElementById(
        "forgot-password-submit"
      );
      const pageContents = document.querySelectorAll(".page-content");
      const sidebarLinks = document.querySelectorAll(".sidebar-link");
      const statTotalBongshos = document.getElementById("stat-total-bongshos");
      const statTotalHouseholds = document.getElementById(
        "stat-total-households"
      );
      const statTotalPopulation = document.getElementById(
        "stat-total-population"
      );
      const statTotalNotices = document.getElementById("stat-total-notices");
      const dashboardRecentNotices = document.getElementById(
        "dashboard-recent-notices"
      );
      const dashboardNoticesLoading = document.getElementById(
        "dashboard-notices-loading"
      );
      const dashboardCurrentDate = document.getElementById(
        "dashboard-current-date"
      );
      const dashAdminChairman = document.getElementById("dash-admin-chairman");
      const dashAdminChairmanCall = document.getElementById(
        "dash-admin-chairman-call"
      );
      const dashAdminMember = document.getElementById("dash-admin-member");
      const dashAdminMemberCall = document.getElementById(
        "dash-admin-member-call"
      );
      const dashAdminPolice = document.getElementById("dash-admin-police");
      const dashAdminPoliceCall = document.getElementById(
        "dash-admin-police-call"
      );
      const dashboardRecentActivity = document.getElementById(
        "dashboard-recent-activity"
      );
      const ageStatChild = document.getElementById("age-stat-child");
      const ageStatAdult = document.getElementById("age-stat-adult");
      const ageStatSenior = document.getElementById("age-stat-senior");
      const barChild = document.getElementById("bar-child");
      const barAdult = document.getElementById("bar-adult");
      const barSenior = document.getElementById("bar-senior");
      const statTotalVolunteers = document.getElementById(
        "stat-total-volunteers"
      );

      window.handleDashboardSearch = function (query) {
        if (query.length > 1) {
          showPage("page-population");
          document.getElementById("filter-pop-search").value = query;
          applyPopulationFilters();
        }
      };

      const addBongshoBtn = document.getElementById("add-bongsho-btn");
      const addBongshoModal = document.getElementById("add-bongsho-modal");
      const addBongshoForm = document.getElementById("add-bongsho-form");
      const bongshoModalTitle = document.getElementById("bongsho-modal-title");
      const bongshoFormSubmit = document.getElementById("bongsho-form-submit");
      const bongshoList = document.getElementById("bongsho-list");
      const bongshoListLoading = document.getElementById(
        "bongsho-list-loading"
      );
      const bongshoSearch = document.getElementById("bongsho-search");
      const addHouseholdBtn = document.getElementById("add-household-btn");
      const addHouseholdModal = document.getElementById("add-household-modal");
      const addHouseholdForm = document.getElementById("add-household-form");
      const householdModalTitle = document.getElementById(
        "household-modal-title"
      );
      const householdFormSubmit = document.getElementById(
        "household-form-submit"
      );
      const householdList = document.getElementById("household-list");
      const householdListLoading = document.getElementById(
        "household-list-loading"
      );
      const householdBongshoSelect = document.getElementById(
        "household-bongsho"
      );
      const householdAreaSelect = document.getElementById("household-area");
      const addAreaBtn = document.getElementById("add-area-btn");
      const filterHouseholdSearch = document.getElementById(
        "filter-household-search"
      );
      const filterHouseholdBongsho = document.getElementById(
        "filter-household-bongsho"
      );
      const filterHouseholdVillage = document.getElementById(
        "filter-household-village"
      );
      const householdDetailsModal = document.getElementById(
        "household-details-modal"
      );
      const detailCommonName = document.getElementById("detail-common-name");
      const detailHoldingNo = document.getElementById("detail-holding-no");
      const detailBongshoName = document.getElementById("detail-bongsho-name");
      const detailOwnerName = document.getElementById("detail-owner-name");
      const detailOwnerFather = document.getElementById("detail-owner-father");
      const detailArea = document.getElementById("detail-area");
      const detailMobile = document.getElementById("detail-mobile");
      const detailsModalTitle = document.getElementById("details-modal-title");
      const detailsEditHouseholdBtn = document.getElementById(
        "details-edit-household-btn"
      );
      const familyMemberList = document.getElementById("family-member-list");
      const familyListLoading = document.getElementById("family-list-loading");
      const openAddMemberModalBtn = document.getElementById(
        "open-add-member-modal-btn"
      );
      const addMemberModal = document.getElementById("add-member-modal");
      const addMemberForm = document.getElementById("add-member-form");
      const memberModalTitle = document.getElementById("member-modal-title");
      const memberFormSubmit = document.getElementById("member-form-submit");
      const memberRelationSelect = document.getElementById("member-relation");
      const addRelationBtn = document.getElementById("add-relation-btn");
      const addDropdownOptionModal = document.getElementById(
        "add-dropdown-option-modal"
      );
      const dropdownModalTitle = document.getElementById(
        "dropdown-modal-title"
      );
      const dropdownInputLabel = document.getElementById(
        "dropdown-input-label"
      );
      const dropdownNewValue = document.getElementById("dropdown-new-value");
      const dropdownCancelBtn = document.getElementById("dropdown-cancel-btn");
      const dropdownAddBtn = document.getElementById("dropdown-add-btn");
      const populationList = document.getElementById("population-list");
      const populationListLoading = document.getElementById(
        "population-list-loading"
      );
      const exportCsvBtn = document.getElementById("export-csv-btn");
      const sortableThs = document.querySelectorAll(".sortable-th");
      const filterPopSearch = document.getElementById("filter-pop-search");
      const filterPopAgeMin = document.getElementById("filter-pop-age-min");
      const filterPopAgeMax = document.getElementById("filter-pop-age-max");
      const filterPopVillage = document.getElementById("filter-pop-village");
      const filterPopBongsho = document.getElementById("filter-pop-bongsho");
      const addNoticeBtn = document.getElementById("add-notice-btn");
      const addNoticeModal = document.getElementById("add-notice-modal");
      const addNoticeForm = document.getElementById("add-notice-form");
      const noticeModalTitle = document.getElementById("notice-modal-title");
      const noticeFormSubmit = document.getElementById("notice-form-submit");
      const noticeList = document.getElementById("notice-list");
      const noticeListLoading = document.getElementById("notice-list-loading");
      const volunteerGrid = document.getElementById("volunteer-grid");
      const volunteerFilters = document.getElementById("volunteer-filters");
      const filterVolBloodGroup = document.getElementById(
        "filter-vol-blood-group"
      );
      const adminInfoForm = document.getElementById("admin-info-form");
      const adminSubmitBtn = document.getElementById("admin-submit-btn");
      const allModals = document.querySelectorAll(".modal");
      const modalCloseBtns = document.querySelectorAll(".modal-close-btn");
      const toastNotification = document.getElementById("toast-notification");
      const toastMessage = document.getElementById("toast-message");
      let confirmationModal = document.getElementById("confirmation-modal");
      let confirmTitle = document.getElementById("confirm-title");
      let confirmMessage = document.getElementById("confirm-message");
      let confirmCancelBtn = document.getElementById("confirm-cancel-btn");
      let confirmDeleteBtn = document.getElementById("confirm-delete-btn");

      window.toggleFilter = function (panelId) {
        const panel = document.getElementById(panelId);
        if (panel.classList.contains("open")) {
          panel.classList.remove("open");
        } else {
          panel.classList.add("open");
        }
      };

      function showLoader(show) {
        if (show) {
          globalLoader.classList.remove("hidden-transition");
        } else {
          globalLoader.classList.add("hidden-transition");
        }
      }
      function showToast(message, isError = false) {
        toastMessage.textContent = message;
        toastNotification.classList.remove(
          "hidden-transition",
          "bg-green-600",
          "bg-red-600"
        );
        toastNotification.classList.add(
          isError ? "bg-red-600" : "bg-green-600"
        );
        setTimeout(
          () => toastNotification.classList.add("hidden-transition"),
          3000
        );
      }
      function toggleModal(modal, show) {
        const modalContent = modal.querySelector(".modal-content");
        if (show) {
          modal.classList.remove("hidden");
          setTimeout(() => {
            modal.classList.remove("hidden-transition");
            if (modalContent) modalContent.classList.remove("scale-95");
          }, 20);
        } else {
          modal.classList.add("hidden-transition");
          if (modalContent) modalContent.classList.add("scale-95");
          setTimeout(() => {
            modal.classList.add("hidden");
          }, 250);
        }
      }
      function showConfirmationModal(title, message, onConfirm) {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        toggleModal(confirmationModal, true);
        confirmDeleteBtn = document.getElementById("confirm-delete-btn");
        confirmCancelBtn = document.getElementById("confirm-cancel-btn");
        const newDeleteBtn = confirmDeleteBtn.cloneNode(true);
        confirmDeleteBtn.parentNode.replaceChild(
          newDeleteBtn,
          confirmDeleteBtn
        );
        confirmDeleteBtn = newDeleteBtn;
        confirmDeleteBtn.onclick = () => {
          onConfirm();
          toggleModal(confirmationModal, false);
        };
        confirmCancelBtn.onclick = () => {
          toggleModal(confirmationModal, false);
        };
      }
      function toggleSidebar(show) {
        if (show) {
          sidebar.classList.remove("-translate-x-full");
        } else {
          sidebar.classList.add("-translate-x-full");
        }
      }
      function showAuthError(message) {
        authError.textContent = message;
        authError.classList.remove("hidden");
      }
      function getFriendlyAuthError(error) {
        switch (error.code) {
          case "auth/invalid-email":
            return "অনুগ্রহ করে একটি সঠিক ইমেইল লিখুন।";
          case "auth/user-not-found":
          case "auth/wrong-password":
            return "ইমেইল বা পাসওয়ার্ড ভুল হয়েছে।";
          default:
            return "একটি অজানা ত্রুটি ঘটেছে।";
        }
      }

      window.showPage = function (pageId) {
        pageContents.forEach((page) => page.classList.add("hidden"));
        const targetPage = document.getElementById(pageId);
        if (targetPage) targetPage.classList.remove("hidden");
        sidebarLinks.forEach((link) => {
          if (link.dataset.page === pageId) {
            link.classList.add("active");
          } else {
            link.classList.remove("active");
          }
        });
        if (pageId === "page-volunteers") {
          window.filterVolunteers("all");
        }
        if (window.innerWidth < 768) {
          toggleSidebar(false);
        }
        document.getElementById("main-content").scrollTop = 0;
      };

      setPersistence(auth, browserLocalPersistence);

      onAuthStateChanged(auth, (user) => {
        showLoader(true);
        if (user) {
          currentUserId = user.uid;
          userEmailDisplay.textContent = user.email;
          authContainer.classList.add("hidden");
          appContainer.classList.remove("hidden");
          loadBongshos();
          loadHouseholds();
          loadDashboardStats();
          loadAllPeople();
          loadNotices();
          loadAdminInfo();
          loadRecentDashboardNotices();
          loadDropdownOptions();
          const dateOptions = {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          };
          dashboardCurrentDate.textContent = new Date().toLocaleDateString(
            "bn-BD",
            dateOptions
          );
          showPage("page-dashboard");
          lucide.createIcons();
          showLoader(false);
        } else {
          currentUserId = null;
          authContainer.classList.remove("hidden");
          appContainer.classList.add("hidden");
          if (householdUnsubscribe) householdUnsubscribe();
          if (familyMemberUnsubscribe) familyMemberUnsubscribe();
          if (populationUnsubscribe) populationUnsubscribe();
          if (noticesUnsubscribe) noticesUnsubscribe();
          if (dashboardNoticesUnsubscribe) dashboardNoticesUnsubscribe();
          if (bongshosUnsubscribe) bongshosUnsubscribe();
          lucide.createIcons();
          showLoader(false);
        }
      });

      loginForm.addEventListener("submit", (e) => {
        e.preventDefault();
        showLoader(true);
        signInWithEmailAndPassword(
          auth,
          loginForm["login-email"].value,
          loginForm["login-password"].value
        ).catch((error) => {
          showAuthError(getFriendlyAuthError(error));
          showLoader(false);
        });
      });
      signupForm.addEventListener("submit", (e) => {
        e.preventDefault();
        showLoader(true);
        createUserWithEmailAndPassword(
          auth,
          signupForm["signup-email"].value,
          signupForm["signup-password"].value
        ).catch((error) => {
          showAuthError(getFriendlyAuthError(error));
          showLoader(false);
        });
      });
      logoutButton.addEventListener("click", () => {
        showLoader(true);
        signOut(auth);
      });
      forgotPasswordLink.addEventListener("click", (e) => {
        e.preventDefault();
        authError.classList.add("hidden");
        forgotPasswordForm.reset();
        toggleModal(forgotPasswordModal, true);
      });
      forgotPasswordForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = document.getElementById("reset-email").value;
        forgotPasswordSubmit.disabled = true;
        forgotPasswordSubmit.textContent = "পাঠানো হচ্ছে...";
        try {
          await sendPasswordResetEmail(auth, email);
          toggleModal(forgotPasswordModal, false);
          showToast("রিসেট লিঙ্ক পাঠানো হয়েছে।");
        } catch (error) {
          showToast(getFriendlyAuthError(error), true);
        } finally {
          forgotPasswordSubmit.disabled = false;
          forgotPasswordSubmit.textContent = "রিসেট লিঙ্ক পাঠান";
        }
      });
      showLoginTab.addEventListener("click", () => {
        loginForm.classList.remove("hidden");
        signupForm.classList.add("hidden");
        showLoginTab.classList.add("text-blue-600", "border-blue-600");
        showLoginTab.classList.remove("text-gray-500");
        showSignupTab.classList.add("text-gray-500");
        showSignupTab.classList.remove("text-blue-600", "border-blue-600");
        authError.classList.add("hidden");
      });
      showSignupTab.addEventListener("click", () => {
        loginForm.classList.add("hidden");
        signupForm.classList.remove("hidden");
        showLoginTab.classList.remove("text-blue-600", "border-blue-600");
        showLoginTab.classList.add("text-gray-500");
        showSignupTab.classList.remove("text-gray-500");
        showSignupTab.classList.add("text-blue-600", "border-blue-600");
        authError.classList.add("hidden");
      });

      async function loadDashboardStats() {
        try {
          const bongshosRef = collection(db, bongshosCollectionPath);
          const bongshosSnapshot = await getCountFromServer(bongshosRef);
          statTotalBongshos.textContent = `${bongshosSnapshot.data().count}`;
          const householdsRef = collection(db, householdsCollectionPath);
          const householdsSnapshot = await getCountFromServer(householdsRef);
          statTotalHouseholds.textContent = `${
            householdsSnapshot.data().count
          }`;
          const peopleRef = collection(db, allPeopleCollectionPath);
          const peopleSnapshot = await getCountFromServer(peopleRef);
          statTotalPopulation.textContent = `${peopleSnapshot.data().count}`;
          const noticesRef = collection(db, noticesCollectionPath);
          const noticesSnapshot = await getCountFromServer(noticesRef);
          statTotalNotices.textContent = `${noticesSnapshot.data().count}`;
        } catch (error) {
          console.error("Error stats", error);
        }
      }

      function loadRecentDashboardNotices() {
        if (dashboardNoticesUnsubscribe) dashboardNoticesUnsubscribe();
        const q = query(
          collection(db, noticesCollectionPath),
          orderBy("date", "desc"),
          limit(3)
        );
        dashboardNoticesUnsubscribe = onSnapshot(q, (snapshot) => {
          dashboardRecentNotices.innerHTML = "";
          if (snapshot.empty) {
            dashboardNoticesLoading.textContent = "কোনো নোটিশ নেই।";
            dashboardRecentNotices.appendChild(dashboardNoticesLoading);
            return;
          }
          snapshot.docs.forEach((doc) => {
            const data = doc.data();
            const item = document.createElement("div");
            item.className =
              "bg-white p-4 rounded-lg shadow-sm border-l-4 border-blue-400";
            item.innerHTML = `<h5 class="font-semibold text-gray-800 text-base">${
              data.title
            }</h5><p class="text-xs text-gray-500 mb-2 mt-1">${data.date
              .toDate()
              .toLocaleDateString(
                "bn-BD"
              )}</p><p class="text-sm text-gray-600 line-clamp-2">${
              data.details
            }</p>`;
            dashboardRecentNotices.appendChild(item);
          });
          lucide.createIcons();
        });
      }

      function updateDashboardRecentActivity() {
        if (!householdDataCache || householdDataCache.length === 0) {
          dashboardRecentActivity.innerHTML =
            '<p class="p-6 text-center text-gray-500">কোনো তথ্য পাওয়া যায়নি।</p>';
          return;
        }
        const recentItems = householdDataCache.slice(0, 5);
        dashboardRecentActivity.innerHTML = "";
        recentItems.forEach((item) => {
          const div = document.createElement("div");
          div.className =
            "px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition";
          div.innerHTML = `<div class="flex items-center"><div class="bg-blue-100 text-blue-600 p-2 rounded-full mr-4"><i data-lucide="home" class="w-5 h-5"></i></div><div><p class="text-sm font-medium text-gray-800">${
            item.commonName || "N/A"
          }</p><p class="text-xs text-gray-500">মালিক: ${
            item.ownerName
          }</p></div></div><span class="text-xs text-gray-400 whitespace-nowrap">${
            item.createdAt
              ? item.createdAt.toDate().toLocaleDateString("bn-BD")
              : ""
          }</span>`;
          dashboardRecentActivity.appendChild(div);
        });
        lucide.createIcons();
      }

      function updateAgeDemographics(allPeople) {
        let child = 0,
          adult = 0,
          senior = 0;
        const currentYear = new Date().getFullYear();
        let counted = 0;
        let volunteerCount = 0;
        allPeople.forEach((person) => {
          if (person.dob) {
            const birthYear = new Date(person.dob).getFullYear();
            const age = currentYear - birthYear;
            if (!isNaN(age)) {
              counted++;
              if (age < 18) child++;
              else if (age >= 18 && age < 60) adult++;
              else senior++;
            }
          }
          if (
            person.isDonor ||
            (person.volunteerServices && person.volunteerServices.length > 0)
          ) {
            volunteerCount++;
          }
        });
        statTotalVolunteers.textContent = volunteerCount;
        ageStatChild.textContent = 0;
        barChild.style.width = "0%";
        ageStatAdult.textContent = 0;
        barAdult.style.width = "0%";
        ageStatSenior.textContent = 0;
        barSenior.style.width = "0%";
        if (counted === 0) return;
        ageStatChild.textContent = child;
        ageStatAdult.textContent = adult;
        ageStatSenior.textContent = senior;
        const total = child + adult + senior;
        setTimeout(() => {
          barChild.style.width = `${(child / total) * 100}%`;
          barAdult.style.width = `${(adult / total) * 100}%`;
          barSenior.style.width = `${(senior / total) * 100}%`;
        }, 100);
      }

      function loadBongshos() {
        if (bongshosUnsubscribe) bongshosUnsubscribe();
        const q = query(
          collection(db, bongshosCollectionPath),
          orderBy("name", "asc")
        );
        bongshosUnsubscribe = onSnapshot(q, (snapshot) => {
          if (snapshot.empty) {
            bongshoListLoading.classList.add("hidden");
            bongshoList.innerHTML =
              '<tr><td colspan="4" class="p-4 text-center text-gray-500">কোনো বংশ যোগ করা হয়নি।</td></tr>';
            bongshoDataCache = [];
            populateBongshoDropdown([]);
            populateFilterDropdowns();
            return;
          }
          const docs = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));
          bongshoDataCache = docs;
          populateBongshoDropdown(docs);
          updateBongshoListWithCounts();
          populateFilterDropdowns();
        });
      }
      function updateBongshoListWithCounts() {
        if (!bongshoDataCache.length) return;
        const householdCounts = {};
        for (const household of householdDataCache) {
          const bongshoId = household.bongshoId;
          if (bongshoId) {
            householdCounts[bongshoId] = (householdCounts[bongshoId] || 0) + 1;
          }
        }
        const bongshosWithCounts = bongshoDataCache.map((bongsho) => ({
          ...bongsho,
          householdCount: householdCounts[bongsho.id] || 0,
        }));
        bongshoDataCache = bongshosWithCounts;
        const searchTerm = bongshoSearch.value.toLowerCase();
        const filteredDocs = bongshosWithCounts.filter((data) => {
          const name = (data.name || "").toLowerCase();
          const desc = (data.description || "").toLowerCase();
          return name.includes(searchTerm) || desc.includes(searchTerm);
        });
        renderBongshoTable(filteredDocs);
      }
      function renderBongshoTable(docs) {
        bongshoListLoading.classList.add("hidden");
        bongshoList.innerHTML = "";
        if (docs.length === 0) {
          bongshoList.innerHTML =
            '<tr><td colspan="4" class="p-4 text-center text-gray-500">কোনো ফলাফল পাওয়া যায়নি।</td></tr>';
          return;
        }
        docs.forEach((data) => {
          const docId = data.id;
          const tr = document.createElement("tr");
          tr.className = "hover:bg-gray-50";
          tr.innerHTML = `<td class="p-4 border-b font-medium text-gray-800">${
            data.name
          }</td><td class="p-4 border-b text-gray-600 max-w-sm truncate" title="${
            data.description || ""
          }">${
            data.description || "N/A"
          }</td><td class="p-4 border-b text-gray-600 font-medium">${
            data.householdCount || 0
          } টি</td><td class="p-4 border-b text-right space-x-2"><button class="bg-yellow-100 text-yellow-800 p-2 rounded-full hover:bg-yellow-200" data-action="edit" title="সম্পাদনা"><i data-lucide="pencil" class="w-5 h-5"></i></button><button class="bg-red-100 text-red-800 p-2 rounded-full hover:bg-red-200" data-action="delete" title="মুছুন"><i data-lucide="trash-2" class="w-5 h-5"></i></button></td>`;
          tr.querySelector('button[data-action="edit"]').addEventListener(
            "click",
            () => {
              openBongshoModalForEdit(docId, data);
            }
          );
          tr.querySelector('button[data-action="delete"]').addEventListener(
            "click",
            () => {
              deleteBongsho(docId, data.name);
            }
          );
          bongshoList.appendChild(tr);
        });
        lucide.createIcons();
      }
      bongshoSearch.addEventListener("input", () => {
        updateBongshoListWithCounts();
      });
      function populateBongshoDropdown(docs) {
        householdBongshoSelect.innerHTML =
          '<option value="">-- বংশ নির্বাচন করুন --</option>';
        docs.forEach((bongsho) => {
          householdBongshoSelect.innerHTML += `<option value="${bongsho.id}">${bongsho.name}</option>`;
        });
      }
      addBongshoBtn.addEventListener("click", () => {
        addBongshoForm.reset();
        bongshoModalTitle.textContent = "নতুন বংশ";
        bongshoFormSubmit.textContent = "বংশ সংরক্ষণ করুন";
        document.getElementById("bongsho-id").value = "";
        toggleModal(addBongshoModal, true);
      });
      function openBongshoModalForEdit(docId, data) {
        addBongshoForm.reset();
        bongshoModalTitle.textContent = "বংশ সম্পাদনা করুন";
        bongshoFormSubmit.textContent = "আপডেট করুন";
        document.getElementById("bongsho-id").value = docId;
        document.getElementById("bongsho-name").value = data.name;
        document.getElementById("bongsho-description").value =
          data.description || "";
        toggleModal(addBongshoModal, true);
      }
      addBongshoForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        bongshoFormSubmit.disabled = true;
        showLoader(true);
        const bongshoId = document.getElementById("bongsho-id").value;
        const data = {
          name: document.getElementById("bongsho-name").value,
          description: document.getElementById("bongsho-description").value,
          lastUpdatedAt: Timestamp.now(),
        };
        try {
          if (bongshoId) {
            await setDoc(doc(db, bongshosCollectionPath, bongshoId), data, {
              merge: true,
            });
            showToast("বংশ সফলভাবে আপডেট করা হয়েছে।");
          } else {
            data.createdAt = Timestamp.now();
            data.name_lowercase = data.name.toLowerCase();
            await addDoc(collection(db, bongshosCollectionPath), data);
            showToast("বংশ সফলভাবে পোস্ট করা হয়েছে।");
            loadDashboardStats();
          }
          toggleModal(addBongshoModal, false);
        } catch (error) {
          showToast("বংশ পোস্ট/আপডেট করার সময় ত্রুটি।", true);
        } finally {
          showLoader(false);
          bongshoFormSubmit.disabled = false;
        }
      });
      async function deleteBongsho(docId, name) {
        const bongshoToDelete = bongshoDataCache.find((b) => b.id === docId);
        showConfirmationModal(
          "বংশ মুছুন?",
          `আপনি কি "${name}" বংশটি মুছে ফেলতে নিশ্চিত?`,
          async () => {
            if (bongshoToDelete && bongshoToDelete.householdCount > 0) {
              showToast(
                `এই বংশ মোছা যাবে না। ${bongshoToDelete.householdCount} টি হোল্ডিং এখনো এই বংশের অধীনে আছে।`,
                true
              );
              return;
            }
            showLoader(true);
            try {
              await deleteDoc(doc(db, bongshosCollectionPath, docId));
              showToast("বংশ সফলভাবে মুছে ফেলা হয়েছে।");
              loadDashboardStats();
            } catch (error) {
              showToast("বংশ মোছার সময় একটি ত্রুটি হয়েছে।", true);
            } finally {
              showLoader(false);
            }
          }
        );
      }

      async function loadDropdownOptions() {
        const villagesRef = doc(
          db,
          `${configCollectionPath}/dropdowns_villages`
        );
        const relationsRef = doc(
          db,
          `${configCollectionPath}/dropdowns_relations`
        );
        onSnapshot(villagesRef, (doc) => {
          if (doc.exists()) {
            dropdownCache.villages = doc.data().options || [];
            renderDropdown("villages");
            populateFilterDropdowns();
          }
        });
        onSnapshot(relationsRef, (doc) => {
          if (doc.exists()) {
            dropdownCache.relations = doc.data().options || [];
            renderDropdown("relations");
          }
        });
      }
      function renderDropdown(type) {
        let selectElement, options, defaultText;
        if (type === "villages") {
          selectElement = householdAreaSelect;
          options = dropdownCache.villages;
          defaultText = "-- পাড়া নির্বাচন করুন --";
        } else if (type === "relations") {
          selectElement = memberRelationSelect;
          options = dropdownCache.relations;
          defaultText = "-- সম্পর্ক নির্বাচন করুন --";
        }
        if (!selectElement) return;
        const currentValue = selectElement.value;
        selectElement.innerHTML = `<option value="">${defaultText}</option>`;
        options.sort().forEach((opt) => {
          selectElement.innerHTML += `<option value="${opt}">${opt}</option>`;
        });
        if (currentValue && options.includes(currentValue)) {
          selectElement.value = currentValue;
        }
      }
      function populateFilterDropdowns() {
        const villages = dropdownCache.villages || [];
        const villageOptionsHtml =
          '<option value="">-- সব গ্রাম/পাড়া --</option>' +
          villages.map((v) => `<option value="${v}">${v}</option>`).join("");
        document.getElementById(
          "filter-household-village"
        ).innerHTML = villageOptionsHtml;
        document.getElementById(
          "filter-pop-village"
        ).innerHTML = villageOptionsHtml;
        const bongshoOptionsHtml =
          '<option value="">-- সব বংশ --</option>' +
          bongshoDataCache
            .map((b) => `<option value="${b.id}">${b.name}</option>`)
            .join("");
        document.getElementById(
          "filter-household-bongsho"
        ).innerHTML = bongshoOptionsHtml;
        const bongshoPopOptionsHtml =
          '<option value="">-- সব বংশ --</option>' +
          bongshoDataCache
            .map((b) => `<option value="${b.name}">${b.name}</option>`)
            .join("");
        document.getElementById(
          "filter-pop-bongsho"
        ).innerHTML = bongshoPopOptionsHtml;
      }
      function openDropdownModal(type) {
        currentDropdownAddingType = type;
        dropdownNewValue.value = "";
        dropdownModalTitle.textContent =
          type === "villages" ? "নতুন পাড়া যোগ করুন" : "নতুন সম্পর্ক যোগ করুন";
        dropdownInputLabel.textContent =
          type === "villages" ? "পাড়ার নাম" : "সম্পর্কের নাম";
        toggleModal(addDropdownOptionModal, true);
      }
      addAreaBtn.addEventListener("click", () => openDropdownModal("villages"));
      addRelationBtn.addEventListener("click", () =>
        openDropdownModal("relations")
      );
      dropdownCancelBtn.addEventListener("click", () =>
        toggleModal(addDropdownOptionModal, false)
      );
      dropdownAddBtn.addEventListener("click", async () => {
        const val = dropdownNewValue.value.trim();
        if (!val) {
          showToast("অনুগ্রহ করে একটি নাম লিখুন।", true);
          return;
        }
        const docId =
          currentDropdownAddingType === "villages"
            ? "dropdowns_villages"
            : "dropdowns_relations";
        const docRef = doc(db, `${configCollectionPath}/${docId}`);
        dropdownAddBtn.textContent = "যোগ করা হচ্ছে...";
        dropdownAddBtn.disabled = true;
        try {
          await setDoc(docRef, { options: arrayUnion(val) }, { merge: true });
          showToast("সফলভাবে যোগ করা হয়েছে।");
          toggleModal(addDropdownOptionModal, false);
          setTimeout(() => {
            if (currentDropdownAddingType === "villages")
              householdAreaSelect.value = val;
            else if (currentDropdownAddingType === "relations")
              memberRelationSelect.value = val;
          }, 500);
        } catch (err) {
          showToast("যোগ করার সময় ত্রুটি হয়েছে।", true);
        } finally {
          dropdownAddBtn.textContent = "যোগ করুন";
          dropdownAddBtn.disabled = false;
        }
      });

      addHouseholdBtn.addEventListener("click", () => {
        addHouseholdForm.reset();
        householdModalTitle.textContent = "নতুন হোল্ডিং যোগ করুন";
        document.getElementById("household-id").value = "";
        householdFormSubmit.textContent = "সংরক্ষণ করুন";
        toggleModal(addHouseholdModal, true);
      });
      addHouseholdForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        householdFormSubmit.disabled = true;
        showLoader(true);
        const holdingId = document.getElementById("household-id").value;
        const bongshoId = householdBongshoSelect.value;
        const bongshoName =
          householdBongshoSelect.options[householdBongshoSelect.selectedIndex]
            .text;
        const villageAreaVal = document.getElementById("household-area").value;
        const ownerOccupation = document.getElementById(
          "household-owner-occupation"
        ).value;
        const ownerBlood = document.getElementById("household-owner-blood")
          .value;
        const selectedServices = [];
        if (document.getElementById("h-vol-blood").checked)
          selectedServices.push("blood");
        if (document.getElementById("h-vol-money").checked)
          selectedServices.push("money");
        if (document.getElementById("h-vol-education").checked)
          selectedServices.push("education");
        if (document.getElementById("h-vol-health").checked)
          selectedServices.push("health");
        if (document.getElementById("h-vol-social").checked)
          selectedServices.push("social");
        const data = {
          commonName: document.getElementById("household-common-name").value,
          holdingNo: document.getElementById("household-official-no").value,
          ownerName: document.getElementById("household-owner-name").value,
          ownerFatherName: document.getElementById("household-owner-father")
            .value,
          villageArea: villageAreaVal,
          mobile: document.getElementById("household-mobile").value,
          bongshoId: bongshoId,
          bongshoName: bongshoName.includes("--") ? "" : bongshoName,
          lastUpdatedBy: currentUserId,
          lastUpdatedAt: Timestamp.now(),
        };
        try {
          let docRef;
          if (holdingId) {
            docRef = doc(db, householdsCollectionPath, holdingId);
            await setDoc(docRef, data, { merge: true });
            showToast("হোল্ডিং সফলভাবে আপডেট করা হয়েছে।");
          } else {
            const batch = writeBatch(db);
            docRef = doc(collection(db, householdsCollectionPath));
            data.createdBy = currentUserId;
            data.createdAt = Timestamp.now();
            batch.set(docRef, data);
            const newHouseholdId = docRef.id;
            const ownerAsMemberData = {
              name: data.ownerName,
              relation: "বাড়ির প্রধান",
              dob: "",
              nid: "",
              mobile: data.mobile,
              occupation: ownerOccupation,
              bloodGroup: ownerBlood,
              volunteerServices: selectedServices,
              createdAt: Timestamp.now(),
              householdId: newHouseholdId,
              commonName: data.commonName,
              householdNo: data.holdingNo,
              householdOwner: data.ownerName,
              bongshoName: data.bongshoName,
              villageArea: data.villageArea,
            };
            const allPeopleDocRef = doc(
              collection(db, allPeopleCollectionPath)
            );
            batch.set(allPeopleDocRef, ownerAsMemberData);
            ownerAsMemberData.allPeopleDocId = allPeopleDocRef.id;
            const membersSubCollRef = doc(
              collection(
                db,
                `${householdsCollectionPath}/${newHouseholdId}/members`
              )
            );
            batch.set(membersSubCollRef, ownerAsMemberData);
            await batch.commit();
            showToast("হোল্ডিং সফলভাবে যোগ করা হয়েছে।");
          }
          toggleModal(addHouseholdModal, false);
          loadDashboardStats();
        } catch (error) {
          showToast("হোল্ডিং সংরক্ষণ করার সময় ত্রুটি।", true);
        } finally {
          showLoader(false);
          householdFormSubmit.disabled = false;
        }
      });
      function loadHouseholds() {
        if (householdUnsubscribe) householdUnsubscribe();
        const q = query(
          collection(db, householdsCollectionPath),
          orderBy("createdAt", "desc")
        );
        householdUnsubscribe = onSnapshot(
          q,
          (snapshot) => {
            const docs = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            householdDataCache = docs;
            applyHouseholdFilters();
            updateBongshoListWithCounts();
            updateDashboardRecentActivity();
          },
          (error) => {
            householdListLoading.textContent = "ত্রুটি হয়েছে।";
            householdDataCache = [];
          }
        );
      }
      window.applyHouseholdFilters = function () {
        const searchTerm = document
          .getElementById("filter-household-search")
          .value.toLowerCase();
        const bongshoFilter = document.getElementById(
          "filter-household-bongsho"
        ).value;
        const villageFilter = document.getElementById(
          "filter-household-village"
        ).value;
        householdFilters = {
          search: searchTerm,
          bongsho: bongshoFilter,
          village: villageFilter,
        };
        paginationState.households.page = 1;
        renderFilteredHouseholds();
      };
      window.resetHouseholdFilters = function () {
        document.getElementById("filter-household-search").value = "";
        document.getElementById("filter-household-bongsho").value = "";
        document.getElementById("filter-household-village").value = "";
        applyHouseholdFilters();
      };
      window.changePage = function (type, delta) {
        if (type === "households") {
          paginationState.households.page += delta;
          renderFilteredHouseholds();
        } else if (type === "population") {
          paginationState.population.page += delta;
          renderFilteredPopulation();
        } else if (type === "volunteers") {
          paginationState.volunteers.page += delta;
          window.filterVolunteers(currentVolType);
        } else if (type === "notices") {
          paginationState.notices.page += delta;
          renderNoticesPage();
        }
      };
      window.changeRowsPerPage = function (type, val) {
        if (type === "households") {
          paginationState.households.limit = parseInt(val);
          paginationState.households.page = 1;
          renderFilteredHouseholds();
        } else if (type === "population") {
          paginationState.population.limit = parseInt(val);
          paginationState.population.page = 1;
          renderFilteredPopulation();
        } else if (type === "volunteers") {
          paginationState.volunteers.limit = parseInt(val);
          paginationState.volunteers.page = 1;
          window.filterVolunteers(currentVolType);
        } else if (type === "notices") {
          paginationState.notices.limit = parseInt(val);
          paginationState.notices.page = 1;
          renderNoticesPage();
        }
      };
      function renderFilteredHouseholds() {
        let filtered = householdDataCache.filter((item) => {
          const matchesSearch =
            !householdFilters.search ||
            (item.commonName || "")
              .toLowerCase()
              .includes(householdFilters.search) ||
            (item.ownerName || "")
              .toLowerCase()
              .includes(householdFilters.search) ||
            (item.mobile || "").includes(householdFilters.search) ||
            (item.holdingNo || "")
              .toLowerCase()
              .includes(householdFilters.search);
          const matchesBongsho =
            !householdFilters.bongsho ||
            item.bongshoId === householdFilters.bongsho;
          const matchesVillage =
            !householdFilters.village ||
            item.villageArea === householdFilters.village;
          return matchesSearch && matchesBongsho && matchesVillage;
        });
        filtered.sort((a, b) =>
          (a.commonName || "").localeCompare(b.commonName || "", "bn")
        );
        const totalItems = filtered.length;
        const { page, limit } = paginationState.households;
        const totalPages = Math.ceil(totalItems / limit) || 1;
        if (paginationState.households.page > totalPages)
          paginationState.households.page = totalPages;
        if (paginationState.households.page < 1)
          paginationState.households.page = 1;
        const currentPage = paginationState.households.page;
        const startIndex = (currentPage - 1) * limit;
        const endIndex = startIndex + limit;
        const paginatedData = filtered.slice(startIndex, endIndex);
        document.getElementById(
          "pagination-info-household"
        ).textContent = `Showing ${
          totalItems === 0 ? 0 : startIndex + 1
        } to ${Math.min(endIndex, totalItems)} of ${totalItems} entries`;
        document.getElementById(
          "page-display-household"
        ).textContent = currentPage;
        document.getElementById("prev-btn-household").disabled =
          currentPage === 1;
        document.getElementById("next-btn-household").disabled =
          currentPage === totalPages;
        renderHouseholdCards(paginatedData);
      }
      function renderHouseholdCards(docs) {
        householdList.innerHTML = "";
        if (docs.length === 0) {
          householdList.innerHTML =
            '<p class="text-center text-gray-500 py-4">কোনো ফলাফল পাওয়া যায়নি।</p>';
          return;
        }
        docs.forEach((data) => {
          const card = document.createElement("div");
          card.className = "household-card bg-white rounded-lg shadow-md p-5";
          card.dataset.id = data.id;
          card.innerHTML = `<div class="flex flex-col sm:flex-row justify-between items-start gap-4"><div class="cursor-pointer flex-1" data-action="details"><h3 class="text-xl font-semibold text-blue-700">${
            data.commonName || "N/A"
          }</h3><p class="text-gray-800 font-medium">প্রধান: ${
            data.ownerName
          }</p><p class="text-sm text-gray-600">বংশ: ${
            data.bongshoName || "N/A"
          }</p><p class="text-sm text-gray-600">অফিসিয়াল হোল্ডিং নং: ${
            data.holdingNo || "N/A"
          }</p><p class="text-gray-600">পিতা: ${
            data.ownerFatherName || "N/A"
          }</p><p class="text-gray-600">পাড়া: ${
            data.villageArea || "N/A"
          }</p>${
            data.mobile
              ? `<p class="text-gray-500 text-sm">মোবাইল: ${data.mobile}</p>`
              : ""
          }</div><div class="flex gap-2 items-center flex-shrink-0"><button class="bg-yellow-100 text-yellow-800 p-2 rounded-full hover:bg-yellow-200" data-action="edit" title="সম্পাদনা"><i data-lucide="pencil" class="w-5 h-5"></i></button><button class="bg-red-100 text-red-800 p-2 rounded-full hover:bg-red-200" data-action="delete" title="মুছুন"><i data-lucide="trash-2" class="w-5 h-5"></i></button></div></div>`;
          card.addEventListener("click", (e) => {
            const actionEl = e.target.closest("[data-action]");
            if (actionEl) {
              const action = actionEl.dataset.action;
              if (action === "edit") {
                openHouseholdModalForEdit(data.id, data);
              } else if (action === "delete") {
                deleteHousehold(data.id, data.commonName, data.holdingNo);
              } else if (action === "details") {
                openHouseholdDetails(data);
              }
            }
          });
          householdList.appendChild(card);
        });
        lucide.createIcons();
      }
      function openHouseholdModalForEdit(docId, data) {
        addHouseholdForm.reset();
        householdModalTitle.textContent = "হোল্ডিং সম্পাদনা করুন";
        householdFormSubmit.textContent = "আপডেট করুন";
        document.getElementById("household-id").value = docId;
        document.getElementById("household-common-name").value =
          data.commonName || "";
        document.getElementById("household-official-no").value =
          data.holdingNo || "";
        document.getElementById("household-owner-name").value =
          data.ownerName || "";
        document.getElementById("household-owner-father").value =
          data.ownerFatherName || "";
        document.getElementById("household-area").value =
          data.villageArea || "";
        document.getElementById("household-mobile").value = data.mobile || "";
        document.getElementById("household-bongsho").value =
          data.bongshoId || "";
        document.getElementById("household-owner-occupation").value = "";
        document.getElementById("household-owner-blood").value = "";
        document
          .querySelectorAll('#add-household-form input[type="checkbox"]')
          .forEach((cb) => (cb.checked = false));
        toggleModal(addHouseholdModal, true);
      }
      function deleteHousehold(docId, commonName, holdingNo) {
        showConfirmationModal(
          "হোল্ডিং মুছুন?",
          `আপনি কি "${commonName}" হোল্ডিংটি মুছে ফেলতে নিশ্চিত?`,
          async () => {
            showLoader(true);
            try {
              const batch = writeBatch(db);
              const membersPath = `${householdsCollectionPath}/${docId}/members`;
              const membersQuery = query(collection(db, membersPath));
              const membersSnapshot = await getDocs(membersQuery);
              const allPeopleIdsToDelete = [];
              membersSnapshot.forEach((memberDoc) => {
                batch.delete(memberDoc.ref);
                const allPeopleId = memberDoc.data().allPeopleDocId;
                if (allPeopleId) {
                  allPeopleIdsToDelete.push(allPeopleId);
                }
              });
              allPeopleIdsToDelete.forEach((peopleId) => {
                batch.delete(doc(db, allPeopleCollectionPath, peopleId));
              });
              batch.delete(doc(db, householdsCollectionPath, docId));
              await batch.commit();
              showToast("হোল্ডিং মুছে ফেলা হয়েছে।");
              loadDashboardStats();
            } catch (error) {
              showToast("ত্রুটি হয়েছে।", true);
            } finally {
              showLoader(false);
            }
          }
        );
      }

      function openHouseholdDetails(dataset) {
        currentHouseholdId = dataset.id;
        currentHouseholdData = dataset;
        detailCommonName.textContent = dataset.commonName || "N/A";
        detailHoldingNo.textContent = dataset.holdingNo || "N/A";
        detailBongshoName.textContent = dataset.bongshoName || "N/A";
        detailOwnerName.textContent = dataset.ownerName || "N/A";
        detailOwnerFather.textContent = dataset.ownerFatherName || "N/A";
        detailArea.textContent = dataset.villageArea || "N/A";
        detailMobile.textContent = dataset.mobile || "N/A";
        detailsModalTitle.textContent = `${dataset.commonName}-এর হোল্ডিং বিবরণ`;
        toggleModal(householdDetailsModal, true);
        loadFamilyMembers(currentHouseholdId);
      }
      detailsEditHouseholdBtn.addEventListener("click", () => {
        toggleModal(householdDetailsModal, false);
        openHouseholdModalForEdit(currentHouseholdId, currentHouseholdData);
      });
      function loadFamilyMembers(householdId) {
        if (familyMemberUnsubscribe) familyMemberUnsubscribe();
        familyMemberList.innerHTML = "";
        familyMemberList.appendChild(familyListLoading);
        familyListLoading.textContent = "লোড হচ্ছে...";
        const membersPath = `${householdsCollectionPath}/${householdId}/members`;
        const q = query(
          collection(db, membersPath),
          orderBy("createdAt", "asc")
        );
        familyMemberUnsubscribe = onSnapshot(q, (snapshot) => {
          familyMemberList.innerHTML = "";
          if (snapshot.empty) {
            familyMemberList.innerHTML =
              '<p class="text-center text-gray-500 py-3">সদস্য নেই।</p>';
            return;
          }
          snapshot.docs.forEach((doc) => {
            const data = doc.data();
            const docId = doc.id;
            let badges = "";
            if (data.bloodGroup) {
              badges += `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 mt-1 mr-1">🩸 ${data.bloodGroup}</span>`;
            }
            if (data.volunteerServices && data.volunteerServices.length > 0) {
              data.volunteerServices.forEach((s) => {
                if (s === "blood")
                  badges += `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-red-50 text-red-600 mt-1 mr-1 border border-red-200">রক্তদান</span>`;
                if (s === "money")
                  badges += `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-green-50 text-green-600 mt-1 mr-1 border border-green-200">আর্থিক</span>`;
                if (s === "education")
                  badges += `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-blue-50 text-blue-600 mt-1 mr-1 border border-blue-200">শিক্ষা</span>`;
                if (s === "health")
                  badges += `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-cyan-50 text-cyan-600 mt-1 mr-1 border border-cyan-200">চিকিৎসা</span>`;
                if (s === "social")
                  badges += `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-orange-50 text-orange-600 mt-1 mr-1 border border-orange-200">সামাজিক</span>`;
              });
            } else if (data.isDonor) {
              badges += `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800 mt-1">রক্তদাতা</span>`;
            }
            const div = document.createElement("div");
            div.className =
              "bg-gray-100 rounded-md p-4 flex justify-between items-start";
            div.innerHTML = `<div><h5 class="font-semibold text-gray-800">${
              data.name
            }</h5><p class="text-sm text-gray-600">সম্পর্ক: ${
              data.relation
            }</p><p class="text-sm text-gray-600">NID: ${
              data.nid || "N/A"
            }</p><p class="text-sm text-gray-600">জন্ম তারিখ: ${
              data.dob || "N/A"
            }</p>${
              data.mobile
                ? `<p class="text-sm text-gray-500">মোবাইল: ${data.mobile}</p>`
                : ""
            }<div class="flex flex-wrap mt-1">${badges}</div></div><div class="flex gap-2 flex-shrink-0"><button class="bg-yellow-100 text-yellow-800 p-2 rounded-full hover:bg-yellow-200" data-action="edit" title="সম্পাদনা"><i data-lucide="pencil" class="w-4 h-4"></i></button><button class="bg-red-100 text-red-800 p-2 rounded-full hover:bg-red-200" data-action="delete" title="মুছুন"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`;
            div
              .querySelector('button[data-action="edit"]')
              .addEventListener("click", () => {
                openMemberModalForEdit(docId, data);
              });
            div
              .querySelector('button[data-action="delete"]')
              .addEventListener("click", () => {
                deleteFamilyMember(householdId, docId, data);
              });
            familyMemberList.appendChild(div);
          });
          lucide.createIcons();
        });
      }

      openAddMemberModalBtn.addEventListener("click", () => {
        addMemberForm.reset();
        memberModalTitle.textContent = "নতুন পরিবারের সদস্য";
        memberFormSubmit.textContent = "সদস্য সংরক্ষণ করুন";
        document.getElementById("member-id").value = "";
        toggleModal(addMemberModal, true);
      });
      function openMemberModalForEdit(memberId, data) {
        addMemberForm.reset();
        memberModalTitle.textContent = "সদস্যের তথ্য সম্পাদনা";
        memberFormSubmit.textContent = "আপডেট করুন";
        document.getElementById("member-id").value = memberId;
        document.getElementById("member-name").value = data.name || "";
        document.getElementById("member-relation").value = data.relation || "";
        document.getElementById("member-dob").value = data.dob || "";
        document.getElementById("member-nid").value = data.nid || "";
        document.getElementById("member-mobile").value = data.mobile || "";
        document.getElementById("member-occupation").value =
          data.occupation || "";
        document.getElementById("member-blood").value = data.bloodGroup || "";
        if (data.volunteerServices) {
          document.getElementById(
            "vol-blood"
          ).checked = data.volunteerServices.includes("blood");
          document.getElementById(
            "vol-money"
          ).checked = data.volunteerServices.includes("money");
          document.getElementById(
            "vol-education"
          ).checked = data.volunteerServices.includes("education");
          document.getElementById(
            "vol-health"
          ).checked = data.volunteerServices.includes("health");
          document.getElementById(
            "vol-social"
          ).checked = data.volunteerServices.includes("social");
        } else if (data.isDonor) {
          document.getElementById("vol-blood").checked = true;
        }
        toggleModal(addMemberModal, true);
      }
      addMemberForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        memberFormSubmit.disabled = true;
        showLoader(true);
        if (!currentHouseholdId) {
          showToast("ত্রুটি হয়েছে।", true);
          showLoader(false);
          memberFormSubmit.disabled = false;
          return;
        }
        const memberId = document.getElementById("member-id").value;
        const selectedServices = [];
        if (document.getElementById("vol-blood").checked)
          selectedServices.push("blood");
        if (document.getElementById("vol-money").checked)
          selectedServices.push("money");
        if (document.getElementById("vol-education").checked)
          selectedServices.push("education");
        if (document.getElementById("vol-health").checked)
          selectedServices.push("health");
        if (document.getElementById("vol-social").checked)
          selectedServices.push("social");
        const memberData = {
          name: document.getElementById("member-name").value,
          relation: document.getElementById("member-relation").value,
          dob: document.getElementById("member-dob").value,
          nid: document.getElementById("member-nid").value,
          mobile: document.getElementById("member-mobile").value,
          occupation: document.getElementById("member-occupation").value,
          bloodGroup: document.getElementById("member-blood").value,
          volunteerServices: selectedServices,
        };
        try {
          const householdDataSnap = await getDoc(
            doc(db, householdsCollectionPath, currentHouseholdId)
          );
          const householdData = householdDataSnap.data();
          const allPeopleData = {
            name: memberData.name,
            nid: memberData.nid,
            mobile: memberData.mobile,
            householdId: currentHouseholdId,
            commonName: householdData?.commonName || "N/A",
            householdNo: householdData?.holdingNo || "N/A",
            householdOwner: householdData?.ownerName || "N/A",
            bongshoName: householdData?.bongshoName || "N/A",
            villageArea: householdData?.villageArea || "N/A",
            dob: memberData.dob,
            occupation: memberData.occupation,
            bloodGroup: memberData.bloodGroup,
            volunteerServices: memberData.volunteerServices,
          };
          if (memberId) {
            memberData.lastUpdatedAt = Timestamp.now();
            const memberDocRef = doc(
              db,
              `${householdsCollectionPath}/${currentHouseholdId}/members`,
              memberId
            );
            const existingMemberDoc = await getDoc(memberDocRef);
            const allPeopleDocId = existingMemberDoc.data()?.allPeopleDocId;
            const batch = writeBatch(db);
            batch.update(memberDocRef, memberData);
            if (allPeopleDocId) {
              const allPeopleDocRef = doc(
                db,
                allPeopleCollectionPath,
                allPeopleDocId
              );
              batch.update(allPeopleDocRef, allPeopleData);
            }
            await batch.commit();
            showToast("আপডেট করা হয়েছে।");
          } else {
            memberData.createdAt = Timestamp.now();
            const allPeopleDocRef = await addDoc(
              collection(db, allPeopleCollectionPath),
              allPeopleData
            );
            memberData.allPeopleDocId = allPeopleDocRef.id;
            const membersPath = `${householdsCollectionPath}/${currentHouseholdId}/members`;
            await addDoc(collection(db, membersPath), memberData);
            showToast("সদস্য যোগ করা হয়েছে।");
            loadDashboardStats();
          }
          toggleModal(addMemberModal, false);
        } catch (error) {
          showToast("ত্রুটি হয়েছে।", true);
        } finally {
          showLoader(false);
          memberFormSubmit.disabled = false;
        }
      });
      async function deleteFamilyMember(householdId, memberId, memberData) {
        showConfirmationModal(
          "সদস্য মুছুন?",
          `আপনি কি "${memberData.name}"-কে মুছতে নিশ্চিত?`,
          async () => {
            showLoader(true);
            try {
              const batch = writeBatch(db);
              const memberDocRef = doc(
                db,
                `${householdsCollectionPath}/${householdId}/members`,
                memberId
              );
              batch.delete(memberDocRef);
              if (memberData.allPeopleDocId) {
                const allPeopleDocRef = doc(
                  db,
                  allPeopleCollectionPath,
                  memberData.allPeopleDocId
                );
                batch.delete(allPeopleDocRef);
              } else {
                const q = query(
                  collection(db, allPeopleCollectionPath),
                  where("householdId", "==", householdId),
                  where("nid", "==", memberData.nid),
                  where("name", "==", memberData.name)
                );
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                  batch.delete(querySnapshot.docs[0].ref);
                }
              }
              await batch.commit();
              showToast("সদস্য মুছে ফেলা হয়েছে।");
              loadDashboardStats();
            } catch (error) {
              showToast("ত্রুটি হয়েছে।", true);
            } finally {
              showLoader(false);
            }
          }
        );
      }

      // --- Volunteer Logic ---
      window.filterVolunteers = function (type) {
        currentVolType = type;
        document
          .querySelectorAll("#volunteer-filters button")
          .forEach((btn) => {
            if (btn.dataset.type === type) {
              btn.classList.remove("bg-white", "text-gray-600");
              btn.classList.add("bg-blue-600", "text-white");
              btn.className = btn.className.replace(
                /border-\w+-200/g,
                "border-blue-600"
              );
              btn.className = btn.className.replace(
                /text-\w+-600/g,
                "text-white"
              );
            } else {
              btn.classList.add("bg-white");
              btn.classList.remove("bg-blue-600", "text-white");
              const t = btn.dataset.type;
              let colorClass = "text-gray-600";
              if (t === "blood") colorClass = "text-red-600";
              if (t === "money") colorClass = "text-green-600";
              if (t === "education") colorClass = "text-blue-600";
              if (t === "health") colorClass = "text-cyan-600";
              if (t === "social") colorClass = "text-orange-600";
              btn.className = `px-4 py-2 rounded-full border bg-white ${colorClass} hover:bg-gray-50 transition shadow-sm flex items-center gap-2`;
              if (t === "blood") btn.classList.add("border-red-200");
              else if (t === "money") btn.classList.add("border-green-200");
              else if (t === "education") btn.classList.add("border-blue-200");
              else if (t === "health") btn.classList.add("border-cyan-200");
              else if (t === "social") btn.classList.add("border-orange-200");
              else btn.classList.add("border-gray-300");
            }
          });
        applyVolunteerFilters();
      };

      window.applyVolunteerFilters = function () {
        const selectedBlood = document.getElementById("filter-vol-blood-group")
          .value;
        let volunteers = [];

        // Filter by Service Type
        if (currentVolType === "all") {
          volunteers = populationDataCache.filter(
            (p) =>
              (p.volunteerServices && p.volunteerServices.length > 0) ||
              p.isDonor
          );
        } else {
          volunteers = populationDataCache.filter((p) => {
            if (
              p.volunteerServices &&
              p.volunteerServices.includes(currentVolType)
            )
              return true;
            if (currentVolType === "blood" && p.isDonor) return true;
            return false;
          });
        }

        // Filter by Blood Group
        if (selectedBlood) {
          volunteers = volunteers.filter((v) => v.bloodGroup === selectedBlood);
        }

        // Pagination
        const totalItems = volunteers.length;
        const { page, limit } = paginationState.volunteers;
        const totalPages = Math.ceil(totalItems / limit) || 1;
        if (paginationState.volunteers.page > totalPages)
          paginationState.volunteers.page = totalPages;
        if (paginationState.volunteers.page < 1)
          paginationState.volunteers.page = 1;
        const currentPage = paginationState.volunteers.page;
        const startIndex = (currentPage - 1) * limit;
        const endIndex = startIndex + limit;
        const paginatedData = volunteers.slice(startIndex, endIndex);

        document.getElementById(
          "pagination-info-volunteers"
        ).textContent = `Showing ${
          totalItems === 0 ? 0 : startIndex + 1
        } to ${Math.min(endIndex, totalItems)} of ${totalItems} entries`;
        document.getElementById(
          "page-display-volunteers"
        ).textContent = currentPage;
        document.getElementById("prev-btn-volunteers").disabled =
          currentPage === 1;
        document.getElementById("next-btn-volunteers").disabled =
          currentPage === totalPages;

        renderVolunteerGrid(paginatedData);
      };

      function renderVolunteerGrid(volunteers) {
        volunteerGrid.innerHTML = "";
        if (volunteers.length === 0) {
          volunteerGrid.innerHTML =
            '<p class="col-span-full text-center text-gray-500 py-8">কোনো স্বেচ্ছাসেবী পাওয়া যায়নি।</p>';
          return;
        }
        volunteers.forEach((v) => {
          let badges = "";
          if (v.volunteerServices) {
            v.volunteerServices.forEach((s) => {
              if (s === "blood")
                badges += `<span class="inline-block px-2 py-1 rounded-full bg-red-100 text-red-600 text-xs mr-1 mb-1">রক্তদান</span>`;
              if (s === "money")
                badges += `<span class="inline-block px-2 py-1 rounded-full bg-green-100 text-green-600 text-xs mr-1 mb-1">আর্থিক</span>`;
              if (s === "education")
                badges += `<span class="inline-block px-2 py-1 rounded-full bg-blue-100 text-blue-600 text-xs mr-1 mb-1">শিক্ষা</span>`;
              if (s === "health")
                badges += `<span class="inline-block px-2 py-1 rounded-full bg-cyan-100 text-cyan-600 text-xs mr-1 mb-1">চিকিৎসা</span>`;
              if (s === "social")
                badges += `<span class="inline-block px-2 py-1 rounded-full bg-orange-100 text-orange-600 text-xs mr-1 mb-1">সামাজিক</span>`;
            });
          } else if (v.isDonor) {
            badges += `<span class="inline-block px-2 py-1 rounded-full bg-red-100 text-red-600 text-xs mr-1 mb-1">রক্তদান</span>`;
          }
          let bgIcon = "hand-heart";
          if (v.volunteerServices) {
            if (v.volunteerServices.includes("blood")) bgIcon = "droplet";
            else if (v.volunteerServices.includes("money")) bgIcon = "banknote";
            else if (v.volunteerServices.includes("education"))
              bgIcon = "book-open";
          }
          const card = document.createElement("div");
          card.className =
            "bg-white rounded-lg shadow-md p-5 border-t-4 border-blue-500 flex flex-col items-center text-center relative overflow-hidden transition hover:shadow-lg";
          card.innerHTML = `<div class="absolute top-[-10px] right-[-10px] text-gray-100 transform rotate-12"><i data-lucide="${bgIcon}" class="w-24 h-24 opacity-30"></i></div><div class="w-16 h-16 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-2xl font-bold mb-3 shadow-sm border-2 border-white z-10">${v.name.charAt(
            0
          )}</div><h3 class="text-lg font-bold text-gray-800 z-10 relative">${
            v.name
          }</h3><p class="text-sm text-gray-500 mb-1 z-10 relative">${
            v.villageArea || "গ্রাম অজানা"
          }</p>${
            v.bloodGroup
              ? `<span class="mb-2 text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded z-10 relative">🩸 ${v.bloodGroup}</span>`
              : ""
          }<div class="flex flex-wrap justify-center gap-1 mb-4 w-full z-10 relative">${badges}</div>${
            v.mobile
              ? `<a href="tel:${v.mobile}" class="mt-auto inline-flex items-center justify-center w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition gap-2 z-10 relative"><i data-lucide="phone" class="w-4 h-4"></i> কল করুন</a>`
              : `<span class="mt-auto text-gray-400 text-sm italic z-10 relative">মোবাইল নম্বর নেই</span>`
          }`;
          volunteerGrid.appendChild(card);
        });
        lucide.createIcons();
      }

      function loadAllPeople() {
        if (populationUnsubscribe) populationUnsubscribe();
        const q = query(collection(db, allPeopleCollectionPath));
        populationUnsubscribe = onSnapshot(
          q,
          (snapshot) => {
            if (snapshot.empty) {
              populationList.innerHTML =
                '<tr><td colspan="4" class="p-4 text-center text-gray-500">জনগণ নেই।</td></tr>';
              populationDataCache = [];
              updateAgeDemographics([]);
              return;
            }
            populationDataCache = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            applyPopulationFilters();
            updateAgeDemographics(populationDataCache);
            if (
              !document
                .getElementById("page-volunteers")
                .classList.contains("hidden")
            ) {
              window.filterVolunteers(currentVolType);
            }
          },
          (error) => {
            populationListLoading.classList.add("hidden");
          }
        );
      }
      window.applyPopulationFilters = function () {
        const searchTerm = document
          .getElementById("filter-pop-search")
          .value.toLowerCase();
        const ageMin = document.getElementById("filter-pop-age-min").value;
        const ageMax = document.getElementById("filter-pop-age-max").value;
        const village = document.getElementById("filter-pop-village").value;
        const bongsho = document.getElementById("filter-pop-bongsho").value;
        populationFilters = {
          search: searchTerm,
          ageMin: ageMin,
          ageMax: ageMax,
          village: village,
          bongsho: bongsho,
        };
        paginationState.population.page = 1;
        renderFilteredPopulation();
      };
      window.resetPopulationFilters = function () {
        document.getElementById("filter-pop-search").value = "";
        document.getElementById("filter-pop-age-min").value = "";
        document.getElementById("filter-pop-age-max").value = "";
        document.getElementById("filter-pop-village").value = "";
        document.getElementById("filter-pop-bongsho").value = "";
        applyPopulationFilters();
      };
      function renderFilteredPopulation() {
        const currentYear = new Date().getFullYear();
        let filtered = populationDataCache.filter((item) => {
          const matchesSearch =
            !populationFilters.search ||
            (item.name || "")
              .toLowerCase()
              .includes(populationFilters.search) ||
            (item.nid || "").toLowerCase().includes(populationFilters.search) ||
            (item.mobile || "").includes(populationFilters.search);
          const matchesVillage =
            !populationFilters.village ||
            item.villageArea === populationFilters.village;
          const matchesBongsho =
            !populationFilters.bongsho ||
            item.bongshoName === populationFilters.bongsho;
          let matchesAge = true;
          if (populationFilters.ageMin || populationFilters.ageMax) {
            if (!item.dob) matchesAge = false;
            else {
              const birthYear = new Date(item.dob).getFullYear();
              const age = currentYear - birthYear;
              if (
                populationFilters.ageMin &&
                age < parseInt(populationFilters.ageMin)
              )
                matchesAge = false;
              if (
                populationFilters.ageMax &&
                age > parseInt(populationFilters.ageMax)
              )
                matchesAge = false;
            }
          }
          return (
            matchesSearch && matchesVillage && matchesAge && matchesBongsho
          );
        });
        filtered.sort((a, b) =>
          (a.name || "").localeCompare(b.name || "", "bn")
        );
        const totalItems = filtered.length;
        const { page, limit } = paginationState.population;
        const totalPages = Math.ceil(totalItems / limit) || 1;
        if (paginationState.population.page > totalPages)
          paginationState.population.page = totalPages;
        if (paginationState.population.page < 1)
          paginationState.population.page = 1;
        const currentPage = paginationState.population.page;
        const startIndex = (currentPage - 1) * limit;
        const endIndex = startIndex + limit;
        const paginatedData = filtered.slice(startIndex, endIndex);
        document.getElementById(
          "pagination-info-population"
        ).textContent = `Showing ${
          totalItems === 0 ? 0 : startIndex + 1
        } to ${Math.min(endIndex, totalItems)} of ${totalItems} entries`;
        document.getElementById(
          "page-display-population"
        ).textContent = currentPage;
        document.getElementById("prev-btn-population").disabled =
          currentPage === 1;
        document.getElementById("next-btn-population").disabled =
          currentPage === totalPages;
        renderPopulationTableRows(paginatedData);
      }
      function renderPopulationTableRows(data) {
        populationList.innerHTML = "";
        if (data.length === 0) {
          populationList.innerHTML =
            '<tr><td colspan="5" class="p-4 text-center text-gray-500">কোনো ফলাফল পাওয়া যায়নি।</td></tr>';
          return;
        }
        data.forEach((data) => {
          const row = document.createElement("tr");
          row.className =
            "population-row border-b hover:bg-gray-50 cursor-pointer";
          row.innerHTML = `<td class="p-4 font-medium text-gray-800">${
            data.name
          }</td><td class="p-4 text-gray-600 hidden md:table-cell">${
            data.occupation
              ? `<div class="text-sm font-semibold">${data.occupation}</div>`
              : ""
          }<div class="flex items-center mt-1">${
            data.bloodGroup
              ? `<span class="text-xs font-bold text-red-600 bg-red-50 px-1 rounded mr-2">🩸 ${data.bloodGroup}</span>`
              : ""
          }</div></td><td class="p-4 text-gray-600 hidden md:table-cell">${
            data.nid || "N/A"
          }</td><td class="p-4 text-gray-600 hidden md:table-cell">${
            data.mobile || "N/A"
          }</td><td class="p-4 text-sm text-blue-600">${
            data.commonName || data.householdOwner || "N/A"
          }<br><span class="text-xs text-gray-500">${
            data.bongshoName || "N/A"
          }</span></td>`;
          row.addEventListener("click", async () => {
            showLoader(true);
            try {
              if (!data.householdId) {
                throw new Error("ID missing");
              }
              const householdDoc = await getDoc(
                doc(db, householdsCollectionPath, data.householdId)
              );
              if (householdDoc.exists()) {
                openHouseholdDetails({
                  id: householdDoc.id,
                  ...householdDoc.data(),
                });
              } else {
                showToast("পাওয়া যায়নি।", true);
              }
            } catch (err) {
              showToast("ত্রুটি।", true);
            } finally {
              showLoader(false);
            }
          });
          populationList.appendChild(row);
        });
        lucide.createIcons();
      }

      // Notices
      addNoticeBtn.addEventListener("click", () => {
        addNoticeForm.reset();
        noticeModalTitle.textContent = "নতুন নোটিশ";
        noticeFormSubmit.textContent = "নোটিশ পোস্ট করুন";
        document.getElementById("notice-id").value = "";
        toggleModal(addNoticeModal, true);
      });
      function openNoticeModalForEdit(docId, data) {
        addNoticeForm.reset();
        noticeModalTitle.textContent = "নোটিশ সম্পাদনা করুন";
        noticeFormSubmit.textContent = "আপডেট করুন";
        document.getElementById("notice-id").value = docId;
        document.getElementById("notice-title").value = data.title;
        document.getElementById("notice-details").value = data.details;
        toggleModal(addNoticeModal, true);
      }
      addNoticeForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        noticeFormSubmit.disabled = true;
        showLoader(true);
        const noticeId = document.getElementById("notice-id").value;
        const data = {
          title: document.getElementById("notice-title").value,
          details: document.getElementById("notice-details").value,
          lastUpdatedAt: Timestamp.now(),
          postedBy: currentUserId,
        };
        try {
          if (noticeId) {
            await setDoc(doc(db, noticesCollectionPath, noticeId), data, {
              merge: true,
            });
            showToast("নোটিশ আপডেট করা হয়েছে।");
          } else {
            data.date = Timestamp.now();
            await addDoc(collection(db, noticesCollectionPath), data);
            showToast("নোটিশ পোস্ট করা হয়েছে।");
            loadDashboardStats();
          }
          toggleModal(addNoticeModal, false);
        } catch (error) {
          showToast("ত্রুটি হয়েছে।", true);
        } finally {
          showLoader(false);
          noticeFormSubmit.disabled = false;
        }
      });
      function loadNotices() {
        if (noticesUnsubscribe) noticesUnsubscribe();
        const q = query(
          collection(db, noticesCollectionPath),
          orderBy("date", "desc")
        );
        noticesUnsubscribe = onSnapshot(
          q,
          (snapshot) => {
            if (snapshot.empty) {
              noticeList.innerHTML =
                '<p class="text-center text-gray-500 py-4 col-span-full">কোনো নোটিশ নেই।</p>';
              noticesDataCache = [];
              return;
            }
            noticesDataCache = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            renderNoticesPage();
          },
          (error) => {
            noticeList.innerHTML =
              '<p class="text-center text-red-500 py-4 col-span-full">ত্রুটি হয়েছে।</p>';
          }
        );
      }

      function renderNoticesPage() {
        const totalItems = noticesDataCache.length;
        const { page, limit } = paginationState.notices;
        const totalPages = Math.ceil(totalItems / limit) || 1;

        if (paginationState.notices.page > totalPages)
          paginationState.notices.page = totalPages;
        if (paginationState.notices.page < 1) paginationState.notices.page = 1;

        const currentPage = paginationState.notices.page;
        const startIndex = (currentPage - 1) * limit;
        const endIndex = startIndex + limit;
        const paginatedData = noticesDataCache.slice(startIndex, endIndex);

        noticeList.innerHTML = "";
        paginatedData.forEach((data) => {
          const item = document.createElement("div");
          item.className =
            "bg-white rounded-lg shadow-md p-5 notice-card relative border border-gray-100";
          item.innerHTML = `
                <i data-lucide="pin" class="w-5 h-5 notice-pin"></i>
                <div class="flex justify-between items-start gap-4">
                    <div class="flex-1">
                        <h4 class="text-xl font-bold text-gray-800 mb-2 pr-6">${
                          data.title
                        }</h4>
                        <div class="flex items-center mb-3">
                            <span class="bg-blue-50 text-blue-600 text-xs font-medium px-2.5 py-0.5 rounded flex items-center">
                                <i data-lucide="calendar" class="w-3 h-3 mr-1"></i>
                                ${
                                  data.date
                                    ? data.date
                                        .toDate()
                                        .toLocaleDateString("bn-BD")
                                    : ""
                                }
                            </span>
                        </div>
                        <div class="text-gray-600 whitespace-pre-wrap leading-relaxed text-sm relative">
                           <p class="notice-text line-clamp-3" id="notice-text-${
                             data.id
                           }">${data.details}</p>
                           ${
                             data.details.length > 150
                               ? `<button class="text-blue-600 text-xs mt-1 font-medium hover:underline" onclick="toggleNoticeExpand('${data.id}')" id="btn-expand-${data.id}">আরো পড়ুন</button>`
                               : ""
                           }
                        </div>
                    </div>
                    <div class="flex flex-col gap-2 flex-shrink-0">
                        <button class="bg-yellow-50 text-yellow-600 p-2 rounded-full hover:bg-yellow-100 transition" data-action="edit" title="সম্পাদনা">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                         <button class="bg-red-50 text-red-600 p-2 rounded-full hover:bg-red-100 transition" data-action="delete" title="মুছুন">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
              `;
          item
            .querySelector('button[data-action="edit"]')
            .addEventListener("click", () => {
              openNoticeModalForEdit(data.id, data);
            });
          item
            .querySelector('button[data-action="delete"]')
            .addEventListener("click", () => {
              deleteNotice(data.id, data.title);
            });
          noticeList.appendChild(item);
        });

        // Update Pagination UI
        document.getElementById(
          "pagination-info-notices"
        ).textContent = `Showing ${
          totalItems === 0 ? 0 : startIndex + 1
        } to ${Math.min(endIndex, totalItems)} of ${totalItems} entries`;
        document.getElementById(
          "page-display-notices"
        ).textContent = currentPage;
        document.getElementById("prev-btn-notices").disabled =
          currentPage === 1;
        document.getElementById("next-btn-notices").disabled =
          currentPage === totalPages;

        lucide.createIcons();
      }

      window.toggleNoticeExpand = function (id) {
        const textEl = document.getElementById(`notice-text-${id}`);
        const btnEl = document.getElementById(`btn-expand-${id}`);
        if (textEl.classList.contains("line-clamp-3")) {
          textEl.classList.remove("line-clamp-3");
          btnEl.textContent = "সংক্ষিপ্ত করুন";
        } else {
          textEl.classList.add("line-clamp-3");
          btnEl.textContent = "আরো পড়ুন";
        }
      };

      function deleteNotice(docId, title) {
        showConfirmationModal(
          "নোটিশ মুছুন?",
          `আপনি কি "${title}" নোটিশটি মুছতে নিশ্চিত?`,
          async () => {
            showLoader(true);
            try {
              await deleteDoc(doc(db, noticesCollectionPath, docId));
              showToast("মুছে ফেলা হয়েছে।");
              loadDashboardStats();
            } catch (error) {
              showToast("ত্রুটি হয়েছে।", true);
            } finally {
              showLoader(false);
            }
          }
        );
      }

      async function loadAdminInfo() {
        try {
          const docRef = doc(db, adminDocPath);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById("admin-chairman-name").value =
              data.chairmanName || "";
            document.getElementById("admin-chairman-mobile").value =
              data.chairmanMobile || "";
            document.getElementById("admin-member-name").value =
              data.memberName || "";
            document.getElementById("admin-member-mobile").value =
              data.memberMobile || "";
            document.getElementById("admin-police-name").value =
              data.policeName || "";
            document.getElementById("admin-police-mobile").value =
              data.policeMobile || "";
            dashAdminChairman.textContent = data.chairmanName || "তথ্য নেই";
            dashAdminChairmanCall.textContent = data.chairmanMobile || "";
            dashAdminChairmanCall.href = data.chairmanMobile
              ? `tel:${data.chairmanMobile}`
              : "#";
            dashAdminMember.textContent = data.memberName || "তথ্য নেই";
            dashAdminMemberCall.textContent = data.memberMobile || "";
            dashAdminMemberCall.href = data.memberMobile
              ? `tel:${data.memberMobile}`
              : "#";
            dashAdminPolice.textContent = data.policeName || "তথ্য নেই";
            dashAdminPoliceCall.textContent = data.policeMobile || "";
            dashAdminPoliceCall.href = data.policeMobile
              ? `tel:${data.policeMobile}`
              : "#";
          }
        } catch (error) {
          showToast("লোড করা যায়নি।", true);
        }
      }
      adminInfoForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        adminSubmitBtn.disabled = true;
        showLoader(true);
        const data = {
          chairmanName: document.getElementById("admin-chairman-name").value,
          chairmanMobile: document.getElementById("admin-chairman-mobile")
            .value,
          memberName: document.getElementById("admin-member-name").value,
          memberMobile: document.getElementById("admin-member-mobile").value,
          policeName: document.getElementById("admin-police-name").value,
          policeMobile: document.getElementById("admin-police-mobile").value,
          lastUpdatedBy: currentUserId,
          lastUpdatedAt: Timestamp.now(),
        };
        try {
          await setDoc(doc(db, adminDocPath), data, { merge: true });
          showToast("সংরক্ষণ করা হয়েছে।");
          loadAdminInfo();
        } catch (error) {
          showToast("ত্রুটি হয়েছে।", true);
        } finally {
          showLoader(false);
          adminSubmitBtn.disabled = false;
        }
      });

      sidebarLinks.forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          showPage(link.dataset.page);
        });
      });
      modalCloseBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
          toggleModal(btn.closest(".modal"), false);
        });
      });
      allModals.forEach((modal) => {
        modal.addEventListener("click", (e) => {
          if (e.target === modal) {
            toggleModal(modal, false);
          }
        });
      });
      openSidebarBtn.addEventListener("click", () => toggleSidebar(true));
      closeSidebarBtn.addEventListener("click", () => toggleSidebar(false));
      lucide.createIcons();
    </script>
  </body>
</html>
