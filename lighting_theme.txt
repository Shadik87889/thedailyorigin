<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TypeSwift - Modern Typing Test</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts: Inter (Body) & Lora (Headings) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lora:wght@700&display=swap" rel="stylesheet">
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        /* --- "Onyx & Gold" Theme --- */

        /* 1. Base & Typography */
        :root {
            --color-gold: #D4AF37; /* The primary "gold" color */
            --color-gold-dark: #B8860B; /* Darker gold for gradients */
            --color-black: #030303;     /* Pure, deep black */
            --color-onyx: #111111;     /* Off-black for elements */
            --color-glass: rgba(255, 255, 255, 0.03);
            --color-glass-border: rgba(255, 255, 255, 0.1);
            --color-text-light: #F5F5F5;
            --color-text-mid: #A0A0A0;
            --color-text-dark: #505050;
            --color-red: #f87171;
            --font-serif: 'Lora', serif;
            --font-sans: 'Inter', sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--color-black);
            color: var(--color-text-mid);
            scroll-behavior: smooth;
        }

        /* --- View (SPA) Handling --- */
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }

        /* Override base Tailwind colors */
        .bg-indigo-950 { background-color: var(--color-black) !important; }
        .text-slate-200 { color: var(--color-text-light) !important; }
        .text-slate-300 { color: var(--color-text-mid) !important; }
        .text-slate-400 { color: #888 !important; }

        /* Headings */
        h1, h2, h3, #user-name-display {
            font-family: var(--font-serif);
            font-weight: 700;
        }

        /* 2. Header & Navigation */
        header {
            background-color: rgba(10, 10, 10, 0.5) !important;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--color-glass-border) !important;
        }
        
        /* Logo & Gold Accents */
        .text-cyan-400 { color: var(--color-gold) !important; }
        .hover\:text-cyan-400:hover { color: var(--color-gold) !important; }
        
        .nav-link.text-cyan-400 { color: var(--color-gold) !important; }
        
        /* Nav Links */
        .nav-link {
            transition: all 0.2s ease-in-out;
            border-radius: 0.375rem; /* rounded-md */
        }
        .nav-link:hover {
            color: var(--color-text-light) !important;
            background-color: var(--color-glass) !important;
        }
        .nav-link.bg-cyan-500\/10 {
            background-color: rgba(212, 175, 55, 0.1) !important;
        }

        /* Auth Buttons */
        #lang-en, #lang-bn {
            background-color: var(--color-onyx);
            color: var(--color-text-mid);
            border: 1px solid var(--color-glass-border);
        }
        #lang-en {
            background-color: var(--color-text-light);
            color: var(--color-black);
            z-index: 10;
        }
        #show-auth-modal-btn:hover { color: #fff !important; }
        #user-profile-btn {
            background-color: var(--color-onyx);
            transition: all 0.2s ease;
        }
        #user-profile-btn:hover { background-color: var(--color-gold); color: var(--color-black); }
        #user-profile-dropdown {
            background-color: var(--color-onyx);
            border: 1px solid var(--color-glass-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* 3. Buttons (Primary/Secondary) */
        .bg-cyan-500 {
            background: linear-gradient(145deg, var(--color-gold), var(--color-gold-dark)) !important;
            color: var(--color-black) !important;
            font-weight: 700;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.1);
        }
        .hover\:bg-cyan-400:hover {
            background: linear-gradient(145deg, #ffeca0, var(--color-gold)) !important;
            color: var(--color-black) !importan;
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
            transform: scale(1.03);
        }
        /* Secondary "Glass" Button */
        .bg-indigo-900.border {
            background-color: var(--color-glass) !important;
            border: 1px solid var(--color-glass-border) !important;
            color: var(--color-gold) !important;
            transition: all 0.3s ease;
        }
        .hover\:bg-indigo-800:hover {
            background-color: rgba(255, 255, 255, 0.08) !important;
            border-color: rgba(255, 255, 255, 0.3) !important;
        }

        /* 4. Test Area */
        .bg-indigo-900\/50 {
            background-color: var(--color-glass) !important;
            border: 1px solid var(--color-glass-border) !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .border-white\/10 { border-color: var(--color-glass-border) !important; }
        .divide-white\/10 { border-color: var(--color-glass-border) !important; }

        /* Stats Panel */
        .bg-indigo-900 {
            background-color: rgba(0, 0, 0, 0.2) !important;
        }
        #stat-time, #stat-wpm, #stat-acc, #stat-raw, #stat-errors { font-family: var(--font-sans); font-weight: 700; }
        #stat-time { color: var(--color-gold) !important; }
        #stat-wpm, #stat-acc, #stat-raw { color: var(--color-text-light) !important; }
        #stat-errors { color: var(--color-red) !important; }


        /* Segmented Control */
        .segmented-control {
            display: inline-flex;
            align-items: center;
            padding: 4px;
            background-color: var(--color-black) !important;
            border-radius: 9999px; /* rounded-full */
            border: 1px solid var(--color-glass-border);
        }
        .segmented-control > button {
            padding: 0.5rem 1rem; /* py-2 px-4 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 600;
            color: var(--color-text-mid);
            border-radius: 9999px; /* rounded-full */
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .segmented-control > button:hover {
            color: var(--color-text-light);
        }
        .segmented-control > button.active {
            background-color: var(--color-gold) !important;
            color: var(--color-black) !important;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.2);
        }
        
        /* Words Container */
        #words-container { 
            font-size: 2rem; 
            line-height: 3rem; 
            transition: font-family 0.2s ease;
            /* --- UX FIX: Prevent overwhelming text wall --- */
            max-height: 9.5rem; /* Show ~3 lines (line-height: 3rem) */
            overflow-y: hidden;
            scroll-behavior: smooth;
            /* --- End UX Fix --- */
        }
        #words-container.font-mono {
            font-family: var(--font-mono);
            font-size: 1.75rem; /* 28px */
            line-height: 2.75rem;
        }
        .letter {
            border-radius: 2px;
            border-bottom: 3px solid transparent;
        }
        .letter.caret-left {
             border-left: 3px solid var(--color-gold);
             animation: blink 1s infinite;
        }
        @keyframes blink {
            0%, 100% { border-color: var(--color-gold); }
            50% { border-color: transparent; }
        }
        .letter.correct {
            color: var(--color-text-dark);
            border-bottom-color: var(--color-text-dark);
        }
        .letter.incorrect {
            color: var(--color-red);
            border-bottom-color: var(--color-red);
            background-color: rgba(248, 113, 113, 0.05);
            text-shadow: 0 0 8px rgba(248, 113, 113, 0.3);
        }
        .letter.incorrect-space {
            background-color: rgba(248, 113, 113, 0.2);
        }

        /* Focus Prompt */
        #focus-prompt { background-color: rgba(10, 10, 10, 0.8) !important; }

        /* 5. Modals (Results, Auth) */
        .bg-black\/70 {
            background-color: rgba(0, 0, 0, 0.6) !important;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        #results-modal-content, #auth-modal .bg-indigo-900 {
            background: linear-gradient(160deg, #1a1a1a, var(--color-onyx)) !important;
            border: 1px solid var(--color-glass-border) !important;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
        }
        #auth-modal .bg-indigo-800\/50 { /* Form inputs */
             background-color: rgba(0, 0, 0, 0.3) !important;
             border: 1px solid var(--color-glass-border) !important;
        }
        #auth-modal .focus\:border-cyan-500:focus { border-color: var(--color-gold) !important; }
        #auth-modal .focus\:ring-cyan-500\/50:focus {
            box-shadow: 0 0 0 2px var(--color-black), 0 0 0 4px var(--color-gold);
            outline: none;
        }
        #auth-tab-signin, #auth-tab-signup {
            transition: all 0.2s ease;
        }
        .border-cyan-400 { border-color: var(--color-gold) !important; }

        /* 6. Leaderboard & Dashboard */
        .bg-indigo-900 {
             background-color: var(--color-onyx) !important;
        }
        .hover\:bg-indigo-800\/60:hover {
            background-color: rgba(255, 255, 255, 0.03) !important;
        }
        .bg-yellow-500\/10 {
            background-color: rgba(212, 175, 55, 0.05) !important;
        }
        .text-yellow-500 { color: var(--color-gold) !important; }
        .text-green-400 { color: #4ade80 !important; }
        .text-amber-400 { color: #facc15 !important; }

        /* 7. Lessons View */
        .lesson-card {
            background-color: var(--color-onyx) !important;
            border: 1px solid var(--color-glass-border) !important;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        .lesson-card:hover {
            transform: translateY(-6px) scale(1.02);
            border-color: rgba(212, 175, 55, 0.5) !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        .lesson-card.locked {
            filter: grayscale(100%);
            opacity: 0.5;
        }
        .lesson-start-btn { transition: all 0.2s ease; }
        
        /* Lesson Buttons */
        .bg-cyan-500\/10 { background-color: rgba(212, 175, 55, 0.1) !important; }
        .text-cyan-300 { color: #D4AF37 !important; }
        .hover\:bg-cyan-500\/20:hover { background-color: rgba(212, 175, 55, 0.2) !important; }
        
        .bg-green-500\/10 { background-color: rgba(74, 222, 128, 0.1) !important; }
        .text-green-400 { color: #4ade80 !important; }
        .hover\:bg-green-500\/20:hover { background-color: rgba(74, 222, 128, 0.2) !important; }

        .lesson-stage .bg-indigo-900 { background-color: #0c0c0c !important; }
        .bg-cyan-500 { background-color: var(--color-gold) !important; } /* Progress bar */
        .bg-indigo-950 { background-color: #222 !important; } /* Progress bar track */
        .text-cyan-200 { color: var(--color-gold) !important; } /* Lesson instructions */
        .bg-cyan-500\/10 { background-color: rgba(212, 175, 55, 0.1) !important; }

        /* 8. On-Screen Keyboard */
        #keyboard-container {
            margin-top: 2rem;
            margin-bottom: 10rem; /* <-- FIX: Add space at the bottom to prevent cutoff */
            padding: 1.5rem;
            background-color: var(--color-onyx);
            border-radius: 0.75rem; /* rounded-xl */
            border: 1px solid var(--color-glass-border);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            flex-direction: column;
            gap: 0.75rem; /* 12px */
        }
        
        /* This rule applies the flex display ONLY when the keyboard is not hidden */
        #keyboard-container:not(.hidden) {
            display: flex;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 0.5rem; /* 8px */
            width: 100%;
        }

        .key {
            background-color: #222;
            border: 1px solid #444;
            border-bottom-width: 3px;
            color: #ccc;
            height: 56px;
            flex: 1; /* Make keys flexible */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            border-radius: 0.375rem; /* rounded-md */
            text-transform: uppercase;
            transition: all 0.1s ease;
        }
        
        /* Special key widths */
        .key-backspace, .key-enter, .key-shift {
            flex: 2.5;
        }
        .key-tab, .key-caps {
            flex: 2;
        }
        .key-space {
            flex: 10;
        }
        .key-ctrl {
            flex: 1.5;
        }

        .key:active, .key.active {
            background-color: var(--color-gold);
            border-color: var(--color-gold-dark);
            color: var(--color-black);
            transform: translateY(2px) scale(0.95);
            border-bottom-width: 1px;
        }
        /* Finger guides - more subtle */
        .key.finger-pinky-l { border-bottom-color: rgba(239, 68, 68, 0.5); }
        .key.finger-ring-l { border-bottom-color: rgba(249, 115, 22, 0.5); }
        .key.finger-middle-l { border-bottom-color: rgba(234, 179, 8, 0.5); }
        .key.finger-index-l { border-bottom-color: rgba(132, 204, 22, 0.5); }
        .key.finger-thumb { background-color: #333; }
        .key.finger-index-r { border-bottom-color: rgba(34, 197, 94, 0.5); }
        .key.finger-middle-r { border-bottom-color: rgba(20, 184, 166, 0.5); }
        .key.finger-ring-r { border-bottom-color: rgba(59, 130, 246, 0.5); }
        .key.finger-pinky-r { border-bottom-color: rgba(139, 92, 246, 0.5); }
.race-lane {
            width: 100%;
        }
        .progress-bar-track {
            width: 100%;
            height: 30px;
            background-color: var(--color-black);
            border-radius: 999px;
            border: 1px solid var(--color-glass-border);
            overflow: hidden;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            transition: width 0.1s linear; /* Smooth progress */
            position: relative;
        }
        .progress-bar.player-bar {
            background: linear-gradient(90deg, var(--color-gold), var(--color-gold-dark));
        }
        .progress-bar.bot-bar {
            background: linear-gradient(90deg, #f87171, #b91c1c); /* Red gradient */
        }

        /* Bot Race Words Container (separate from main test) */
        #bot-race-words-container {
            font-size: 1.75rem; /* 28px */
            line-height: 2.75rem;
            max-height: 8.25rem; /* 3 lines */
            overflow-y: hidden;
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-indigo-950 text-slate-200">

    <!-- 
      =================================
      Main Application Wrapper
      =================================
    -->
    <div class="min-h-screen w-full flex flex-col">

        <!-- 
          =================================
          Header & Navigation
          =================================
        -->
        <header class="bg-indigo-950/70 backdrop-blur-md border-b border-white/10 sticky top-0 z-50">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo / Brand -->
                    <div class="flex-shrink-0 flex items-center">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-cyan-400"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                        <span class="ml-2 text-2xl font-bold text-white" style="font-family: var(--font-serif);">TypeSwift</span>
                    </div>
                    
                    <!-- Main Navigation -->
                    <div class="hidden md:flex md:items-center md:space-x-6">
                        <button data-view="home" class="nav-link flex items-center space-x-1.5 font-medium text-slate-300 hover:text-cyan-400 px-3 py-2 rounded-md transition-colors">
                            <i data-lucide="home" class="w-4 h-4"></i>
                            <span>Home</span>
                        </button>
                        <button data-view="test" class="nav-link flex items-center space-x-1.5 font-medium text-cyan-400 bg-cyan-500/10 px-3 py-2 rounded-md transition-colors">
                            <i data-lucide="keyboard" class="w-4 h-4"></i>
                            <span>Test</span>
                        </button>
                        <button data-view="dashboard" class="nav-link flex items-center space-x-1.5 font-medium text-slate-300 hover:text-cyan-400 px-3 py-2 rounded-md transition-colors">
                            <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                            <span>Dashboard</span>
                        </button>
                        <button data-view="leaderboard" class="nav-link flex items-center space-x-1.5 font-medium text-slate-300 hover:text-cyan-400 px-3 py-2 rounded-md transition-colors">
                            <i data-lucide="trophy" class="w-4 h-4"></i>
                            <span>Leaderboard</span>
                        </button>
                        <button data-view="bot-race" class="nav-link flex items-center space-x-1.5 font-medium text-slate-300 hover:text-cyan-400 px-3 py-2 rounded-md transition-colors">
                            <i data-lucide="robot" class="w-4 h-4"></i>
                            <span>Bot Race</span>
                        </button>
                        <button data-view="lessons" class="nav-link flex items-center space-x-1.5 font-medium text-slate-300 hover:text-cyan-400 px-3 py-2 rounded-md transition-colors">
                            <i data-lucide="graduation-cap" class="w-4 h-4"></i>
                            <span>Lessons</span>
                        </button>
                    </div>

                    <!-- Right-side actions -->
                    <div class="flex items-center space-x-4">
                        <!-- i18n Toggle (Stub) -->
                        <div class="flex items-center">
                            <button id="lang-en" class="font-semibold text-xs px-3 py-1.5 rounded-l-full bg-white text-indigo-900 z-10 transition-colors">EN</button>
                            <button id="lang-bn" class="font-semibold text-xs px-3 py-1.5 rounded-r-full bg-indigo-900 text-slate-300 border border-l-0 border-indigo-800 hover:bg-indigo-800 transition-colors">BN</button>
                        </div>
                        
                        <!-- Auth Status -->
                        <div class="hidden sm:flex items-center space-x-2" id="auth-container">
                            <!-- Logged out state -->
                            <button id="show-auth-modal-btn" class="flex items-center space-x-2 font-medium text-sm text-cyan-400 hover:text-cyan-300 transition-colors">
                                <i data-lucide="log-in" class="w-4 h-4"></i>
                                <span>Login / Sign Up</span>
                            </button>
                            <!-- Logged in state (hidden by default) -->
                            <div id="user-info" class="hidden relative">
                                <button id="user-profile-btn" class="flex items-center justify-center w-8 h-8 rounded-full bg-indigo-800 text-slate-300 hover:bg-indigo-700 transition-colors">
                                    <i data-lucide="user" class="w-5 h-5"></i>
                                </button>
                                
                                <!-- Profile Dropdown -->
                                <div id="user-profile-dropdown" class="hidden absolute top-12 right-0 w-60 bg-indigo-900 rounded-lg shadow-xl border border-white/10 z-50 p-4">
                                    <div class="border-b border-white/10 pb-3 mb-3 text-center">
                                        <div id="user-name-display" class="text-sm font-semibold text-white"></div>
                                        <div id="user-email-display" class="text-xs text-slate-400 font-mono mt-1 truncate"></div>
                                    </div>
                                    <button id="sign-out-btn" class="w-full flex items-center justify-center space-x-2 text-sm text-slate-300 hover:bg-red-500/10 hover:text-red-400 rounded-md p-2 transition-colors">
                                        <i data-lucide="log-out" class="w-4 h-4"></i>
                                        <span>Sign Out</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Mobile Menu Button -->
                        <div class="md:hidden">
                            <button id="mobile-menu-btn" class="p-2 rounded-md text-slate-400 hover:text-white hover:bg-indigo-800" aria-label="Open menu">
                                <i data-lucide="menu" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Mobile Menu (Hidden) -->
                <div id="mobile-menu" class="hidden md:hidden pb-3 space-y-1">
                    <button data-view="home" class="nav-link block w-full text-left font-medium text-slate-300 hover:text-cyan-400 hover:bg-cyan-500/10 px-3 py-2 rounded-md transition-colors">Home</button>
                    <button data-view="test" class="nav-link block w-full text-left font-medium text-cyan-400 bg-cyan-500/10 px-3 py-2 rounded-md transition-colors">Test</button>
                    <button data-view="dashboard" class="nav-link block w-full text-left font-medium text-slate-300 hover:text-cyan-400 hover:bg-cyan-500/10 px-3 py-2 rounded-md transition-colors">Dashboard</button>
                    <button data-view="leaderboard" class="nav-link block w-full text-left font-medium text-slate-300 hover:text-cyan-400 hover:bg-cyan-500/10 px-3 py-2 rounded-md transition-colors">Leaderboard</button>
                    <button data-view="bot-race" class="nav-link block w-full text-left font-medium text-slate-300 hover:text-cyan-400 hover:bg-cyan-500/10 px-3 py-2 rounded-md transition-colors">Bot Race</button>
                    <button data-view="lessons" class="nav-link block w-full text-left font-medium text-slate-300 hover:text-cyan-400 hover:bg-cyan-500/10 px-3 py-2 rounded-md transition-colors">Lessons</button>
                </div>
            </nav>
        </header>

        <!-- 
          =================================
          Main Content Area
          =================================
        -->
        <main class="flex-grow">
            <!-- 
              =================================
              View: Home (COMPREHENSIVE)
              =================================
            -->
            <section id="home-view" class="view max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                
                <!-- 1. Hero Section (Existing) -->
                <div class="py-24 md:py-32">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-16 items-center">
                        <!-- Hero Text -->
                        <div>
                            <h1 class="text-5xl md:text-6xl lg:text-7xl font-extrabold tracking-tighter text-white leading-tight" data-i18n-key="hero_title">
                                Master the Keyboard.
                                <br class="hidden md:block">
                                <span class="text-cyan-400">Unlock Your Speed.</span>
                            </h1>
                            <p class="mt-6 text-lg text-slate-300 max-w-lg" data-i18n-key="hero_subtitle">
                                Join millions of typists and improve your typing speed and accuracy with our real-time tests, structured lessons, and global leaderboards.
                            </p>
                            <div class="mt-10 flex flex-col sm:flex-row gap-4">
                                <button data-view="test" class="nav-link w-full sm:w-auto text-lg font-semibold text-black bg-cyan-500 hover:bg-cyan-400 rounded-lg px-8 py-4 transition-all transform hover:-translate-y-1 hover:shadow-lg hover:shadow-cyan-500/30 shadow-md" data-i18n-key="hero_cta">
                                    Start Typing Test
                                </button>
                                <button data-view="lessons" class="nav-link w-full sm:w-auto text-lg font-semibold text-cyan-400 bg-indigo-900 hover:bg-indigo-800 rounded-lg px-8 py-4 transition-all transform hover:-translate-y-1 hover:shadow-lg border border-indigo-700 shadow-md" data-i18n-key="hero_cta_alt">
                                    Browse Lessons
                                </button>
                            </div>
                        </div>
                        
                        <!-- Hero Image (Mock UI) -->
                        <div class="bg-indigo-900/50 rounded-2xl shadow-2xl p-6 relative overflow-hidden border border-white/10 transform md:scale-110 md:rotate-3">
                            <!-- Browser Bar -->
                            <div class="flex items-center space-x-1.5 pb-4 border-b border-white/10 mb-4">
                                <div class="w-3 h-3 rounded-full bg-red-400"></div>
                                <div class="w-3 h-3 rounded-full bg-yellow-400"></div>
                                <div class="w-3 h-3 rounded-full bg-green-400"></div>
                            </div>
                            
                            <!-- Mock Stats -->
                            <div class="grid grid-cols-3 divide-x divide-white/10 rounded-lg bg-indigo-900 border border-white/10 mb-6">
                                <div class="p-4 text-center">
                                    <span class="text-xs font-medium text-slate-400">Time</span>
                                    <span class="block text-2xl font-bold text-cyan-400">30</span>
                                </div>
                                <div class="p-4 text-center">
                                    <span class="text-xs font-medium text-slate-400">WPM</span>
                                    <span class="block text-2xl font-bold text-slate-100">102</span>
                                </div>
                                <div class="p-4 text-center">
                                    <span class="text-xs font-medium text-slate-400">Accuracy</span>
                                    <span class="block text-2xl font-bold text-slate-100">98%</span>
                                </div>
                            </div>

                            <!-- Mock Words -->
                            <div class="text-2xl font-medium leading-relaxed text-slate-300 max-h-40 overflow-hidden">
                                <span style="color: var(--color-text-dark)">The quick brown fox jumps over</span>
                                <span style="color: var(--color-text-dark)">the lazy dog. Success is not</span>
                                <span class="text-slate-300">final, failure is not fatal:</span>
                                <span class="text-slate-300">it is the <span class="border-l-4 border-cyan-400 animate-pulse" style="border-color: var(--color-gold) !important">c</span>ourage to</span>
                                <span class="text-slate-300 opacity-50">continue that counts.</span>
                                <div class="absolute bottom-0 left-0 w-full h-16 bg-gradient-to-t from-black to-transparent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Features Showcase (New) -->
                <div class="py-24">
                    <h2 class="text-center text-4xl font-bold text-white mb-4">Master Every Aspect of Typing</h2>
                    <p class="text-center text-lg text-slate-400 mb-16 max-w-2xl mx-auto">
                        We offer more than just a test. Our platform is a complete toolset for keyboard mastery, from learning the home row to hitting triple-digit WPM.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 md:gap-12">
                        
                        <!-- Feature Card 1: Advanced Metrics -->
                        <div class="bg-indigo-900/50 p-6 rounded-xl shadow-xl border border-white/10 text-center transform transition-all duration-300 hover:scale-[1.02] hover:shadow-cyan-500/10">
                            <i data-lucide="line-chart" class="w-12 h-12 text-cyan-400 mx-auto mb-4"></i>
                            <h3 class="text-xl font-bold text-white mb-2">Detailed Metrics</h3>
                            <p class="text-slate-300 text-sm">Track **WPM**, **Accuracy**, and **Raw Speed** over time. See your progress charted instantly on your personal dashboard.</p>
                        </div>
                        
                        <!-- Feature Card 2: Structured Lessons -->
                        <div class="bg-indigo-900/50 p-6 rounded-xl shadow-xl border border-white/10 text-center transform transition-all duration-300 hover:scale-[1.02] hover:shadow-cyan-500/10">
                            <i data-lucide="graduation-cap" class="w-12 h-12 text-cyan-400 mx-auto mb-4"></i>
                            <h3 class="text-xl font-bold text-white mb-2">Structured Lessons</h3>
                            <p class="text-slate-300 text-sm">From the home row to complex N-grams, our **8-stage curriculum** is designed to build muscle memory and fluency efficiently.</p>
                        </div>
                        
                        <!-- Feature Card 3: Global Competition -->
                        <div class="bg-indigo-900/50 p-6 rounded-xl shadow-xl border border-white/10 text-center transform transition-all duration-300 hover:scale-[1.02] hover:shadow-cyan-500/10">
                            <i data-lucide="trophy" class="w-12 h-12 text-cyan-400 mx-auto mb-4"></i>
                            <h3 class="text-xl font-bold text-white mb-2">Global Leaderboard</h3>
                            <p class="text-slate-300 text-sm">Compete against typists worldwide. Filter results by **Time** and **Words** modes to see where you rank among the elite.</p>
                        </div>

                    </div>
                </div>

                <!-- 3. Social Proof / Stats Section (New) -->
                <div class="text-center py-20 bg-indigo-900/50 rounded-xl border border-white/10 shadow-2xl my-24">
                    <h2 class="text-4xl md:text-5xl font-extrabold text-white mb-8" style="font-family: var(--font-serif);">
                        Join <span class="text-cyan-400">100,000+</span> Typists
                    </h2>
                    <div class="flex flex-col sm:flex-row justify-center space-y-6 sm:space-y-0 sm:space-x-12">
                        <div class="p-4">
                            <span class="block text-5xl font-bold text-cyan-400">4M+</span>
                            <span class="text-sm text-slate-400 uppercase tracking-widest mt-2 block">Tests Completed</span>
                        </div>
                        <div class="p-4">
                            <span class="block text-5xl font-bold text-white">99%</span>
                            <span class="text-sm text-slate-400 uppercase tracking-widest mt-2 block">Uptime Reliability</span>
                        </div>
                        <div class="p-4">
                            <span class="block text-5xl font-bold text-white">85.3 WPM</span>
                            <span class="text-sm text-slate-400 uppercase tracking-widest mt-2 block">Average User Speed</span>
                        </div>
                    </div>
                </div>

                <!-- 4. Final CTA (New) -->
                <div class="pt-12 pb-24 text-center">
                    <h2 class="text-3xl font-bold text-white mb-4">Ready to Transform Your Typing?</h2>
                    <p class="text-lg text-slate-400 mb-8">
                        It only takes a few seconds to start your first test and begin your journey to speed mastery.
                    </p>
                    <div class="flex justify-center flex-col sm:flex-row gap-4">
                        <button data-view="test" class="nav-link w-full sm:w-auto text-xl font-semibold text-black bg-cyan-500 hover:bg-cyan-400 rounded-lg px-10 py-4 transition-all transform hover:-translate-y-1 hover:shadow-lg hover:shadow-cyan-500/30 shadow-md">
                            Start Free Test Now
                        </button>
                        <button data-view="dashboard" class="nav-link w-full sm:w-auto text-xl font-semibold text-cyan-400 bg-indigo-900 hover:bg-indigo-800 rounded-lg px-10 py-4 transition-all transform hover:-translate-y-1 hover:shadow-lg border border-indigo-700 shadow-md">
                            View Dashboard
                        </button>
                    </div>
                </div>

            </section>

            <!-- 
              =================================
              View: Typing Test
              =================================
            -->
            <section id="test-view" class="view active max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
                
                <!-- 
                  =================================
                  Test Configuration (ADVANCED)
                  =================================
                -->
                <div id="test-config-panel" class="bg-indigo-900/50 rounded-lg shadow-sm border border-white/10 p-4 mb-8">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                        
                        <!-- Left Side: Mode & Difficulty -->
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <!-- Segmented Control: Mode -->
                            <div id="test-mode-options" class="segmented-control" role="tablist" aria-label="Test Mode">
                                <button data-mode="time" data-value="15" class="test-mode-btn" role="tab">15s</button>
                                <button data-mode="time" data-value="30" class="test-mode-btn active" role="tab" aria-selected="true">30s</button>
                                <button data-mode="time" data-value="60" class="test-mode-btn" role="tab">60s</button>
                                <button data-mode="words" data-value="10" class="test-mode-btn" role="tab">10w</button>
                                <button data-mode="words" data-value="25" class="test-mode-btn" role="tab">25w</button>
                                <button data-mode="words" data-value="50" class="test-mode-btn" role="tab">50w</button>
                                <button data-mode="quote" data-value="short" class="test-mode-btn" role="tab">Quote</button>
                                <button data-mode="code" data-value="short" class="test-mode-btn" role="tab">Code</button>
                            </div>

                            <!-- Segmented Control: Difficulty -->
                            <div id="test-difficulty-options" class="segmented-control" role="tablist" aria-label="Test Difficulty">
                                <button data-difficulty="easy" class="test-difficulty-btn active" role="tab" aria-selected="true">Easy</button>
                                <button data-difficulty="hard" class="test-difficulty-btn" role="tab">Hard</button>
                            </div>
                        </div>

                        <!-- Right Side: Restart Button -->
                        <button id="restart-test-btn" class="p-2.5 rounded-md text-slate-400 hover:text-cyan-400 hover:bg-cyan-500/10 transition-all transform duration-300 rotate-0 hover:rotate-180" aria-label="Restart test" title="Restart test">
                            <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>


                <!-- 
                  =================================
                  Test Area
                  =================================
                -->
                <div id="test-area-container" class="bg-indigo-900/50 rounded-xl shadow-xl border border-white/10 p-8 md:p-12 relative">
                    
                    <!-- Stats Display Panel (ADVANCED) -->
                    <div id="stats-container" class="rounded-lg bg-indigo-900 border border-white/10 mb-10">
                        <div class="grid grid-cols-3 md:grid-cols-5 divide-x divide-white/10">
                            <!-- Time -->
                            <div class="px-4 py-4 text-center">
                                <span class="text-xs sm:text-sm font-semibold text-slate-400" data-i18n-key="stat_time">Time</span>
                                <span id="stat-time" class="block text-2xl sm:text-4xl font-bold text-cyan-400" aria-live="polite">30</span>
                            </div>
                            <!-- WPM -->
                            <div class="px-4 py-4 text-center">
                                <span class="text-xs sm:text-sm font-semibold text-slate-400" data-i18n-key="stat_wpm">WPM</span>
                                <span id="stat-wpm" class="block text-2xl sm:text-4xl font-bold text-slate-100" aria-live="polite">0</span>
                            </div>
                            <!-- Accuracy -->
                            <div class="px-4 py-4 text-center">
                                <span class="text-xs sm:text-sm font-semibold text-slate-400" data-i18n-key="stat_acc">Accuracy</span>
                                <span id="stat-acc" class="block text-2xl sm:text-4xl font-bold text-slate-100" aria-live="polite">100%</span>
                            </div>
                            <!-- Raw WPM -->
                            <div class="px-4 py-4 text-center">
                                <span class="text-xs sm:text-sm font-semibold text-slate-400" data-i18n-key="stat_raw">Raw</span>
                                <span id="stat-raw" class="block text-2xl sm:text-4xl font-bold text-slate-100" aria-live="polite">0</span>
                            </div>
                            <!-- Errors -->
                            <div class="px-4 py-4 text-center">
                                <span class="text-xs sm:text-sm font-semibold text-slate-400" data-i18n-key="stat_errors">Errors</span>
                                <span id="stat-errors" class="block text-2xl sm:text-4xl font-bold text-red-500" aria-live="polite">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lesson Instructions Panel (Hidden by default) -->
                    <div id="lesson-instructions" class="hidden bg-cyan-500/10 border border-cyan-500/20 text-cyan-200 rounded-lg p-4 mb-8">
                        <h3 id="lesson-title" class="text-xl font-bold mb-2 flex items-center">
                            <i data-lucide="graduation-cap" class="w-5 h-5 mr-2"></i>
                            <span></span>
                        </h3>
                        <p id="lesson-prompt" class="text-base"></p>
                    </div>

                    <!-- Words to type -->
                    <div id="words-container" class="text-slate-300 tracking-wide" aria-label="Text to type">
                        <!-- Letters will be injected here -->
                    </div>
                    
                    <!-- Hidden input to capture keyboard events -->
                    <input type="text" id="main-input" class="opacity-0" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" aria-label="Typing input area" aria-describedby="test-instructions">

                    <!-- Loading / Focus Prompt -->
                    <div id="focus-prompt" class="absolute inset-0 bg-indigo-900/80 backdrop-blur-sm flex flex-col items-center justify-center rounded-xl cursor-pointer transition-opacity duration-300" role="button" aria-label="Click to start test">
                        <i data-lucide="mouse-pointer-click" class="w-16 h-16 text-cyan-400 opacity-80"></i>
                        <p id="test-instructions" class="mt-4 text-xl font-semibold text-slate-200" data-i18n-key="test_start_prompt">
                            Click or start typing to begin
                        </p>
                    </div>

                </div>
                
                <!-- On-Screen Keyboard -->
                <div id="keyboard-container" class="hidden">
                    <div class="keyboard-row">
                        <div class="key finger-pinky-l" data-code="Backquote">`</div>
                        <div class="key finger-pinky-l" data-code="Digit1">1</div>
                        <div class="key finger-ring-l" data-code="Digit2">2</div>
                        <div class="key finger-middle-l" data-code="Digit3">3</div>
                        <div class="key finger-index-l" data-code="Digit4">4</div>
                        <div class="key finger-index-l" data-code="Digit5">5</div>
                        <div class="key finger-index-r" data-code="Digit6">6</div>
                        <div class="key finger-index-r" data-code="Digit7">7</div>
                        <div class="key finger-middle-r" data-code="Digit8">8</div>
                        <div class="key finger-ring-r" data-code="Digit9">9</div>
                        <div class="key finger-pinky-r" data-code="Digit0">0</div>
                        <div class="key finger-pinky-r" data-code="Minus">-</div>
                        <div class="key finger-pinky-r" data-code="Equal">=</div>
                        <div class="key key-backspace finger-pinky-r" data-code="Backspace">delete</div>
                    </div>
                    <div class="keyboard-row">
                        <div class="key key-tab finger-pinky-l" data-code="Tab">tab</div>
                        <div class="key finger-pinky-l" data-code="KeyQ">q</div>
                        <div class="key finger-ring-l" data-code="KeyW">w</div>
                        <div class="key finger-middle-l" data-code="KeyE">e</div>
                        <div class="key finger-index-l" data-code="KeyR">r</div>
                        <div class="key finger-index-l" data-code="KeyT">t</div>
                        <div class="key finger-index-r" data-code="KeyY">y</div>
                        <div class="key finger-index-r" data-code="KeyU">u</div>
                        <div class="key finger-middle-r" data-code="KeyI">i</div>
                        <div class="key finger-ring-r" data-code="KeyO">o</div>
                        <div class="key finger-pinky-r" data-code="KeyP">p</div>
                        <div class="key finger-pinky-r" data-code="BracketLeft">[</div>
                        <div class="key finger-pinky-r" data-code="BracketRight">]</div>
                        <div class="key finger-pinky-r" data-code="Backslash">\</div>
                    </div>
                    <div class="keyboard-row">
                        <div class="key key-caps finger-pinky-l" data-code="CapsLock">caps lock</div>
                        <div class="key finger-pinky-l" data-code="KeyA">a</div>
                        <div class="key finger-ring-l" data-code="KeyS">s</div>
                        <div class="key finger-middle-l" data-code="KeyD">d</div>
                        <div class="key finger-index-l" data-code="KeyF">f</div>
                        <div class="key finger-index-l" data-code="KeyG">g</div>
                        <div class="key finger-index-r" data-code="KeyH">h</div>
                        <div class="key finger-index-r" data-code="KeyJ">j</div>
                        <div class="key finger-middle-r" data-code="KeyK">k</div>
                        <div class="key finger-ring-r" data-code="KeyL">l</div>
                        <div class="key finger-pinky-r" data-code="Semicolon">;</div>
                        <div class="key finger-pinky-r" data-code="Quote">'</div>
                        <div class="key key-enter finger-pinky-r" data-code="Enter">enter</div>
                    </div>
                    <div class="keyboard-row">
                        <div class="key key-shift finger-pinky-l" data-code="ShiftLeft">shift</div>
                        <div class="key finger-pinky-l" data-code="KeyZ">z</div>
                        <div class="key finger-ring-l" data-code="KeyX">x</div>
                        <div class="key finger-middle-l" data-code="KeyC">c</div>
                        <div class="key finger-index-l" data-code="KeyV">v</div>
                        <div class="key finger-index-l" data-code="KeyB">b</div>
                        <div class="key finger-index-r" data-code="KeyN">n</div>
                        <div class="key finger-index-r" data-code="KeyM">m</div>
                        <div class="key finger-middle-r" data-code="Comma">,</div>
                        <div class="key finger-ring-r" data-code="Period">.</div>
                        <div class="key finger-pinky-r" data-code="Slash">/</div>
                        <div class="key key-shift finger-pinky-r" data-code="ShiftRight">shift</div>
                    </div>
                    <div class="keyboard-row">
                        <div class="key key-ctrl finger-pinky-l" data-code="ControlLeft">ctrl</div>
                        <div class="key finger-thumb" data-code="AltLeft">alt</div>
                        <div class="key key-space finger-thumb" data-code="Space"></div>
                        <div class="key finger-thumb" data-code="AltRight">alt</div>
                        <div class="key key-ctrl finger-pinky-r" data-code="ControlRight">ctrl</div>
                    </div>
                </div>

            </section>

            <!-- 
              =================================
              View: Leaderboard
              =================================
            -->
            <section id="leaderboard-view" class="view max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-white" data-i18n-key="lead_title">Global Leaderboard</h1>
                    <p id="leaderboard-filter-desc" class="mt-2 text-lg text-slate-300">Showing top results for the <strong>30s Time</strong> mode.</p>
                </div>

                <!-- Leaderboard Filter Panel -->
                <div id="leaderboard-filter-panel" class="bg-indigo-900/50 rounded-lg shadow-sm border border-white/10 p-4 mb-8 flex justify-center">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <!-- Segmented Control: Mode -->
                        <div class="segmented-control" role="tablist" aria-label="Leaderboard Filter">
                            <button data-mode="time" data-value="15" class="leaderboard-filter-btn" role="tab">15s</button>
                            <button data-mode="time" data-value="30" class="leaderboard-filter-btn active" role="tab" aria-selected="true">30s</button>
                            <button data-mode="time" data-value="60" class="leaderboard-filter-btn" role="tab">60s</button>
                            <button data-mode="words" data-value="10" class="leaderboard-filter-btn" role="tab">10w</button>
                            <button data-mode="words" data-value="25" class="leaderboard-filter-btn" role="tab">25w</button>
                            <button data-mode="words" data-value="50" class="leaderboard-filter-btn" role="tab">50w</button>
                        </div>
                    </div>
                </div>

                <div class="bg-indigo-900/50 rounded-lg shadow-lg border border-white/10 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-white/10">
                            <thead class="bg-indigo-900">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Rank</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Name</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">WPM</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Accuracy</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Date</th>
                                </tr>
                            </thead>
                            <tbody id="leaderboard-table" class="divide-y divide-white/10">
                                <!-- Data will be injected by Firebase -->
                                <tr>
                                    <td colspan="5" class="px-6 py-12 text-center text-slate-400">
                                        <div class="flex items-center justify-center space-x-2">
                                            <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
                                            <span>Loading leaderboard...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination Controls -->
                <div id="leaderboard-pagination-controls" class="flex items-center justify-between mt-6">
                    <button id="lead-prev-btn" class="flex items-center space-x-2 font-semibold text-sm text-cyan-400 bg-indigo-900 hover:bg-indigo-800 rounded-lg px-4 py-2 transition-all border border-indigo-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        <span>Previous</span>
                    </button>
                    <span id="lead-page-info" class="text-sm font-medium text-slate-300">Page 1 of 1</span>
                    <button id="lead-next-btn" class="flex items-center space-x-2 font-semibold text-sm text-cyan-400 bg-indigo-900 hover:bg-indigo-800 rounded-lg px-4 py-2 transition-all border border-indigo-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>Next</span>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </div>
            </section>
            
            <!-- 
              =================================
              View: Dashboard
              =================================
            -->
            <section id="dashboard-view" class="view max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-bold text-white" data-i18n-key="dash_title">My Dashboard</h1>
                    <p class="mt-2 text-lg text-slate-300">Your personal progress and test history.</p>
                </div>

                <!-- KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 md:gap-6 mb-8">
                    <div class="bg-indigo-900/50 rounded-lg shadow-lg border border-white/10 p-5 text-center">
                        <span class="text-xs font-semibold text-slate-400">Average WPM</span>
                        <span id="kpi-avg-wpm" class="block text-4xl font-bold text-cyan-400 mt-1">0</span>
                    </div>
                    <div class="bg-indigo-900/50 rounded-lg shadow-lg border border-white/10 p-5 text-center">
                        <span class="text-xs font-semibold text-slate-400">Best WPM</span>
                        <span id="kpi-best-wpm" class="block text-4xl font-bold text-slate-100 mt-1">0</span>
                    </div>
                    <div class="bg-indigo-900/50 rounded-lg shadow-lg border border-white/10 p-5 text-center">
                        <span class="text-xs font-semibold text-slate-400">Total Tests</span>
                        <span id="kpi-total-tests" class="block text-4xl font-bold text-slate-100 mt-1">0</span>
                    </div>
                    <div class="bg-indigo-900/50 rounded-lg shadow-lg border border-white/10 p-5 text-center">
                        <span class="text-xs font-semibold text-slate-400">Avg. Accuracy</span>
                        <span id="kpi-avg-acc" class="block text-4xl font-bold text-slate-100 mt-1">0%</span>
                    </div>
                </div>

                <!-- Chart -->
                <div class="bg-indigo-900/50 rounded-lg shadow-lg border border-white/10 p-4 md:p-6 mb-8">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 gap-4">
                        <h2 class="text-xl font-semibold text-slate-100" data-i18n-key="dash_progress">WPM & Accuracy Progress</h2>
                        
                        <!-- NEW: Chart Filter -->
                        <div id="dashboard-chart-filter" class="segmented-control" role="tablist" aria-label="Chart Filter">
                            <button data-filter="last20" class="chart-filter-btn active" role="tab" aria-selected="true">Last 20</button>
                            <button data-filter="last7" class="chart-filter-btn" role="tab">Last 7 Days</button>
                            <button data-filter="last30" class="chart-filter-btn" role="tab">Last 30 Days</button>
                            <button data-filter="all" class="chart-filter-btn" role="tab">All Time</button>
                        </div>
                        <!-- END: Chart Filter -->
                    </div>
                    
                    <div class="h-80">
                        <canvas id="wpm-progress-chart"></canvas>
                    </div>
                </div>

                <!-- Results History -->
                <h2 class="text-2xl font-semibold text-slate-100 mb-4" data-i18n-key="dash_history">My Results History</h2>
                <div class="bg-indigo-900/50 rounded-lg shadow-lg border border-white/10 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-white/10">
                            <thead class="bg-indigo-900">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Date</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">WPM</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Accuracy</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Mode</th>
                                </tr>
                            </thead>
                            <tbody id="dashboard-results-table" class="divide-y divide-white/10">
                                <!-- Data will be injected by Firebase -->
                                <tr>
                                    <td colspan="4" class="px-6 py-12 text-center text-slate-400">
                                        <span>Loading results...</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Pagination Controls -->
                <div id="dashboard-pagination-controls" class="flex items-center justify-between mt-6">
                    <button id="dash-prev-btn" class="flex items-center space-x-2 font-semibold text-sm text-cyan-400 bg-indigo-900 hover:bg-indigo-800 rounded-lg px-4 py-2 transition-all border border-indigo-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        <span>Previous</span>
                    </button>
                    <span id="dash-page-info" class="text-sm font-medium text-slate-300">Page 1 of 1</span>
                    <button id="dash-next-btn" class="flex items-center space-x-2 font-semibold text-sm text-cyan-400 bg-indigo-900 hover:bg-indigo-800 rounded-lg px-4 py-2 transition-all border border-indigo-700 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                        <span>Next</span>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </div>
            </section>

         
            
        </main>
        
        <!-- 
          =================================
          View: Lessons
          =================================
        -->
        <section id="lessons-view" class="view max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
            <h1 class="text-4xl font-bold text-white mb-8" data-i18n-key="lesson_title">Typing Lessons</h1>
            
            <!-- Container for dynamically generated lesson stages -->
            <div id="lesson-stages-container" class="space-y-12">
                <!-- Lessons will be dynamically injected here -->
            </div>
        </section>
        <section id="bot-race-view" class="view max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white" data-i18n-key="race_title">Bot Race</h1>
                <p class="mt-2 text-lg text-slate-300">Challenge an AI opponent and test your speed!</p>
            </div>
            
            <!-- Config Panel -->
            <div id="bot-race-config-panel" class="bg-indigo-900/50 rounded-lg shadow-sm border border-white/10 p-4 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    
                    <!-- Left Side: Bot Difficulty -->
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <span class="font-semibold text-slate-300">Opponent:</span>
                        <div id="bot-difficulty-options" class="segmented-control" role="tablist" aria-label="Bot Difficulty">
                            <button data-difficulty="easy" class="bot-difficulty-btn active" role="tab" aria-selected="true">Easy (40 WPM)</button>
                            <button data-difficulty="medium" class="bot-difficulty-btn" role="tab">Medium (70 WPM)</button>
                            <button data-difficulty="hard" class="bot-difficulty-btn" role="tab">Hard (100 WPM)</button>
                            <button data-difficulty="pro" class="bot-difficulty-btn" role="tab">Pro (130 WPM)</button>
                        </div>
                    </div>

                    <!-- Right Side: Start Button -->
                    <button id="start-bot-race-btn" class="flex items-center space-x-2 text-lg font-semibold text-black bg-cyan-500 hover:bg-cyan-400 rounded-lg px-6 py-2.5 transition-all transform hover:scale-105 shadow-md">
                        <i data-lucide="play" class="w-5 h-5"></i>
                        <span>Start Race</span>
                    </button>
                </div>
            </div>

            <!-- Race Track -->
            <div id="bot-race-track" class="bg-indigo-900/50 rounded-xl shadow-xl border border-white/10 p-8 md:p-12 relative mb-8 space-y-8">
                <!-- Player Track -->
                <div class="race-lane">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="user" class="w-6 h-6 text-cyan-400"></i>
                            <span class="text-xl font-bold text-white">You</span>
                        </div>
                        <span id="player-race-wpm" class="text-2xl font-bold text-cyan-400">0 WPM</span>
                    </div>
                    <div class="progress-bar-track">
                        <div id="player-progress" class="progress-bar player-bar"></div>
                    </div>
                </div>
                
                <!-- Bot Track -->
                <div class="race-lane">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-3">
                            <i data-lucide="robot" class="w-6 h-6 text-red-400"></i>
                            <span class="text-xl font-bold text-white">Bot</span>
                        </div>
                        <span id="bot-race-wpm" class="text-2xl font-bold text-red-400">... WPM</span>
                    </div>
                    <div class="progress-bar-track">
                        <div id="bot-progress" class="progress-bar bot-bar"></div>
                    </div>
                </div>

                <!-- Race Countdown Timer -->
                <div id="bot-race-countdown" class="hidden absolute inset-0 bg-indigo-950/80 backdrop-blur-sm flex items-center justify-center rounded-xl z-10">
                    <span id="bot-race-countdown-text" class="text-8xl font-bold text-white" style="font-family: var(--font-serif);">3</span>
                </div>

                <!-- Race Finished Overlay -->
                <div id="bot-race-finished" class="hidden absolute inset-0 bg-indigo-950/90 backdrop-blur-md flex flex-col items-center justify-center rounded-xl z-10 space-y-6">
                    <span id="bot-race-result-text" class="text-6xl font-bold text-white" style="font-family: var(--font-serif);">You Win!</span>
                    <button id="bot-race-restart-btn" class="flex items-center space-x-2 text-lg font-semibold text-black bg-cyan-500 hover:bg-cyan-400 rounded-lg px-6 py-2.5 transition-all transform hover:scale-105 shadow-md">
                        <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                        <span>Race Again</span>
                    </button>
                </div>
            </div>

            <!-- Typing Area for Bot Race -->
            <div id="bot-race-typing-area" class="bg-indigo-900/50 rounded-xl shadow-xl border border-white/10 p-8 md:p-12 relative hidden">
                <!-- Words to type -->
                <div id="bot-race-words-container" class="text-slate-300 tracking-wide text-2xl leading-loose" aria-label="Text to type">
                    <!-- Letters will be injected here -->
                </div>
                
                <!-- Hidden input to capture keyboard events -->
                <input type="text" id="bot-race-input" class="opacity-0" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" aria-label="Typing input area">
            </div>

        </section>
    </main>
         
        <footer class="bg-indigo-950 border-t border-white/10 mt-24">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center text-sm text-slate-400">
                <p>&copy; 2025 TypeSwift. Built with <span class="text-red-500">&hearts;</span>, Tailwind, and Firebase.</p>
                <p class="mt-2">This is a single-file proof-of-concept. Not all features are implemented.</p>
            </div>
        </footer>
    </div>


    <!-- 
      =================================
      Modal: Test Results
      =================================
    -->
    <div id="results-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="bg-indigo-900 rounded-2xl shadow-2xl shadow-cyan-500/10 w-full max-w-lg transform transition-all border border-white/10" id="results-modal-content">
            <!-- Modal content will be injected by JS -->
            <div class="p-8 text-center">
                <i data-lucide="loader-2" class="w-12 h-12 text-cyan-400 animate-spin mx-auto"></i>
                <span class="mt-4 block text-xl font-medium text-white">Calculating...</span>
            </div>
        </div>
    </div>

    <!-- 
      =================================
      Modal: Authentication
      =================================
    -->
    <div id="auth-modal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden" role="dialog" aria-modal="true">
        <div class="bg-indigo-900 rounded-2xl shadow-2xl shadow-cyan-500/10 w-full max-w-sm transform transition-all p-6 md:p-8 relative border border-white/10">
            
            <button id="close-auth-modal-btn" class="absolute top-4 right-4 text-slate-400 hover:text-white" aria-label="Close modal">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <!-- Tabs -->
            <div class="mb-6">
                <div class="flex border-b border-white/10">
                    <button id="auth-tab-signin" class="flex-1 py-3 font-semibold text-center text-cyan-400 border-b-2 border-cyan-400" data-tab="signin">
                        Sign In
                    </button>
                    <button id="auth-tab-signup" class="flex-1 py-3 font-semibold text-center text-slate-400 border-b-2 border-transparent hover:text-slate-200" data-tab="signup">
                        Sign Up
                    </button>
                </div>
            </div>

            <!-- Auth Form -->
            <form id="auth-form">
                <div class="space-y-4">
                    <!-- Name Input (Sign up only) -->
                    <div id="auth-name-group" class="hidden">
                        <label for="auth-name" class="block text-sm font-medium text-slate-200">Name</label>
                        <input type="text" id="auth-name" class="mt-1 block w-full px-3 py-2.5 bg-indigo-800/50 border border-indigo-700 rounded-lg text-sm shadow-sm placeholder-slate-400 text-white focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50" placeholder="Your Name">
                    </div>
                    <div>
                        <label for="auth-email" class="block text-sm font-medium text-slate-200">Email</label>
                        <input type="email" id="auth-email" required class="mt-1 block w-full px-3 py-2.5 bg-indigo-800/50 border border-indigo-700 rounded-lg text-sm shadow-sm placeholder-slate-400 text-white focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50" placeholder="you@example.com">
                    </div>
                    <div>
                        <label for="auth-password" class="block text-sm font-medium text-slate-200">Password</label>
                        <input type="password" id="auth-password" required minlength="6" class="mt-1 block w-full px-3 py-2.5 bg-indigo-800/50 border border-indigo-700 rounded-lg text-sm shadow-sm placeholder-slate-400 text-white focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50" placeholder="">
                        <p id="auth-form-title" class="mt-2 text-xs text-slate-400">
                            Sign in to save your results and track progress.
                        </p>
                    </div>
                </div>
                
                <p id="auth-error-msg" class="mt-4 text-sm text-red-400 text-center h-5"></p>

                <div class="mt-6">
                    <button id="auth-submit-btn" type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-black bg-cyan-500 hover:bg-cyan-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition-all transform hover:scale-105 font-semibold">
                        Sign In
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- 
      Firebase & App Logic
      =================================
    -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth,
            onAuthStateChanged,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc,
            addDoc, 
            setDoc,
            collection, 
            query, 
            where, 
            getDocs,
            onSnapshot,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. CONFIGURATION & INITIALIZATION ---

        // Get Firebase config from environment (as per instructions)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'typing-test-bfc52';
        let firebaseConfig;

        try {
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            console.warn("Could not parse __firebase_config. Using fallback config.");
            firebaseConfig = {
                apiKey: "AIzaSyBShyAff_Bloq0sNEZI1nodCbpG28o15Cc", // Note: API keys are public
                authDomain: "typing-test-bfc52.firebaseapp.com",
                projectId: "typing-test-bfc52",
                storageBucket: "typing-test-bfc52.firebasestorage.app",
                messagingSenderId: "1085141695140",
                appId: "1:1085141695140:web:99e34fc659449403ee8431",
                measurementId: "G-HN0V9Y46H9"
            };
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // App-wide state
        let currentView = 'test';
        let userId = null;
        let userResultsListener = null; // To unsubscribe from onSnapshot
        let wpmChart = null; // To hold the chart instance
        let currentAuthMode = 'signin'; // 'signin' or 'signup'
        let currentUserName = null; // Store logged-in user's name
        
        // Dashboard state
        let dashboardAllResults = []; // For the table (sorted new-to-old)
        let dashboardChartData = [];  // For the chart (sorted old-to-new)
        let dashboardChartFilter = 'last20'; // 'last20', 'last7', 'last30', 'all'
        let dashboardCurrentPage = 1;
        const dashboardPageSize = 10; // 10 results per page
        
        // Leaderboard state
        let leaderboardAllResults = [];
        let leaderboardCurrentPage = 1;
        const leaderboardPageSize = 10; // 10 results per page
        let leaderboardFilter = { mode: 'time', duration: 30, wordCount: 0 }; // Default filter
         let botRaceState = {
            active: false,
            difficulty: 'easy', // 'easy', 'medium', 'hard', 'pro'
            text: "",
            letters: [],
            totalLetters: 0,
            timerInterval: null,
            botInterval: null,
            startTime: null,
            
            // Player stats
            playerIndex: 0,
            playerMistakes: 0,
            playerCorrectStrokes: 0,
            playerTotalStrokes: 0,
            playerFinished: false,
            
            // Bot stats
            botIndex: 0,
            botTargetWPM: 40,
            botFinished: false,
        };
        // DOM Elements
        const views = document.querySelectorAll('.view');
        const navLinks = document.querySelectorAll('.nav-link');
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        // Auth UI
        const authContainer = document.getElementById('auth-container');
        const showAuthModalBtn = document.getElementById('show-auth-modal-btn');
        const userInfo = document.getElementById('user-info');
        const userProfileBtn = document.getElementById('user-profile-btn');
        const userProfileDropdown = document.getElementById('user-profile-dropdown');
        const userNameDisplay = document.getElementById('user-name-display');
        const userEmailDisplay = document.getElementById('user-email-display');
        const signOutBtn = document.getElementById('sign-out-btn');
        
        const authModal = document.getElementById('auth-modal');
        const closeAuthModalBtn = document.getElementById('close-auth-modal-btn');
        const authTabSignin = document.getElementById('auth-tab-signin');
        const authTabSignup = document.getElementById('auth-tab-signup');
        
        // Auth Form UI
        const authForm = document.getElementById('auth-form');
        const authNameGroup = document.getElementById('auth-name-group');
        const authName = document.getElementById('auth-name');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authFormTitle = document.getElementById('auth-form-title');
        const authErrorMsg = document.getElementById('auth-error-msg');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
      // ADD NEW BOT RACE DOM ELEMENTS
        const botRaceConfigPanel = document.getElementById('bot-race-config-panel'); // <-- FIX: Added this line
        const botRaceView = document.getElementById('bot-race-view');
        const botDifficultyOptions = document.getElementById('bot-difficulty-options');
        const startBotRaceBtn = document.getElementById('start-bot-race-btn');
        const botRaceTrack = document.getElementById('bot-race-track');
        const playerProgress = document.getElementById('player-progress');
        const botProgress = document.getElementById('bot-progress');
        const playerWPMDisplay = document.getElementById('player-race-wpm');
        const botWPMDisplay = document.getElementById('bot-race-wpm');
        const botRaceCountdown = document.getElementById('bot-race-countdown');
        const botRaceCountdownText = document.getElementById('bot-race-countdown-text');
        const botRaceFinished = document.getElementById('bot-race-finished');
        const botRaceResultText = document.getElementById('bot-race-result-text');
        const botRaceRestartBtn = document.getElementById('bot-race-restart-btn');
        const botRaceTypingArea = document.getElementById('bot-race-typing-area');
        const botRaceWordsContainer = document.getElementById('bot-race-words-container');
        const botRaceInput = document.getElementById('bot-race-input');
        // END NEW BOT RACE DOM ELEMENTS

        // --- MODAL STATE CHECKER (NEW) ---
        function isModalOpen() {
            return !resultsModal.classList.contains('hidden') || !authModal.classList.contains('hidden');
        }
        // --- END MODAL STATE CHECKER ---
        
        // --- 2. AUTHENTICATION & NAVIGATION ---

        /**
         * Sets up the authentication state listener.
         */
        function setupAuth() {
            onAuthStateChanged(auth, async (user) => { // Make async
                if (user) {
                    // User is signed in
                    userId = user.uid;
                    
                    let userName = user.displayName || user.email.split('@')[0];
                    
                    // --- FIX for Race Condition ---
                    // Set currentUserName to a synchronous fallback name IMMEDIATELY.
                    // This ensures that if a test is saved before the async profile fetch completes,
                    // it uses the displayName or email prefix instead of null (which becomes "Anonymous").
                    currentUserName = userName; 
                    // --- END FIX ---

                    const userProfilePath = `/artifacts/${appId}/users/${userId}/profile/info`;
                    try {
                        const docRef = doc(db, userProfilePath);
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists() && docSnap.data().name) {
                            userName = docSnap.data().name;
                        } else if (user.displayName) {
                            userName = user.displayName;
                        }
                    } catch (e) {
                        console.error("Error fetching user profile:", e);
                    }

                    console.log('User authenticated:', userId, user.email, userName);
                    currentUserName = userName; // Set the global variable again with the (potentially) better name
                    
                    // Update header UI
                    userNameDisplay.textContent = userName;
                    userEmailDisplay.textContent = user.email;
                    userEmailDisplay.title = `Logged in as ${user.email}`;
                    userInfo.classList.remove('hidden');
                    userInfo.classList.add('relative');
                    showAuthModalBtn.classList.add('hidden');
                    
                    authModal.classList.add('hidden');
                    
                    // Call navigation from the hashchange handler on load, not here.
                    // navigateTo(currentView, true);
                    
                } else {
                    // User is signed out
                    console.log('User not signed in.');
                    userId = null;
                    currentUserName = null; // Clear user's name
                    
                    // Update header UI
                    userNameDisplay.textContent = '';
                    userEmailDisplay.textContent = '';
                    userInfo.classList.add('hidden');
                    userInfo.classList.remove('relative');
                    showAuthModalBtn.classList.remove('hidden');
                    userProfileDropdown.classList.add('hidden');
                    
                    if (currentView === 'dashboard' || currentView === 'lessons') {
                        // If the user logs out and is on a restricted page, redirect home
                        window.location.hash = 'home';
                    }
                    
                    if (userResultsListener) {
                        userResultsListener();
                        userResultsListener = null;
                    }
                    document.getElementById('dashboard-results-table').innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-500">Please log in to see your results.</td></tr>';
                }
                 if (botRaceState.active) {
                resetBotRace(true); // true = force reset
            }
            });
        }

        /**
         * Handles navigation between views (SPA logic).
         * @param {string} viewName - The name of the view to show (e.g., 'home', 'test').
         * @param {boolean} [forceLoad=false] - Force data reload even if view is the same.
         */
        function navigateTo(viewName, forceLoad = false) {
            const oldView = currentView;
            
            // If user is in a lesson (which uses the 'test' view) and clicks 'Test',
            // they mean to *leave* the lesson and go to the real test view.
            if (viewName === 'test' && currentView === 'test' && testState.mode === 'lesson') {
                console.log("User manually navigated from Lesson to Test view. Resetting mode.");
                testState.mode = 'time'; // Default back to time
                testState.currentLessonId = null;
                testState.duration = 30; // Default duration
                testState.difficulty = 'easy';
            }
            
            if (!viewName || (viewName === currentView && !forceLoad)) {
                return;
            }
            
            console.log(`Navigating to: ${viewName}`);
            currentView = viewName;

            // Update views
            views.forEach(view => {
                view.classList.toggle('active', view.id === `${viewName}-view`);
            });

            // Update nav link styles
            navLinks.forEach(link => {
                const isCurrent = link.dataset.view === viewName;
                // --- FIX for lesson highlight: if currentView is 'test' but mode is 'lesson', highlight lessons tab ---
                const isLessonContext = currentView === 'test' && testState.mode === 'lesson' && link.dataset.view === 'lessons';
                const isBotRaceContext = currentView === 'bot-race' && link.dataset.view === 'bot-race';
                
                link.classList.toggle('text-cyan-400', isCurrent || isLessonContext || isBotRaceContext); // Uses CSS var for gold
                link.classList.toggle('bg-cyan-500/10', isCurrent || isLessonContext || isBotRaceContext); // Uses CSS var for gold bg
                link.classList.toggle('text-slate-300', !(isCurrent || isLessonContext || isBotRaceContext));
                // END ADD
                link.classList.toggle('text-cyan-400', isCurrent || isLessonContext); // Uses CSS var for gold
                link.classList.toggle('bg-cyan-500/10', isCurrent || isLessonContext); // Uses CSS var for gold bg
                link.classList.toggle('text-slate-300', !(isCurrent || isLessonContext));
            });
            
            mobileMenu.classList.add('hidden');

            if (viewName !== 'dashboard' && userResultsListener) {
                console.log("Unsubscribing from user results listener.");
                userResultsListener();
                userResultsListener = null;
                
                if (wpmChart) {
                    console.log("Destroying dashboard chart.");
                    wpmChart.destroy();
                    wpmChart = null;
                }
                // Reset dashboard state
                dashboardAllResults = [];
                dashboardCurrentPage = 1;
            }

            if (viewName !== 'leaderboard') {
                leaderboardAllResults = [];
                leaderboardCurrentPage = 1;
            }

            // --- Auth Check ---
            // If the user is navigating to a restricted page without auth, redirect them to the home page hash.
            if ((viewName === 'dashboard' || viewName === 'lessons') && !userId) {
                console.log(`Auth required for ${viewName}. Showing login modal.`);
                authModal.classList.remove('hidden');
                // Set hash back to the previous view (or home if there was no previous view)
                window.location.hash = oldView || 'home'; 
                return;
            }
            // --- End Auth Check ---

            // Load data for the new view
            switch (viewName) {
                case 'test':
                    // Show/hide test config based on mode
                    const testConfig = document.getElementById('test-config-panel');
                    const lessonInstructions = document.getElementById('lesson-instructions');
                    const keyboardContainer = document.getElementById('keyboard-container'); 
                    
                    if (testState.mode === 'lesson') {
                        testConfig.classList.add('hidden');
                        lessonInstructions.classList.remove('hidden');
                        keyboardContainer.classList.remove('hidden'); 
                    } else {
                        testConfig.classList.remove('hidden');
                        lessonInstructions.classList.add('hidden');
                        keyboardContainer.classList.add('hidden'); 
                    }
                    resetTest();
                    break;
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'leaderboard':
                    loadLeaderboardData();
                    break;
                case 'lessons': 
                    renderLessonDashboard();
                    break;
                case 'bot-race':
                    resetBotRace(true); // force reset to show config
                    break;
                case 'home':
                    // Reset test mode if navigating away from a lesson
                    if(testState.mode === 'lesson') {
                        testState.mode = 'time'; // Default back to time
                        testState.currentLessonId = null;
                        testState.duration = 30;
                        testState.difficulty = 'easy';
                    }
                    document.getElementById('keyboard-container').classList.add('hidden');
                    // Create icons for new features section
                    lucide.createIcons(); 
                    break;
            }
        }

        // --- 3. FIRESTORE DATA ---

        /**
         * Saves a completed test result to both private (user) and public (leaderboard) collections.
         * @param {object} result - The result object {wpm, accuracy, mode, duration, etc.}.
         */
        async function saveResultToFirebase(result) {
            if (!userId) {
                console.log("User not authenticated. Prompting to sign in.");
                authModal.classList.remove('hidden');
                return;
            }

            const timestamp = serverTimestamp();
            const resultData = {
                ...result,
                userId,
                userName: currentUserName || `Anonymous (${userId.substring(0, 4)})`, // Add username
                timestamp
            };

            try {
                // 1. Save to user's private collection
                const userResultsPath = `/artifacts/${appId}/users/${userId}/results`;
                const userDocRef = await addDoc(collection(db, userResultsPath), resultData);
                console.log("Result saved to user collection:", userDocRef.id);

                // 2. Save to public leaderboard (only if it's a standard mode)
                const isTimeMode = result.mode === 'time' && [15, 30, 60].includes(result.duration);
                const isWordMode = result.mode === 'words' && [10, 25, 50].includes(result.wordCount);
                
                if ((isTimeMode || isWordMode) && result.difficulty === 'easy') {
                    const leaderboardPath = `/artifacts/${appId}/public/data/leaderboard`;
                    const leaderboardDocRef = await addDoc(collection(db, leaderboardPath), resultData);
                    console.log("Result saved to leaderboard:", leaderboardDocRef.id);
                }
                
                // 3. Save lesson progress
                if (result.mode === 'lesson' && result.accuracy >= 95) { // Pass criteria
                    const lessonProgressPath = `/artifacts/${appId}/users/${userId}/lessonProgress/${result.lessonId}`;
                    await setDoc(doc(db, lessonProgressPath), {
                        lessonId: result.lessonId,
                        passed: true,
                        accuracy: result.accuracy,
                        wpm: result.wpm,
                        timestamp: timestamp
                    });
                    console.log("Lesson progress saved:", result.lessonId);
                }
                
            } catch (error) {
                console.error("Error saving result to Firestore:", error);
            }
        }

        /**
         * Loads and displays the user's private results on the dashboard.
         * Uses onSnapshot for real-time updates.
         */
        function loadDashboardData() {
            const tableBody = document.getElementById('dashboard-results-table');
            
            // KPI Elements
            const kpiAvgWpm = document.getElementById('kpi-avg-wpm');
            const kpiBestWpm = document.getElementById('kpi-best-wpm');
            const kpiTotalTests = document.getElementById('kpi-total-tests');
            const kpiAvgAcc = document.getElementById('kpi-avg-acc');
            const paginationControls = document.getElementById('dashboard-pagination-controls');

            if (!userId) {
                tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-400">Please log in to see your results.</td></tr>';
                // Reset KPIs
                kpiAvgWpm.textContent = '0';
                kpiBestWpm.textContent = '0';
                kpiTotalTests.textContent = '0';
                kpiAvgAcc.textContent = '0%';
                paginationControls.classList.add('hidden'); // Hide pagination
                return;
            }

            if (userResultsListener) {
                userResultsListener();
            }

            tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-400">Loading results...</td></tr>';
            
            const userResultsPath = `/artifacts/${appId}/users/${userId}/results`;
            const q = query(collection(db, userResultsPath));

            userResultsListener = onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-slate-400">No results yet. Go take a test!</td></tr>';
                    // Reset KPIs
                    kpiAvgWpm.textContent = '0';
                    kpiBestWpm.textContent = '0';
                    kpiTotalTests.textContent = '0';
                    kpiAvgAcc.textContent = '0%';
                    paginationControls.classList.add('hidden'); // Hide pagination
                    return;
                }

                let results = [];
                querySnapshot.forEach((doc) => {
                    results.push(doc.data());
                });

                results.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0)); // Sort old to new for chart
                
                dashboardChartData = results; // Store chart-sorted data

                // Calculate KPIs (using all results)
                let totalWpm = 0;
                let totalAcc = 0;
                let bestWpm = 0;
                results.forEach(res => {
                    totalWpm += res.wpm;
                    totalAcc += res.accuracy;
                    if (res.wpm > bestWpm) {
                        bestWpm = res.wpm;
                    }
                });
                
                const totalTests = results.length;
                const avgWpm = totalTests > 0 ? (totalWpm / totalTests).toFixed(0) : 0;
                const avgAcc = totalTests > 0 ? (totalAcc / totalTests).toFixed(1) : 0;
                
                // Update KPI DOM
                kpiAvgWpm.textContent = avgWpm;
                kpiBestWpm.textContent = bestWpm;
                kpiTotalTests.textContent = totalTests;
                kpiAvgAcc.textContent = `${avgAcc}%`;

                // Render chart (will use global dashboardChartData and dashboardChartFilter)
                renderDashboardChart();

                // --- Table (paginated) ---
                // Re-sort new to old for table
                results.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); 
                
                dashboardAllResults = results; // Store table-sorted results
                dashboardCurrentPage = 1; // Reset to page 1
                
                renderDashboardTable(); // New function to render table and pagination
                paginationControls.classList.remove('hidden'); // Show pagination

            }, (error) => {
                console.error("Error fetching user results:", error);
                tableBody.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-red-400">Error loading results.</td></tr>';
            });
        }

        /**
         * Renders the paginated dashboard results table and pagination controls.
         */
        function renderDashboardTable() {
            const tableBody = document.getElementById('dashboard-results-table');
            const prevBtn = document.getElementById('dash-prev-btn');
            const nextBtn = document.getElementById('dash-next-btn');
            const pageInfo = document.getElementById('dash-page-info');

            const totalResults = dashboardAllResults.length;
            const totalPages = Math.ceil(totalResults / dashboardPageSize);
            
            // Ensure currentPage is valid
            if (dashboardCurrentPage < 1) dashboardCurrentPage = 1;
            if (dashboardCurrentPage > totalPages) dashboardCurrentPage = totalPages;

            const startIndex = (dashboardCurrentPage - 1) * dashboardPageSize;
            const endIndex = startIndex + dashboardPageSize;
            
            const paginatedResults = dashboardAllResults.slice(startIndex, endIndex);

            // Render table rows
            tableBody.innerHTML = paginatedResults.map(res => {
                const date = res.timestamp ? new Date(res.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                let mode;
                if (res.mode === 'time') mode = `${res.duration}s (${res.difficulty || 'easy'})`;
                else if (res.mode === 'words') mode = `${res.wordCount}w (${res.difficulty || 'easy'})`;
                else if (res.mode === 'lesson') mode = `Lesson: ${res.lessonId}`;
                else if (res.mode === 'code') mode = `Code`;
                else mode = 'Quote';

                return `
                    <tr class="hover:bg-indigo-800/60">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-lg font-semibold text-cyan-400">${res.wpm}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${res.accuracy > 95 ? 'text-green-400' : 'text-amber-400'}">${res.accuracy.toFixed(1)}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${mode}</td>
                    </tr>
                `;
            }).join('');
            
            // Update pagination controls
            pageInfo.textContent = `Page ${dashboardCurrentPage} of ${totalPages || 1}`;
            
            if (dashboardCurrentPage === 1) {
                prevBtn.disabled = true;
            } else {
                prevBtn.disabled = false;
            }
            
            if (dashboardCurrentPage === totalPages || totalPages === 0) {
                nextBtn.disabled = true;
            } else {
                nextBtn.disabled = false;
            }
        }

        /**
         * Renders the WPM/Accuracy progress chart on the dashboard.
         * @param {Array} results - Array of user result objects, sorted old to new.
         */
        function renderDashboardChart() {
            const ctx = document.getElementById('wpm-progress-chart');
            if (!ctx) return;
            
            // Destroy previous chart if it exists
            if (wpmChart) {
                wpmChart.destroy();
            }

            if (!dashboardChartData || dashboardChartData.length === 0) {
                // Optionally render an "empty" state, for now just return
                return;
            }

            // --- NEW: Filter data based on the current filter state ---
            const now = new Date();
            const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            let filteredResults;

            switch (dashboardChartFilter) {
                case 'last7':
                    filteredResults = dashboardChartData.filter(r => r.timestamp && new Date(r.timestamp.seconds * 1000) >= sevenDaysAgo);
                    break;
                case 'last30':
                    filteredResults = dashboardChartData.filter(r => r.timestamp && new Date(r.timestamp.seconds * 1000) >= thirtyDaysAgo);
                    break;
                case 'all':
                default:
                    filteredResults = dashboardChartData;
                    break;
                case 'last20':
                    filteredResults = dashboardChartData.slice(-20); // Show last 20 results
                    break;
            }
            // --- END: Filter data ---

            const chartData = filteredResults; // Use the filtered data
            
            const labels = chartData.map(res => res.timestamp ? new Date(res.timestamp.seconds * 1000).toLocaleDateString() : 'N/A');
            const wpmData = chartData.map(res => res.wpm);
            const accData = chartData.map(res => res.accuracy);

            // Destroy previous chart if it exists
            if (wpmChart) {
                wpmChart.destroy();
            }

            wpmChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'WPM',
                            data: wpmData,
                            borderColor: 'var(--color-gold)',
                            backgroundColor: 'rgba(212, 175, 55, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y',
                        },
                        {
                            label: 'Accuracy',
                            data: accData,
                            borderColor: 'var(--color-text-mid)',
                            backgroundColor: 'rgba(160, 160, 160, 0.1)',
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y1',
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { color: '#A0A0A0' }, // var(--color-text-mid)
                            grid: { color: 'rgba(255, 255, 255, 0.1)' } // var(--color-glass-border)
                        },
                        y: { // WPM axis
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: { color: '#D4AF37', font: { weight: 'bold' } }, // var(--color-gold)
                            grid: { color: 'rgba(255, 255, 255, 0.1)' } // var(--color-glass-border)
                        },
                        y1: { // Accuracy axis
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 50,
                            max: 100,
                            ticks: { 
                                color: '#A0A0A0', // var(--color-text-mid)
                                callback: function(value) { return value + '%'; }
                            },
                            grid: { display: false } // Hide grid for 2nd axis
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#F5F5F5' } // var(--color-text-light)
                        },
                        tooltip: {
                            backgroundColor: '#111111', // var(--color-onyx)
                            titleColor: '#F5F5F5', // var(--color-text-light)
                            bodyColor: '#A0A0A0', // var(--color-text-mid)
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    }
                }
            });
        }

        /**
         * Gets the appropriate icon for the leaderboard rank.
         * @param {number} index - The zero-based rank index.
         * @returns {string} - HTML string for the Lucide icon.
         */
        function getRankIcon(index) {
            if (index === 0) {
                return `<i data-lucide="trophy" class="w-5 h-5 text-yellow-500"></i>`;
            }
            if (index === 1) {
                return `<i data-lucide="award" class="w-5 h-5 text-slate-400"></i>`;
            }
            if (index === 2) {
                return `<i data-lucide="medal" class="w-5 h-5 text-yellow-700"></i>`;
            }
            return `<span class="text-sm font-semibold text-slate-200">${index + 1}</span>`;
        }

        /**
         * Loads and displays the public leaderboard data.
         * Fetches once (no real-time listener).
         */
        async function loadLeaderboardData() {
            const tableBody = document.getElementById('leaderboard-table');
            const paginationControls = document.getElementById('leaderboard-pagination-controls');
            const filterDesc = document.getElementById('leaderboard-filter-desc');
            
            tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400">Loading leaderboard...</td></tr>';
            paginationControls.classList.add('hidden');
            
            let filterText = '';

            try {
                const leaderboardPath = `/artifacts/${appId}/public/data/leaderboard`;
                
                // Build dynamic query based on filter
                let q_filters = [
                    where("mode", "==", leaderboardFilter.mode),
                    where("difficulty", "==", "easy") // Only show 'easy' on public board
                ];
                
                if (leaderboardFilter.mode === 'time') {
                    q_filters.push(where("duration", "==", leaderboardFilter.duration));
                    filterText = `${leaderboardFilter.duration}s Time`;
                } else if (leaderboardFilter.mode === 'words') {
                    q_filters.push(where("wordCount", "==", leaderboardFilter.wordCount));
                    filterText = `${leaderboardFilter.wordCount}w Words`;
                }
                
                // Update filter description text
                filterDesc.textContent = `Showing top results for the ${filterText} mode.`;

                const q = query(collection(db, leaderboardPath), ...q_filters);
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-slate-400">Leaderboard is empty. Be the first!</td></tr>';
                    return;
                }

                let results = [];
                querySnapshot.forEach((doc) => {
                    results.push(doc.data());
                });
                
                // --- FIX FOR DUPLICATE ENTRIES ---
                // 1. Find the best score for each unique user
                const userBestScores = {};
                results.forEach(result => {
                    if (!result.userId) return; // Skip entries without a userId
                    
                    const existingBest = userBestScores[result.userId];
                    
                    if (!existingBest || result.wpm > existingBest.wpm) {
                        // If this user has no entry yet, or if this score is better, save it
                        userBestScores[result.userId] = result;
                    } else if (result.wpm === existingBest.wpm) {
                        // If WPM is the same, prefer the one with higher accuracy
                        if (result.accuracy > existingBest.accuracy) {
                             userBestScores[result.userId] = result;
                        }
                    }
                });
                
                // 2. Convert the userBestScores object back into an array
                const uniqueBestResults = Object.values(userBestScores);

                // 3. Sort the unique best results by WPM (high to low)
                uniqueBestResults.sort((a, b) => b.wpm - a.wpm);
                // --- END FIX ---

                leaderboardAllResults = uniqueBestResults; // Use the processed, unique results
                leaderboardCurrentPage = 1;
                
                renderLeaderboardTable(); // New function to render table
                paginationControls.classList.remove('hidden');

            } catch (error) {
                console.error("Error fetching leaderboard:", error);
                tableBody.innerHTML = '<tr><td colspan="5" class="px-6 py-12 text-center text-red-400">Error loading leaderboard.</td></tr>';
            }
        }
        
        /**
         * Renders the paginated leaderboard table and pagination controls.
         */
        function renderLeaderboardTable() {
            const tableBody = document.getElementById('leaderboard-table');
            const prevBtn = document.getElementById('lead-prev-btn');
            const nextBtn = document.getElementById('lead-next-btn');
            const pageInfo = document.getElementById('lead-page-info');

            const totalResults = leaderboardAllResults.length;
            const totalPages = Math.ceil(totalResults / leaderboardPageSize);
            
            // Ensure currentPage is valid
            if (leaderboardCurrentPage < 1) leaderboardCurrentPage = 1;
            if (leaderboardCurrentPage > totalPages) leaderboardCurrentPage = totalPages;

            const startIndex = (leaderboardCurrentPage - 1) * leaderboardPageSize;
            const endIndex = startIndex + leaderboardPageSize;
            
            const paginatedResults = leaderboardAllResults.slice(startIndex, endIndex);

            // Render table rows
            tableBody.innerHTML = paginatedResults.map((res, index) => {
                const globalRank = startIndex + index;
                const rankIcon = getRankIcon(globalRank);
                const date = res.timestamp ? new Date(res.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';
                
                return `
                    <tr class="hover:bg-indigo-800/60 ${globalRank === 0 ? 'bg-yellow-500/10' : ''}">
                        <td class="px-6 py-4 whitespace-nowrap w-16 text-center">${rankIcon}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-300 font-semibold">${res.userName || 'Anonymous'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-lg font-semibold text-cyan-400">${res.wpm}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${res.accuracy > 95 ? 'text-green-400' : 'text-amber-400'}">${res.accuracy.toFixed(1)}%</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-400">${date}</td>
                    </tr>
                `;
            }).join('');
            
            // Update pagination controls
            pageInfo.textContent = `Page ${leaderboardCurrentPage} of ${totalPages || 1}`;
            
            prevBtn.disabled = leaderboardCurrentPage === 1;
            nextBtn.disabled = leaderboardCurrentPage === totalPages || totalPages === 0;
            
            // After injecting HTML, create icons
            lucide.createIcons();
        }

        // --- 4. i18N (INTERNATIONALIZATION) STUB ---

        const translations = {
            en: {
                hero_title: "Master the Keyboard. <br class='hidden md:block'> <span class='text-cyan-400'>Unlock Your Speed.</span>",
                hero_subtitle: "Join millions of typists and improve your typing speed and accuracy with our real-time tests, structured lessons, and global leaderboards.",
                hero_cta: "Start Typing Test",
                hero_cta_alt: "Browse Lessons",
                test_mode: "Mode:",
                stat_time: "Time",
                stat_wpm: "WPM",
                stat_acc: "Accuracy",
                stat_raw: "Raw",
                stat_errors: "Errors",
                test_start_prompt: "Click or start typing to begin",
                dash_title: "My Dashboard",
                dash_progress: "WPM Progress",
                dash_history: "My Results History",
                lead_title: "Global Leaderboard",
                lesson_title: "Typing Lessons",
                results_title: "Test Complete!",
                results_lesson_title: "Lesson Complete!",
                results_wpm: "WPM",
                results_raw_wpm: "Raw WPM",
                results_acc: "Accuracy",
                results_chars: "Characters",
                results_mistakes: "Mistakes",
                results_retry: "Try Again",
                results_next: "Next Test",
                results_next_lesson: "Next Lesson",
                results_back_to_lessons: "Back to Lessons"
            },
            bn: {
                hero_title: "   <br class='hidden md:block'> <span class='text-cyan-400'>   </span>",
                hero_subtitle: "        - , ,           ",
                hero_cta: "   ",
                hero_cta_alt: "  ",
                test_mode: ":",
                stat_time: "",
                stat_wpm: "WPM",
                stat_acc: "",
                stat_raw: "Raw",
                stat_errors: "",
                test_start_prompt: "      ",
                dash_title: " ",
                dash_progress: "WPM ",
                dash_history: "  ",
                lead_title: " ",
                lesson_title: " ",
                results_title: " !",
                results_lesson_title: " !",
                results_wpm: "WPM",
                results_raw_wpm: "Raw WPM",
                results_acc: "",
                results_chars: "",
                results_mistakes: "",
                results_retry: "  ",
                results_next: " ",
                results_next_lesson: " ",
                results_back_to_lessons: "   "
            }
        };

        let currentLanguage = 'en';

        function setLanguage(lang) {
            if (!translations[lang]) return;
            currentLanguage = lang;
            
            // Update buttons
            document.getElementById('lang-en').classList.toggle('bg-slate-200', lang === 'en');
            document.getElementById('lang-en').classList.toggle('text-slate-900', lang === 'en');
            document.getElementById('lang-en').classList.toggle('z-10', lang === 'en');
            document.getElementById('lang-en').classList.toggle('bg-white', lang !== 'en');
            document.getElementById('lang-en').classList.toggle('text-slate-500', lang !== 'en');

            document.getElementById('lang-bn').classList.toggle('bg-slate-200', lang === 'bn');
            document.getElementById('lang-bn').classList.toggle('text-slate-900', lang === 'bn');
            document.getElementById('lang-bn').classList.toggle('z-10', lang === 'bn');
            document.getElementById('lang-bn').classList.toggle('bg-indigo-900', lang !== 'bn');
            document.getElementById('lang-bn').classList.toggle('text-slate-300', lang !== 'bn');

            // Update text
            document.querySelectorAll('[data-i18n-key]').forEach(el => {
                const key = el.dataset.i18nKey;
                if (translations[lang][key]) {
                    el.innerHTML = translations[lang][key];
                }
            });
            
            if (currentView === 'test') {
                resetTest();
            }
        }


        // --- 5. TYPING TEST LOGIC ---

        // DOM elements for test
        const testModeOptions = document.getElementById('test-mode-options');
        const testDifficultyOptions = document.getElementById('test-difficulty-options');
        const restartTestBtn = document.getElementById('restart-test-btn');
        const statsContainer = document.getElementById('stats-container');
        const statTime = document.getElementById('stat-time');
        const statWPM = document.getElementById('stat-wpm');
        const statAcc = document.getElementById('stat-acc');
        const statRaw = document.getElementById('stat-raw');
        const statErrors = document.getElementById('stat-errors');
        const wordsContainer = document.getElementById('words-container');
        const mainInput = document.getElementById('main-input');
        const focusPrompt = document.getElementById('focus-prompt');
        const resultsModal = document.getElementById('results-modal');
        const resultsModalContent = document.getElementById('results-modal-content');
        
        // Lesson UI Elements
        const lessonStagesContainer = document.getElementById('lesson-stages-container');
        const lessonInstructions = document.getElementById('lesson-instructions');
        const lessonTitle = document.getElementById('lesson-title').querySelector('span');
        const lessonPrompt = document.getElementById('lesson-prompt');
        
        // Text bank
        const wordBanks = {
            en: {
                time_easy: "the of to and a in is it you that he was for on are with as I his they be at one have this from or had by hot but some what there we can out other were all your when up use word how said an each she which do their time if will way about many then them write would like so these her long make thing see him two has look more day could go come did number sound no most people my over know water than call first who may down side been now find".split(" "),
                time_hard: "community development information technology resources communication understanding relationships responsibility organization establishment environment performance knowledge university opportunity challenge experience government structure application management classification measurement department psychology perspective technology analysis approach definition function distribution philosophy consciousness significance methodology".split(" "),
                quote: [
                    "The quick brown fox jumps over the lazy dog.",
                    "Success is not final, failure is not fatal: it is the courage to continue that counts.",
                    "The only way to do great work is to love what you do.",
                    "To be, or not to be, that is the question."
                ],
                code: [
                    "const add = (a, b) => a + b;",
                    "function hello() { console.log('Hello, World!'); }",
                    "for (let i = 0; i < 10; i++) { ... }",
                    "document.getElementById('my-id');",
                    "import React from 'react';",
                    "SELECT * FROM users WHERE id = 1;",
                    "public static void main(String[] args) { ... }",
                    "if (x > y) { return x; } else { return y; }"
                ]
            },
            bn: {
                time_easy: "                             ".split(" "),
                time_hard: "              ".split(" "),
                quote: [
                    "        ",
                    "  ,   :     ",
                    "     "
                ],
                code: [ // Same code snippets, i18n for code isn't really a thing
                    "const add = (a, b) => a + b;",
                    "function hello() { console.log('Hello, World!'); }",
                    "for (let i = 0; i < 10; i++) { ... }",
                ]
            }
        };

        // Test state
        let testState = {
            active: false,
            mode: 'time', // 'time', 'words', 'quote', 'code', 'lesson'
            difficulty: 'easy', // 'easy', 'hard'
            duration: 30,  // for 'time' mode
            wordCount: 0, // for 'words' mode
            currentLessonId: null,
            timer: 30, // current value of the timer
            timerInterval: null,
            textToType: "",
            letters: [],
            currentLetterIndex: 0,
            currentWordIndex: 0,
            mistakes: 0,
            correctStrokes: 0,
            totalStrokes: 0,
            rawStrokes: 0,
            startTime: null
        };

        /**
         * Generates and returns a string of text for the test.
         */
        function getTestText() {
            // 1. Handle lesson mode
            if (testState.mode === 'lesson' && testState.currentLessonId) {
                const lesson = findLessonById(testState.currentLessonId);
                if (lesson) {
                    return lesson.text;
                }
            }
            
            const langBank = wordBanks[currentLanguage] || wordBanks.en;
            
            // 2. Handle quote mode
            if (testState.mode === 'quote') {
                const randIndex = Math.floor(Math.random() * langBank.quote.length);
                return langBank.quote[randIndex];
            }
            
            // 3. Handle code mode
            if (testState.mode === 'code') {
                const randIndex = Math.floor(Math.random() * langBank.code.length);
                return langBank.code[randIndex];
            }

            // 4. Handle time or words mode
            const wordList = (testState.difficulty === 'hard') 
                ? (langBank.time_hard || langBank.time_easy) 
                : langBank.time_easy;
                
            let words = [];
            const count = (testState.mode === 'words') ? testState.wordCount : 100; // 100 words for time mode
            
            for (let i = 0; i < count; i++) {
                words.push(wordList[Math.floor(Math.random() * wordList.length)]);
            }
            return words.join(' ');
        }

        /**
         * Renders the test text into the DOM as individual letter spans.
         */
        function renderWords() {
            wordsContainer.innerHTML = '';
            
            // Apply mode-specific styles
            if (testState.mode === 'code') {
                wordsContainer.classList.add('font-mono');
            } else {
                wordsContainer.classList.remove('font-mono');
            }
            
            testState.letters = [];
            testState.textToType = getTestText();
            
            if (!testState.textToType) {
                console.error("No text to type!");
                return;
            }

            const words = testState.textToType.split(' ');
            let letterIndex = 0;

            words.forEach((word, w_idx) => {
                const wordSpan = document.createElement('span');
                wordSpan.className = 'word inline-block mr-3'; // Use margin for space
                wordSpan.id = `word-${w_idx}`;
                
                for (let l_idx = 0; l_idx < word.length; l_idx++) {
                    const letter = word[l_idx];
                    const letterSpan = document.createElement('span');
                    letterSpan.className = 'letter';
                    letterSpan.id = `letter-${letterIndex}`;
                    letterSpan.textContent = letter;
                    wordSpan.appendChild(letterSpan);
                    testState.letters.push(letterSpan);
                    letterIndex++;
                }

                // Add space (unless it's the last word)
                if (w_idx < words.length - 1) {
                    const spaceSpan = document.createElement('span');
                    spaceSpan.className = 'letter';
                    spaceSpan.id = `letter-${letterIndex}`;
                    spaceSpan.innerHTML = '&nbsp;';
                    wordSpan.appendChild(spaceSpan);
                    testState.letters.push(spaceSpan);
                    letterIndex++;
                }

                wordsContainer.appendChild(wordSpan);
            });
            
            if (testState.letters.length > 0) {
                testState.letters[0].classList.add('caret-left');
            }
        }

        /**
         * Resets the test to its initial state.
         */
        function resetTest() {
            console.log("Resetting test in mode:", testState.mode);
            if (testState.timerInterval) {
                clearInterval(testState.timerInterval);
            }
            
            testState.active = false;
            
            // Handle time/duration
            if (testState.mode === 'time') {
                testState.timer = testState.duration;
            } else if (testState.mode === 'lesson') {
                const lesson = findLessonById(testState.currentLessonId);
                lessonTitle.textContent = lesson.title;
                lessonPrompt.textContent = lesson.prompt;
                testState.timer = 0;
            } else {
                // words, quote, code
                testState.timer = 0;
            }
            
            testState.timerInterval = null;
            testState.currentLetterIndex = 0;
            testState.currentWordIndex = 0;
            testState.mistakes = 0;
            testState.correctStrokes = 0;
            testState.totalStrokes = 0;
            testState.rawStrokes = 0;
            testState.startTime = null;

            statTime.textContent = testState.timer;
            statWPM.textContent = 0;
            statAcc.textContent = '100%';
            statRaw.textContent = 0;
            statErrors.textContent = 0;
            
            renderWords();
            
            // --- UX FIX ---
            // Ensure the words container is scrolled to the top for the new test
            wordsContainer.scrollTop = 0; 
            // --- End UX Fix ---
            
            focusPrompt.classList.remove('hidden');
            focusPrompt.style.opacity = 1; // Ensure it's visible
            mainInput.value = '';
            resultsModal.classList.add('hidden');
        }

        /**
         * Starts the test timer and sets state to active.
         */
        function startTest() {
            if (testState.active) return;
            
            testState.active = true;
            testState.startTime = new Date().getTime();
            focusPrompt.style.opacity = 0; // Fade out
            setTimeout(() => focusPrompt.classList.add('hidden'), 300);

            if (testState.mode === 'time') {
                testState.timerInterval = setInterval(updateTime_countdown, 1000);
            } else {
                // words, quote, code, lesson
                testState.timerInterval = setInterval(updateTime_countup, 1000);
            }
        }

        /**
         * Timer function for 'time' mode (counts down).
         */
        function updateTime_countdown() {
            testState.timer--;
            statTime.textContent = testState.timer;
            
            updateStats(); // Update stats every second

            if (testState.timer <= 0) {
                endTest();
            }
        }
        
        /**
         * Timer function for other modes (counts up).
         */
        function updateTime_countup() {
            testState.timer++;
            statTime.textContent = testState.timer;
            updateStats(); // Update stats every second
        }
        
        /**
         * Updates the WPM, Accuracy, Raw, and Error stats in real-time.
         */
        function updateStats() {
            if (!testState.startTime) return;
            
            const now = new Date().getTime();
            const elapsedSeconds = (now - testState.startTime) / 1000;
            
            if (elapsedSeconds === 0) return; // Avoid divide by zero
            
            // Corrected WPM
            const wpm = (testState.correctStrokes / 5) / (elapsedSeconds / 60);
            statWPM.textContent = Math.round(wpm) || 0;
            
            // Raw WPM
            const rawWpm = (testState.rawStrokes / 5) / (elapsedSeconds / 60);
            statRaw.textContent = Math.round(rawWpm) || 0;
            
            // Accuracy
            const accuracy = testState.totalStrokes === 0 ? 100 : (testState.correctStrokes / testState.totalStrokes) * 100;
            statAcc.textContent = `${Math.round(accuracy)}%`;
            
            // Errors
            statErrors.textContent = testState.mistakes;
        }

        /**
         * Main input handler for keypresses.
         */
        function handleKeyInput(e) {
            // --- NEW FIX: Block input if any modal is open ---
            if (isModalOpen()) {
                e.preventDefault();
                return;
            }
            // --- END NEW FIX ---
            
            if (testState.currentLetterIndex >= testState.letters.length) {
                return;
            }

            if (!testState.active) {
                startTest();
            }

            const key = e.key;
            const currentLetterSpan = testState.letters[testState.currentLetterIndex];
            const expectedLetter = currentLetterSpan.textContent.replace('\u00A0', ' ');

            // 1. Handle Backspace
            if (key === 'Backspace') {
                e.preventDefault();
                if (testState.currentLetterIndex > 0) {
                    testState.letters[testState.currentLetterIndex].classList.remove('caret-left');
                    testState.currentLetterIndex--;
                    
                    const newCurrentLetterSpan = testState.letters[testState.currentLetterIndex];
                    
                    // Update stats *down*
                    if (newCurrentLetterSpan.classList.contains('correct')) {
                        testState.correctStrokes--;
                        testState.totalStrokes--;
                    } else if (newCurrentLetterSpan.classList.contains('incorrect')) {
                        testState.mistakes--;
                        testState.totalStrokes--;
                    }
                    testState.rawStrokes--; // Always decrement raw strokes on backspace
                    
                    newCurrentLetterSpan.classList.remove('correct', 'incorrect', 'incorrect-space');
                    newCurrentLetterSpan.classList.add('caret-left');
                }
                return;
            }

            // 2. Ignore non-printable keys
            if (key.length > 1) {
                return;
            }
            
            if (key === ' ') {
                e.preventDefault();
            }

            testState.totalStrokes++;
            testState.rawStrokes++;

            // 3. Handle Correct/Incorrect
            if (key === expectedLetter) {
                currentLetterSpan.classList.add('correct');
                testState.correctStrokes++;
            } else {
                currentLetterSpan.classList.add('incorrect');
                testState.mistakes++;
                if(expectedLetter === ' '){
                    currentLetterSpan.classList.add('incorrect-space');
                }
            }

            // 4. Move Caret
            currentLetterSpan.classList.remove('caret-left');
            testState.currentLetterIndex++;

            // 5. Check for test end
            if (testState.currentLetterIndex >= testState.letters.length) {
                if (testState.mode !== 'time') { // words, quote, code, lesson
                    endTest();
                }
            } else {
                testState.letters[testState.currentLetterIndex].classList.add('caret-left');
                
                // Scroll container
                const caretRect = testState.letters[testState.currentLetterIndex].getBoundingClientRect();
                const containerRect = wordsContainer.getBoundingClientRect();
                
                if (caretRect.bottom > containerRect.bottom - 10) { // 10px buffer
                     wordsContainer.scrollTop += caretRect.height + 16; // 16px buffer
                } else if (caretRect.top < containerRect.top) {
                    wordsContainer.scrollTop -= caretRect.height + 16;
                }
            }
            
            // Update stats live (except for time mode, which updates on interval)
            if (testState.mode !== 'time') {
                updateStats();
            }
        }

        /**
         * Ends the test, calculates final stats, and shows results modal.
         */
        function endTest() {
            if (testState.timerInterval) {
                clearInterval(testState.timerInterval);
                testState.timerInterval = null; // Explicitly nullify
            }
            
            // This guard is the most important part.
            // We set testState.active to false immediately
            // and return if it was *already* false.
            if (!testState.active) return;
            testState.active = false;
            
            mainInput.blur();
            console.log("Test ended.");

            const now = new Date().getTime();
            const exactElapsedSeconds = (now - testState.startTime) / 1000;
            
            // Use test duration for time mode, or exact elapsed time for others
            const wpmCalculationSeconds = (testState.mode === 'time') ? testState.duration : exactElapsedSeconds;

            if (wpmCalculationSeconds === 0) {
                console.log("Test ended too quickly, not saving.");
                resetTest();
                return;
            }

            const wpm = Math.round((testState.correctStrokes / 5) / (wpmCalculationSeconds / 60)) || 0;
            const rawWpm = Math.round((testState.rawStrokes / 5) / (wpmCalculationSeconds / 60)) || 0;
            const accuracy = testState.totalStrokes === 0 ? 100 : (testState.correctStrokes / testState.totalStrokes) * 100;
            const characters = `${testState.correctStrokes}/${testState.totalStrokes - testState.mistakes}/${testState.mistakes}`;

            const result = {
                wpm: wpm,
                rawWpm: rawWpm,
                accuracy: accuracy,
                chars: characters,
                mistakes: testState.mistakes,
                mode: testState.mode,
                difficulty: (testState.mode === 'time' || testState.mode === 'words') ? testState.difficulty : null,
                duration: (testState.mode === 'time') ? testState.duration : Math.round(exactElapsedSeconds),
                wordCount: (testState.mode === 'words') ? testState.wordCount : null,
                lessonId: (testState.mode === 'lesson') ? testState.currentLessonId : null
            };
 
            showResultsModal(result);
            saveResultToFirebase(result);
        }

        /**
         * Populates and displays the results modal.
         * @param {object} result - The final test result object.
         */
        function showResultsModal(result) {
            
            let modalTitle, ctaButton1, ctaButton2;
            const lang = currentLanguage;
            
            // Customize modal for lessons
            if (result.mode === 'lesson') {
                modalTitle = translations[lang].results_lesson_title || 'Lesson Complete!';
                const nextLesson = findNextLesson(result.lessonId);
                
                if (nextLesson && result.accuracy >= 95) { // Pass criteria
                    ctaButton1 = `<button id="modal-next-lesson-btn" data-lesson-id="${nextLesson.id}" class="w-full text-center text-lg font-semibold text-black bg-cyan-500 hover:bg-cyan-400 rounded-lg px-6 py-3 transition-all transform hover:scale-105 shadow-md">
                                    ${translations[lang].results_next_lesson}
                                </button>`;
                } else if (result.accuracy < 95) { // Failed lesson
                     ctaButton1 = `<button id="modal-retry-btn" class="w-full text-center text-lg font-semibold text-black bg-cyan-500 hover:bg-cyan-400 rounded-lg px-6 py-3 transition-all transform hover:scale-105 shadow-md">
                                    ${translations[lang].results_retry}
                                  </button>`;
                } else { // Passed, but it's the LAST lesson
                     ctaButton1 = `<button class="w-full text-center text-lg font-semibold text-white bg-green-600 rounded-lg px-6 py-3 shadow-md" disabled>
                                    Stage Complete!
                                </button>`;
                }
                
                ctaButton2 = `<button id="modal-back-to-lessons-btn" data-view="lessons" class="w-full text-center text-lg font-semibold text-cyan-400 bg-indigo-900 hover:bg-indigo-800 rounded-lg px-6 py-3 transition-all border border-indigo-700 shadow-md">
                                ${translations[lang].results_back_to_lessons}
                              </button>`;
                
            } else {
                // Default modal for time/words/quote/code
                modalTitle = translations[lang].results_title || 'Test Complete!';
                ctaButton1 = `<button id="modal-retry-btn" class="w-full text-center text-lg font-semibold text-black bg-cyan-500 hover:bg-cyan-400 rounded-lg px-6 py-3 transition-all transform hover:scale-105 shadow-md">
                                ${translations[lang].results_retry}
                              </button>`;
                ctaButton2 = `<button id="modal-next-btn" class="w-full text-center text-lg font-semibold text-cyan-400 bg-indigo-900 hover:bg-indigo-800 rounded-lg px-6 py-3 transition-all border border-indigo-700 shadow-md">
                                ${translations[lang].results_next}
                              </button>`;
            }
            
            // Get mode description
            let modeDesc;
            if (result.mode === 'time') modeDesc = `${result.duration}s (${result.difficulty})`;
            else if (result.mode === 'words') modeDesc = `${result.wordCount}w (${result.difficulty})`;
            else if (result.mode === 'lesson') modeDesc = `Lesson`;
            else if (result.mode === 'code') modeDesc = `Code`;
            else modeDesc = 'Quote';

            // Render modal content
            resultsModalContent.innerHTML = `
                <div class="p-6 md:p-8">
                    <div class="text-center">
                        <i data-lucide="${result.accuracy > 95 ? 'party-popper' : 'meh'}" class="w-16 h-16 ${result.accuracy > 95 ? 'text-cyan-400' : 'text-amber-400'} mx-auto"></i>
                        <h2 class="text-3xl font-bold text-center text-white mt-4 mb-6">
                            ${modalTitle}
                        </h2>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6 text-center mb-8">
                        <div>
                            <span class="text-sm font-semibold text-slate-400">${translations[lang].results_wpm}</span>
                            <span class="block text-6xl font-extrabold text-cyan-400">${result.wpm}</span>
                        </div>
                        <div>
                            <span class="text-sm font-semibold text-slate-400">${translations[lang].results_acc}</span>
                            <span class="block text-6xl font-extrabold text-slate-100">${result.accuracy.toFixed(0)}<span class="text-4xl text-slate-500">%</span></span>
                        </div>
                    </div>
                    
                    <div class="space-y-3 text-sm text-slate-300 mb-8 bg-indigo-800/50 p-4 rounded-lg border border-white/10">
                        <div class="flex justify-between">
                            <span>${translations[lang].results_raw_wpm}</span>
                            <span class="font-medium text-slate-100">${result.rawWpm}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>${translations[lang].results_chars}</span>
                            <span class="font-medium text-slate-100">${result.chars} (/)</span>
                        </div>
                        <div class="flex justify-between">
                            <span>${translations[lang].results_mistakes}</span>
                            <span class="font-medium text-red-400">${result.mistakes}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Mode</span>
                            <span class="font-medium text-slate-100">${modeDesc}</span>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        ${ctaButton1}
                        ${ctaButton2}
                    </div>
                </div>
            `;
            // Create icons *after* injecting HTML
            lucide.createIcons();
            resultsModal.classList.remove('hidden');
            
            // Add event listeners for new buttons
            if (result.mode === 'lesson') {
                const nextLessonBtn = document.getElementById('modal-next-lesson-btn');
                if (nextLessonBtn) {
                    nextLessonBtn.addEventListener('click', () => {
                        resultsModal.classList.add('hidden'); 
                        const lessonId = nextLessonBtn.dataset.lessonId;
                        const lesson = findLessonById(lessonId);
                        if (lesson) {
                            startLesson(lesson); 
                        } else {
                            console.error(`Could not find lesson with ID: ${lessonId}`);
                            window.location.hash = 'lessons';
                        }
                    });
                }
                
                const retryBtn = document.getElementById('modal-retry-btn');
                if (retryBtn) {
                    retryBtn.addEventListener('click', resetTest);
                }

                document.getElementById('modal-back-to-lessons-btn').addEventListener('click', () => {
                    resultsModal.classList.add('hidden');
                    window.location.hash = 'lessons';
                });
            } else {
                document.getElementById('modal-retry-btn').addEventListener('click', resetTest);
                document.getElementById('modal-next-btn').addEventListener('click', resetTest);
            }
        }
        
        
        // --- 6. LESSON LOGIC (Unchanged) ---
        
        // (Lesson data and functions are collapsed for brevity, they are identical to the previous version)
        const lessonData = {
            stages: [
                {
                    id: 'stage1',
                    title: 'Stage 1: The Home Row',
                    icon: 'grip-horizontal', // lucide icon name
                    lessons: [
                        { id: 'b1', title: 'Index Fingers: f, j', prompt: 'Place your index fingers on F and J. Gently type the letters.', text: 'f j fj jf ff jj ff jj f j f j' },
                        { id: 'b2', title: 'Practice: f, j', prompt: 'Let\'s keep practicing F and J.', text: 'f j j f fj jf j j f f j f f j j f' },
                        { id: 'b3', title: 'Middle Fingers: d, k', prompt: 'Use your middle fingers for D and K. Keep your index fingers on F and J.', text: 'd k dk kd dd kk dd kk d k d k' },
                        { id: 'b4', title: 'Practice: f, j, d, k', prompt: 'Combine all four keys. Take your time.', text: 'f j d k fj dk jf kd f d j k' },
                        { id: 'b5', title: 'Ring Fingers: s, l', prompt: 'Now use your ring fingers for S and L.', text: 's l sl ls ss ll ss ll s l s l' },
                        { id: 'b6', title: 'Practice: d, k, s, l', prompt: 'Practice the middle and ring finger keys.', text: 'd k s l dk sl kd ls s d k l' },
                        { id: 'b7', title: 'Pinky Fingers: a, ;', prompt: 'Finally, your pinky fingers on A and Semicolon (;).', text: 'a ; a; ;a aa ;; aa ;; a ; a ;' },
                        { id: 'b8', title: 'Home Row Review', prompt: 'Let\'s practice all the home row keys together.', text: 'asdf jkl; asdf jkl; a s d f j k l ;' },
                        { id: 'b9', title: 'Home Row Words', prompt: 'Practice simple words using only the home row.', text: 'a sad lad; a lass falls; ask a lad; all fall;' },
                        { id: 'b10', title: 'Home Row Challenge', prompt: 'Focus on accuracy. The home row is your foundation.', text: 'a sad lass; ask dad; a fall; a lad; glass; flask;' }
                    ]
                },
                {
                    id: 'stage2',
                    title: 'Stage 2: Top Row (E, R, U, I)',
                    icon: 'arrow-up',
                    lessons: [
                        { id: 'i1', title: 'Index Fingers Reach: r, u', prompt: 'Reach up with your index fingers for R and U. Return to F and J.', text: 'r u ru ur rr uu r u r u frf juj' },
                        { id: 'i2', title: 'Practice: r, u', prompt: 'Keep practicing R and U. Remember to return to home row.', text: 'ru jur fur fur rug jug frf juj ruf jur' },
                        { id: 'i3', title: 'Middle Fingers Reach: e, i', prompt: 'Reach up with your middle fingers for E and I. Return to D and K.', text: 'e i ei ie ee ii e i e i ded kik' },
                        { id: 'i4', title: 'Practice: e, i', prompt: 'Practice E and I. Focus on the stretch.', text: 'e i ki ke ski see die kid ded kik' },
                        { id: 'i5', title: 'Top Row Combo', prompt: 'Combine all four new keys: E, R, U, I.', text: 'e r u i er ui re iu fur due ride fire' },
                        { id: 'i6', title: 'Top & Home Row', prompt: 'Combine the top and home rows.', text: 'sure risk dial fur; a true life; i desire; feel free;' },
                        { id: 'i7', title: 'Top & Home Words', prompt: 'Practice more words with top and home row keys.', text: 'read slide; a dark ride; a leaf; a deer; a frail kid;' }
                    ]
                },
                {
                    id: 'stage3',
                    title: 'Stage 3: Top Row (T, Y, W, O, Q, P)',
                    icon: 'arrow-up-circle',
                    lessons: [
                        { id: 't1', title: 'Index Fingers Reach: t, y', prompt: 'Reach up with your index fingers for T and Y.', text: 't y ty yt tt yy t y t y ftf jyj' },
                        { id: 't2', title: 'Ring Fingers Reach: w, o', prompt: 'Reach up with your ring fingers for W and O.', text: 'w o wo ow ww oo w o w o sws lol' },
                        { id: 't3', title: 'Pinky Fingers Reach: q, p', prompt: 'Reach up with your pinky fingers for Q and P.', text: 'q p qp pq qq pp q p q p aqa ;p;' },
                        { id: 't4', title: 'Full Top Row', prompt: 'Practice all the top row keys.', text: 'q w e r t y u i o p' },
                        { id: 't5', title: 'Full Top Row Words', prompt: 'Words using the full top row.', text: 'type quiet power; we try; you were; proper prior; water;' },
                        { id: 't6', title: 'All Keys So Far', prompt: 'Combine home row and top row.', text: 'the quick; a brown fox; lazy dog; jump over; a true poet;' },
                    ]
                },
                {
                    id: 'stage4',
                    title: 'Stage 4: The Bottom Row',
                    icon: 'arrow-down',
                    lessons: [
                        { id: 'a1', title: 'Index Fingers Reach: v, m', prompt: 'Reach down with your index fingers for V and M.', text: 'v m vm mv vv mm v m v m fvf jmj' },
                        { id: 'a2', title: 'Middle Fingers Reach: c, ,', prompt: 'Reach down with your middle fingers for C and Comma (,).', text: 'c , c, ,c cc ,, c , c , dcd k,k' },
                        { id: 'a3', title: 'Ring Fingers Reach: x, .', prompt: 'Reach down with your ring fingers for X and Period (.).', text: 'x . x. .x xx .. x . x . sxs l.l' },
                        { id: 'a4', title: 'Pinky Fingers Reach: z, /', prompt: 'Reach down with your pinky fingers for Z and Slash (/).', text: 'z / z/ /z zz // z / z / aza ;/;' },
                        { id: 'a5', title: 'Bottom Row Review', prompt: 'Practice all the bottom row keys.', text: 'z x c v m , . /' },
                        { id: 'a6', title: 'All Rows Review', prompt: 'Practice words using all letter keys.', text: 'amazing; brave; complex; very; zoom; quick; javax; maze;' },
                        { id: 'a7', title: 'Punctuation Practice', prompt: 'Practice using the period and comma.', text: 'hello, world. i am typing. this is good, yes. very nice, i see.' }
                    ]
                },
                {
                    id: 'stage5',
                    title: 'Stage 5: Common English N-grams',
                    icon: 'link-2',
                    lessons: [
                        { id: 'n1', title: 'Double Letters: ll, ss, ee, oo', prompt: 'Practice common double letters.', text: 'all see look less; a green tree; food; class; grass;' },
                        { id: 'n2', title: 'Ending: -ing', prompt: 'Practice the "ing" ending.', text: 'going doing typing seeing working looking; the ring; a song;' },
                        { id: 'n3', title: 'Ending: -ed', prompt: 'Practice the "ed" ending.', text: 'called looked asked used worked; a closed door; i liked it;' },
                        { id: 'n4', title: 'Common Pair: th', prompt: 'Practice the "th" pair.', text: 'the then that this them there with; the path; a bath;' },
                        { id: 'n5', title: 'Common Pair: er, re', prompt: 'Practice "er" and "re".', text: 'her were there after water; are read more; a letter;' },
                        { id: 'n6', title: 'Common Pair: ou, yo', prompt: 'Practice "ou" and "yo".', text: 'out our about house; you your; a loud sound; your toy;' },
                        { id: 'n7', title: 'N-gram Review', prompt: 'Combine common pairs.', text: 'they are going; the other; i worked there; around the house;' }
                    ]
                },
                {
                    id: 'stage6',
                    title: 'Stage 6: Capitalization & Numbers',
                    icon: 'chevrons-up-down',
                    lessons: [
                        { id: 'c1', title: 'Shift Key Basics', prompt: 'Hold the RIGHT SHIFT with your right pinky and type A, S, D, F.', text: 'A S D F A S D F' },
                        { id: 'c2', title: 'Shift Key Basics', prompt: 'Hold the LEFT SHIFT with your left pinky and type J, K, L, ;.', text: 'J K L : J K L :' },
                        { id: 'c3', title: 'Capitalization', prompt: 'Practice capitalizing words.', text: 'Roy See The Quick Brown Fox Jumps Over The Lazy Dog.' },
                        { id: 'c4', title: 'Numbers Row: 1, 0', prompt: 'Use your pinky fingers for 1 and 0.', text: '1 0 10 01 11 00 1 0 1 0 a1a ;0;' },
                        { id: 'c5', title: 'Numbers Row: 2, 9', prompt: 'Use your ring fingers for 2 and 9.', text: '2 9 29 92 22 99 2 9 2 9 s2s l9l' },
                        { id: 'c6', title: 'Numbers Row: 3, 8', prompt: 'Use your middle fingers for 3 and 8.', text: '3 8 38 83 33 88 3 8 3 8 d3d k8k' },
                        { id: 'c7', title: 'Numbers Row: 4, 7', prompt: 'Use your index fingers for 4 and 7.', text: '4 7 47 74 44 77 4 7 4 7 f4f j7j' },
                        { id: 'c8', title: 'Numbers Row: 5, 6', prompt: 'Use your index fingers for 5 and 6.', text: '5 6 56 65 55 66 5 6 5 6 f5f j6j' },
                        { id: 'c9', title: 'Numbers Review', prompt: 'Practice all numbers.', text: '1 2 3 4 5 6 7 8 9 0' },
                        { id: 'c10', title: 'Alphanumeric Practice', prompt: 'Combine letters and numbers.', text: 'user1234 pass9876 address2_is_ok 2025' }
                    ]
                },
                {
                    id: 'stage7',
                    title: 'Stage 7: Common Symbols',
                    icon: 'asterisk',
                    lessons: [
                        { id: 's1', title: 'Symbols: ?, !', prompt: 'Practice the Question Mark and Exclamation Point (Shift + 1).', text: 'How? Why? When? Wow! No! Yes!' },
                        { id: 's2', title: 'Symbols: $, %', prompt: 'Practice the Dollar and Percent symbols (Shift + 4, 5).', text: '$100 50% $25.50 100% 75%' },
                        { id: 's3', title: 'Symbols: (, )', prompt: 'Practice Parentheses (Shift + 9, 0).', text: '( ) () (like this) (and this)' },
                        { id: 's4', title: 'Symbols: @, &', prompt: 'Practice At and Ampersand (Shift + 2, 7).', text: 'me@example.com you&me R&D' },
                        { id: 's5', title: 'Symbols: \', "', prompt: 'Practice Apostrophe and Quotation Mark.', text: 'it\'s a "quote". he said "hello".' },
                        { id: 's6', title: 'Programming: [], {}', prompt: 'Practice Brackets and Braces.', text: '[ ] { } [array] {object} [] {}' },
                    ]
                },
                {
                    id: 'stage8',
                    title: 'Stage 8: Fluency Builder',
                    icon: 'feather',
                    lessons: [
                        { id: 'f1', title: 'Common English Words', prompt: 'Practice the 100 most common English words.', text: 'the be to of and a in that have I it for not on with he as you do at this but his by from' },
                        { id: 'f2', title: 'Common English Words', prompt: 'Practice the 100 most common English words.', text: 'they we say her she or an will my one all would there their what so up out if about who' },
                        { id: 'f3', title: 'Difficult Words', prompt: 'Practice words with tricky combinations.', text: 'rhythm queue separate weird colonel liaison' },
                        { id: 'f4', title: 'Proverbs', prompt: 'Type these proverbs. Mind the punctuation.', text: 'Two wrongs don\'t make a right. When in Rome, do as the Romans do. The early bird catches the worm.' },
                        { id: 'f5', title: 'Paragraph Practice 1', prompt: 'Type this paragraph. Focus on flow.', text: 'Typing is a skill that requires patience and practice. By focusing on accuracy first, speed will naturally follow. Remember to take breaks and stretch your fingers. Good ergonomic posture is also very important to avoid strain. Keep going!' },
                        { id: 'f6', title: 'Paragraph Practice 2', prompt: 'Another paragraph. Focus on smooth rhythm.', text: 'The history of the modern computer is a fascinating story. It begins with mechanical calculators and evolves through vacuum tubes, transistors, and integrated circuits. Today, billions of people carry powerful computers in their pockets.' },
                        { id: 'f7', title: 'Paragraph Practice 3', prompt: 'Final paragraph. Try to maintain speed and accuracy.', text: 'Learning to type is a valuable investment in your personal and professional life. It can improve your productivity, open up new job opportunities, and make digital communication more efficient. Stick with it, and you will see results.' },
                        { id: 'f8', title: 'Quote: Steve Jobs', prompt: 'Type this famous quote.', text: 'The only way to do great work is to love what you do. If you haven\'t found it yet, keep looking. Don\'t settle. As with all matters of the heart, you\'ll know when you find it.' },
                        { id: 'f9', title: 'Quote: C.S. Lewis', prompt: 'Type this famous quote.', text: 'You can\'t go back and change the beginning, but you can start where you are and change the ending.' },
                        { id: 'f10', title: 'Final Challenge', prompt: 'A mix of everything. Good luck!', text: 'User: test@123. Code: { "id": 10, "value": "xyz" }. Quote: "Be yourself; everyone else is already taken." URL: https://example.com' }
                    ]
                }
            ]
        };
        
        function findLessonById(lessonId) {
            for (const stage of lessonData.stages) {
                const lesson = stage.lessons.find(l => l.id === lessonId);
                if (lesson) return lesson;
            }
            return null;
        }

        function findNextLesson(currentLessonId) {
            let foundCurrent = false;
            for (const stage of lessonData.stages) {
                for (const lesson of stage.lessons) {
                    if (foundCurrent) {
                        return lesson; // Return the very next lesson
                    }
                    if (lesson.id === currentLessonId) {
                        foundCurrent = true;
                    }
                }
            }
            return null; // No next lesson found
        }
        
        async function renderLessonDashboard() {
            lessonStagesContainer.innerHTML = '<div class="flex items-center justify-center text-slate-400"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mr-2"></i>Loading lessons...</div>';
            
            let completedLessons = {};
            if (userId) {
                try {
                    const progressPath = `/artifacts/${appId}/users/${userId}/lessonProgress`;
                    const q = query(collection(db, progressPath));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach((doc) => {
                        completedLessons[doc.id] = doc.data();
                    });
                } catch (e) {
                    console.error("Could not fetch lesson progress:", e);
                    lessonStagesContainer.innerHTML = '<div class="text-center text-red-400">Error: Could not load lesson progress.</div>';
                    return;
                }
            } else {
                lessonStagesContainer.innerHTML = '<div class="text-center text-amber-400">Please log in to see your lesson progress.</div>';
                return;
            }

            let html = '';
            let previousLessonId = null; 
            let isFirstLessonOverall = true;
            
            lessonData.stages.forEach(stage => {
                let lessonsInStage = stage.lessons.length;
                let completedInStage = 0;

                stage.lessons.forEach(lesson => {
                    if (completedLessons[lesson.id] && completedLessons[lesson.id].passed) {
                        completedInStage++;
                    }
                });
                
                const progressPercent = lessonsInStage > 0 ? (completedInStage / lessonsInStage) * 100 : 0;
                
                html += `
                    <div class="lesson-stage mb-12 bg-indigo-900/50 rounded-xl shadow-lg border border-white/10 overflow-hidden">
                        <div class="p-5 md:p-6 border-b border-white/10 bg-indigo-900">
                            <div class="flex flex-col sm:flex-row justify-between sm:items-center">
                                <h2 class="text-2xl md:text-3xl font-bold text-white mb-2 sm:mb-0 flex items-center">
                                    <i data-lucide="${stage.icon || 'graduation-cap'}" class="w-7 h-7 text-cyan-400 mr-3"></i>
                                    <span>${stage.title}</span>
                                </h2>
                                <span class="text-sm font-semibold text-slate-300">${completedInStage} / ${lessonsInStage} Complete</span>
                            </div>
                            <!-- Progress Bar -->
                            <div class="w-full bg-indigo-950 rounded-full h-2.5 mt-4">
                                <div class="bg-cyan-500 h-2.5 rounded-full transition-all duration-500" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 p-5 md:p-6">
                `;
                
                stage.lessons.forEach((lesson, index) => {
                    const isCompleted = completedLessons[lesson.id] && completedLessons[lesson.id].passed;
                    const isLocked = !isFirstLessonOverall && !isCompleted && !(previousLessonId && completedLessons[previousLessonId]);

                    let buttonText, buttonClass, iconHtml;
                    
                    if (isLocked) {
                        buttonText = 'Locked';
                        buttonClass = 'bg-indigo-950 text-slate-500 cursor-not-allowed';
                        iconHtml = `<i data-lucide="lock" class="w-4 h-4 text-slate-400"></i>`;
                    } else if (isCompleted) {
                        buttonText = 'Practice Again';
                        buttonClass = 'bg-green-500/10 text-green-400 hover:bg-green-500/20';
                        iconHtml = `<i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>`;
                    } else {
                        buttonText = 'Start Lesson';
                        buttonClass = 'bg-cyan-500/10 text-cyan-300 hover:bg-cyan-500/20';
                        iconHtml = `<i data-lucide="circle" class="w-4 h-4 text-slate-500"></i>`; // 'circle' for 'todo'
                    }

                    html += `
                        <div class="lesson-card ${isLocked ? 'locked' : ''} bg-indigo-900 rounded-lg shadow-md border border-white/10 overflow-hidden flex flex-col">
                            <div class="p-5 flex-grow">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-semibold ${isCompleted ? 'text-green-400' : (isLocked ? 'text-slate-500' : 'text-cyan-400')}">
                                        Lesson ${index + 1}
                                    </span>
                                    ${iconHtml}
                                </div>
                                <h3 class="text-lg font-bold text-white mt-1 mb-2">${lesson.title}</h3>
                                <p class="text-sm text-slate-300 mb-4">${lesson.prompt}</p>
                            </div>
                            <button data-lesson-id="${lesson.id}" ${isLocked ? 'disabled' : ''} class="lesson-start-btn w-full ${buttonClass} font-semibold px-5 py-3 transition-colors">
                                ${buttonText}
                            </button>
                        </div>
                    `;
                    
                    isFirstLessonOverall = false; 
                    if (!isLocked) {
                        previousLessonId = lesson.id;
                    }
                });
                
                html += `</div></div>`;
            });
            
            lessonStagesContainer.innerHTML = html;
            lucide.createIcons();
            
            lessonStagesContainer.querySelectorAll('.lesson-start-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const lesson = findLessonById(btn.dataset.lessonId);
                    startLesson(lesson);
                });
            });
        }
        
        function startLesson(lesson) {
            if (!lesson) return;
            console.log("Starting lesson:", lesson.id);
            
            testState.mode = 'lesson';
            testState.currentLessonId = lesson.id;
            
            // Set the hash to 'test', which triggers navigateTo('test', true)
            window.location.hash = 'test';
        }
 const botDifficultySettings = {
            'easy': { wpm: 40, mistakeChance: 0.03, burstiness: 0.3 },
            'medium': { wpm: 70, mistakeChance: 0.02, burstiness: 0.5 },
            'hard': { wpm: 100, mistakeChance: 0.01, burstiness: 0.7 },
            'pro': { wpm: 130, mistakeChance: 0.005, burstiness: 0.9 }
        };

        /**
         * Resets the bot race to its initial (config) state.
         * @param {boolean} [forceReset=false] - If true, resets even if race is active.
         */
        function resetBotRace(forceReset = false) {
            if (botRaceState.active && !forceReset) return;

            console.log("Resetting bot race.");

            if (botRaceState.timerInterval) clearInterval(botRaceState.timerInterval);
            if (botRaceState.botInterval) clearInterval(botRaceState.botInterval);

            botRaceState = {
                ...botRaceState, // Keep difficulty setting
                active: false,
                text: "",
                letters: [],
                totalLetters: 0,
                timerInterval: null,
                botInterval: null,
                startTime: null,
                playerIndex: 0,
                playerMistakes: 0,
                playerCorrectStrokes: 0,
                playerTotalStrokes: 0,
                playerFinished: false,
                botIndex: 0,
                botFinished: false,
            };
            
            // Get selected bot difficulty
            const selectedDifficulty = botDifficultyOptions.querySelector('.active').dataset.difficulty;
            botRaceState.difficulty = selectedDifficulty;
            botRaceState.botTargetWPM = botDifficultySettings[selectedDifficulty].wpm;

            // Reset UI
            botRaceConfigPanel.classList.remove('hidden');
            botRaceTypingArea.classList.add('hidden');
            startBotRaceBtn.classList.remove('hidden');
            botRaceTrack.classList.remove('hidden'); // Show track
            botRaceFinished.classList.add('hidden');
            botRaceCountdown.classList.add('hidden');
            
            playerProgress.style.width = '0%';
            botProgress.style.width = '0%';
            playerWPMDisplay.textContent = '0 WPM';
            botWPMDisplay.textContent = `${botRaceState.botTargetWPM} WPM`;
            
            botRaceInput.value = '';
            botRaceWordsContainer.innerHTML = ''; // Clear words
        }
        
        /**
         * Generates text for the bot race.
         */
        function getBotRaceText() {
            const langBank = wordBanks[currentLanguage] || wordBanks.en;
            const wordList = langBank.time_easy; // Use easy words for races
            let words = [];
            const count = 60; // Fixed 60 words for a race
            for (let i = 0; i < count; i++) {
                words.push(wordList[Math.floor(Math.random() * wordList.length)]);
            }
            return words.join(' ');
        }
        
        /**
         * Renders the bot race text into the DOM.
         */
        function renderBotRaceWords() {
            botRaceWordsContainer.innerHTML = '';
            botRaceState.letters = [];
            botRaceState.text = getBotRaceText();
            botRaceState.totalLetters = botRaceState.text.length;
            
            const words = botRaceState.text.split(' ');
            let letterIndex = 0;

            words.forEach((word, w_idx) => {
                const wordSpan = document.createElement('span');
                wordSpan.className = 'word inline-block mr-3';
                
                for (let l_idx = 0; l_idx < word.length; l_idx++) {
                    const letterSpan = document.createElement('span');
                    letterSpan.className = 'letter';
                    letterSpan.id = `bot-race-letter-${letterIndex}`;
                    letterSpan.textContent = word[l_idx];
                    wordSpan.appendChild(letterSpan);
                    botRaceState.letters.push(letterSpan);
                    letterIndex++;
                }

                if (w_idx < words.length - 1) {
                    const spaceSpan = document.createElement('span');
                    spaceSpan.className = 'letter';
                    spaceSpan.id = `bot-race-letter-${letterIndex}`;
                    spaceSpan.innerHTML = '&nbsp;';
                    wordSpan.appendChild(spaceSpan);
                    botRaceState.letters.push(spaceSpan);
                    letterIndex++;
                }
                botRaceWordsContainer.appendChild(wordSpan);
            });
            
            if (botRaceState.letters.length > 0) {
                botRaceState.letters[0].classList.add('caret-left');
            }
        }

        /**
         * Starts the countdown, then the race.
         */
        function startBotRaceCountdown() {
            botRaceConfigPanel.classList.add('hidden');
            botRaceTypingArea.classList.remove('hidden');
            botRaceFinished.classList.add('hidden');
            
            renderBotRaceWords();

            // --- FIX 1: Show overlay FIRST ---
            let countdown = 3;
            botRaceCountdownText.textContent = countdown;
            botRaceCountdown.classList.remove('hidden');
            botRaceCountdown.classList.add('flex');

            // --- FIX 2: Focus input AFTER showing overlay ---
            // This ensures the input is focused, even if showing
            // the overlay would have stolen focus. This is
            // still part of the user's click event.
            botRaceInput.focus();
            // --- END FIX ---

            const countdownInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    botRaceCountdownText.textContent = countdown;
                } else if (countdown === 0) {
                    botRaceCountdownText.textContent = 'GO!';
                } else {
                    clearInterval(countdownInterval);
                    botRaceCountdown.classList.add('hidden');
                    botRaceCountdown.classList.remove('flex');
                    actuallyStartBotRace();
                }
            }, 800);
        }
        
        /**
         * Called after countdown to begin the race.
         */
        function actuallyStartBotRace() {
            if (botRaceState.active) return;
            
            botRaceState.active = true;
            botRaceState.startTime = new Date().getTime();
            
            // --- FIX 3: Re-focus AFTER countdown is hidden ---
            // When the countdown overlay is hidden, the browser
            // might lose focus. This call ensures it's
            // given back to the input right as the race starts.
            botRaceInput.focus();
            // --- END FIX ---

            // Start player WPM updater
            botRaceState.timerInterval = setInterval(updatePlayerRaceStats, 500);
            
            // Start Bot AI
            startBotAI();
        }
        
        /**
         * Updates the player's WPM display during the race.
         */
        function updatePlayerRaceStats() {
            if (!botRaceState.active || !botRaceState.startTime || botRaceState.playerFinished) return;
            
            const now = new Date().getTime();
            const elapsedSeconds = (now - botRaceState.startTime) / 1000;
            
            if (elapsedSeconds === 0) return;
            
            const wpm = (botRaceState.playerCorrectStrokes / 5) / (elapsedSeconds / 60);
            playerWPMDisplay.textContent = `${Math.round(wpm) || 0} WPM`;
        }

        /**
         * Main input handler for the bot race.
         */
        function handleBotRaceKeyInput(e) {
            if (!botRaceState.active || botRaceState.playerFinished) {
                e.preventDefault();
                return;
            }

            if (botRaceState.playerIndex >= botRaceState.totalLetters) return;

            const key = e.key;
            const currentLetterSpan = botRaceState.letters[botRaceState.playerIndex];
            const expectedLetter = currentLetterSpan.textContent.replace('\u00A0', ' ');

            // 1. Handle Backspace
            if (key === 'Backspace') {
                e.preventDefault();
                if (botRaceState.playerIndex > 0) {
                    botRaceState.letters[botRaceState.playerIndex].classList.remove('caret-left');
                    botRaceState.playerIndex--;
                    
                    const newCurrentLetterSpan = botRaceState.letters[botRaceState.playerIndex];
                    
                    if (newCurrentLetterSpan.classList.contains('correct')) {
                        botRaceState.playerCorrectStrokes--;
                        botRaceState.playerTotalStrokes--;
                    } else if (newCurrentLetterSpan.classList.contains('incorrect')) {
                        botRaceState.playerMistakes--;
                        botRaceState.playerTotalStrokes--;
                    }
                    
                    newCurrentLetterSpan.classList.remove('correct', 'incorrect', 'incorrect-space');
                    newCurrentLetterSpan.classList.add('caret-left');
                }
                return;
            }

            // 2. Ignore non-printable keys
            if (key.length > 1) return;
            if (key === ' ') e.preventDefault();

            botRaceState.playerTotalStrokes++;

            // 3. Handle Correct/Incorrect
            if (key === expectedLetter) {
                currentLetterSpan.classList.add('correct');
                botRaceState.playerCorrectStrokes++;
            } else {
                currentLetterSpan.classList.add('incorrect');
                botRaceState.playerMistakes++;
                if(expectedLetter === ' ') {
                    currentLetterSpan.classList.add('incorrect-space');
                }
            }

            // 4. Move Caret & Update Progress
            currentLetterSpan.classList.remove('caret-left');
            botRaceState.playerIndex++;
            
            const playerProgressPercent = (botRaceState.playerIndex / botRaceState.totalLetters) * 100;
            playerProgress.style.width = `${playerProgressPercent}%`;

            // 5. Check for finish
            if (botRaceState.playerIndex >= botRaceState.totalLetters) {
                botRaceState.playerFinished = true;
                botRaceInput.blur();
                checkRaceEndCondition();
            } else {
                botRaceState.letters[botRaceState.playerIndex].classList.add('caret-left');
                
                // Scroll container
                const caretRect = botRaceState.letters[botRaceState.playerIndex].getBoundingClientRect();
                const containerRect = botRaceWordsContainer.getBoundingClientRect();
                if (caretRect.bottom > containerRect.bottom - 10) {
                    botRaceWordsContainer.scrollTop += caretRect.height + 16;
                }
            }
            
            updatePlayerRaceStats(); // Update WPM on every keypress
        }

        /**
         * Starts the bot's typing simulation.
         */
        function startBotAI() {
            const settings = botDifficultySettings[botRaceState.difficulty];
            
            // Calculate avg time per keystroke in ms
            const charsPerSecond = (settings.wpm * 5) / 60;
            let avgInterval = 1000 / charsPerSecond;

            botRaceState.botInterval = setInterval(() => {
                if (!botRaceState.active || botRaceState.botFinished) {
                    clearInterval(botRaceState.botInterval);
                    return;
                }

                // Add "burstiness"
                const burstMod = (Math.random() - 0.5) * settings.burstiness;
                const typingChance = 1 - burstMod;
                
                if (Math.random() > typingChance) {
                    // Bot "pauses"
                    return;
                }

                // Add "mistakes"
                if (Math.random() < settings.mistakeChance) {
                    // Bot makes a "mistake", pauses for 2x interval
                    setTimeout(() => {
                        advanceBot(); // Then "corrects" it (we just advance)
                    }, avgInterval * 2);
                } else {
                    advanceBot();
                }

            }, avgInterval);
        }
        
        /**
         * Advances the bot's progress by one letter.
         */
        function advanceBot() {
            if (botRaceState.botIndex >= botRaceState.totalLetters) return;
            
            botRaceState.botIndex++;
            
            const botProgressPercent = (botRaceState.botIndex / botRaceState.totalLetters) * 100;
            botProgress.style.width = `${botProgressPercent}%`;
            
            if (botRaceState.botIndex >= botRaceState.totalLetters) {
                botRaceState.botFinished = true;
                checkRaceEndCondition();
            }
        }
        
        /**
         * Checks if the race is over and shows results.
         */
        function checkRaceEndCondition() {
            if (!botRaceState.active) return; // Already ended
            if (!botRaceState.playerFinished && !botRaceState.botFinished) return; // Still going

            // Stop all intervals
            if (botRaceState.timerInterval) clearInterval(botRaceState.timerInterval);
            if (botRaceState.botInterval) clearInterval(botRaceState.botInterval);
            botRaceState.active = false;
            
            // Show result overlay
            if (botRaceState.playerFinished && !botRaceState.botFinished) {
                botRaceResultText.textContent = "You Win!";
                botRaceResultText.classList.remove('text-red-400');
                botRaceResultText.classList.add('text-cyan-400');
            } else {
                botRaceResultText.textContent = "Bot Wins!";
                botRaceResultText.classList.remove('text-cyan-400');
                botRaceResultText.classList.add('text-red-400');
            }
            
            botRaceFinished.classList.remove('hidden');
            botRaceFinished.classList.add('flex');
            
            // Final WPM calculation for player
            updatePlayerRaceStats();
        }

        // --- 7. EVENT LISTENERS ---

        // Authentication
        showAuthModalBtn.addEventListener('click', () => {
            authModal.classList.remove('hidden');
            authErrorMsg.textContent = '';
        });

        closeAuthModalBtn.addEventListener('click', () => {
            authModal.classList.add('hidden');
        });

        authTabSignin.addEventListener('click', () => {
            currentAuthMode = 'signin';
            authTabSignin.classList.add('text-cyan-400', 'border-cyan-400');
            authTabSignin.classList.remove('text-slate-500', 'border-transparent');
            authTabSignup.classList.add('text-slate-400', 'border-transparent');
            authTabSignup.classList.remove('text-cyan-400', 'border-cyan-400');
            authSubmitBtn.textContent = 'Sign In';
            authFormTitle.textContent = 'Sign in to save your results and track progress.';
            authErrorMsg.textContent = '';
            authNameGroup.classList.add('hidden');
            authName.required = false;
        });

        authTabSignup.addEventListener('click', () => {
            currentAuthMode = 'signup';
            authTabSignup.classList.add('text-cyan-400', 'border-cyan-400');
            authTabSignup.classList.remove('text-slate-400', 'border-transparent');
            authTabSignin.classList.add('text-slate-400', 'border-transparent');
            authTabSignin.classList.remove('text-cyan-400', 'border-cyan-400');
            authSubmitBtn.textContent = 'Create Account';
            authFormTitle.textContent = 'Create an account to save results and compete.';
            authErrorMsg.textContent = '';
            authNameGroup.classList.remove('hidden');
            authName.required = true;
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = authEmail.value;
            const password = authPassword.value;
            const name = authName.value;
            authErrorMsg.textContent = '';
            authSubmitBtn.disabled = true;
            authSubmitBtn.textContent = 'Loading...';

            try {
                if (currentAuthMode === 'signin') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    if (!name) {
                        throw new Error("Please enter your name.");
                    }
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    await updateProfile(user, { displayName: name });
                    
                    const userProfilePath = `/artifacts/${appId}/users/${user.uid}/profile/info`;
                    await setDoc(doc(db, userProfilePath), {
                        name: name,
                        email: email,
                        joined: serverTimestamp()
                    });
                }
            } catch (error) {
                console.error("Auth Error:", error.code, error.message);
                authErrorMsg.textContent = error.message.replace('Firebase: ', '');
            }
            
            authSubmitBtn.disabled = false;
            authSubmitBtn.textContent = currentAuthMode === 'signin' ? 'Sign In' : 'Create Account';
        });

        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        });

        userProfileBtn.addEventListener('click', () => {
            userProfileDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!userInfo.contains(e.target) && !userProfileDropdown.classList.contains('hidden')) {
                userProfileDropdown.classList.add('hidden');
            }
        });


        // Navigation (MODIFIED: Sets hash instead of calling navigateTo directly)
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                // When a link is clicked, change the URL hash. The hashchange event handler will then update the UI.
                window.location.hash = e.currentTarget.dataset.view;
            });
        });
        
        mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });
        
        // i18n
        document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
        document.getElementById('lang-bn').addEventListener('click', () => setLanguage('bn'));

        // Test Area
        testModeOptions.addEventListener('click', (e) => {
            const button = e.target.closest('button.test-mode-btn');
            if (!button) return;

            // Update button styles for segmented control
            testModeOptions.querySelectorAll('button.test-mode-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            button.classList.add('active');
            button.setAttribute('aria-selected', 'true');
            
            // Update state
            testState.mode = button.dataset.mode;
            if (testState.mode === 'time') {
                testState.duration = parseInt(button.dataset.value, 10);
                testState.wordCount = 0;
            } else if (testState.mode === 'words') {
                testState.wordCount = parseInt(button.dataset.value, 10);
                testState.duration = 0;
            } else {
                // quote, code
                testState.duration = 0;
                testState.wordCount = 0;
            }
            
            // Show/hide difficulty toggle
            if (testState.mode === 'time' || testState.mode === 'words') {
                testDifficultyOptions.classList.remove('hidden');
            } else {
                testDifficultyOptions.classList.add('hidden');
            }
            
            resetTest();
        });
        
        testDifficultyOptions.addEventListener('click', (e) => {
            const button = e.target.closest('button.test-difficulty-btn');
            if (!button) return;
            
            testDifficultyOptions.querySelectorAll('button.test-difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-selected', 'false');
            });
            button.classList.add('active');
            button.setAttribute('aria-selected', 'true');
            
            testState.difficulty = button.dataset.difficulty;
            resetTest();
        });


        restartTestBtn.addEventListener('click', () => {
             // If in lesson mode, restart should just restart the lesson
             // not change the mode
            resetTest();
        });
        
        focusPrompt.addEventListener('click', () => {
            mainInput.focus();
        });
        
        mainInput.addEventListener('focus', () => {
             if (!testState.active) {
                focusPrompt.style.opacity = 0; // Fade out
                setTimeout(() => focusPrompt.classList.add('hidden'), 300);
             }
        });
        
        mainInput.addEventListener('blur', () => {
            if (!testState.active) {
                focusPrompt.classList.remove('hidden');
                focusPrompt.style.opacity = 1; // Fade in
            }
        });
        
        mainInput.addEventListener('keydown', handleKeyInput);
        
        document.addEventListener('keydown', (e) => {
            // Add visual key press for on-screen keyboard
            document.querySelector(`.key[data-code="${e.code}"]`)?.classList.add('active');

            // --- FIX for main test focus ---
            if (!testState.active && currentView === 'test' && e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                // Check if a modal is open
                if (isModalOpen()) return;
                mainInput.focus();
            }
            // --- END FIX ---
            
            // --- NEW FIX for bot race focus ---
            // If we are on the bot race view and the race is about to start (active=false, but countdown is finished)
            // or has just started, and the user presses a key, force focus to the input.
            if (currentView === 'bot-race' && !botRaceState.playerFinished && e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                // Check if a modal is open (like the auth modal)
                if (isModalOpen()) return;
                
                // Don't steal focus if user is in config panel
                if (!botRaceConfigPanel.classList.contains('hidden')) return; 

                botRaceInput.focus();
            }
            // --- END NEW FIX ---
        });

        // Add global keyup listener for visual keyboard
        document.addEventListener('keyup', (e) => {
            document.querySelector(`.key[data-code="${e.code}"]`)?.classList.remove('active');
        });

        // HASH CHANGE LISTENER (NEW)
        function handleHashChange() {
            const hash = window.location.hash.replace('#', '');
            const validViews = ['home', 'test', 'dashboard', 'leaderboard', 'lessons', 'bot-race'];
            let viewToLoad = validViews.includes(hash) ? hash : 'home';

            // Use the existing navigateTo function to update the UI state.
            // We use forceLoad: true to ensure the view loads even if it's the same view (important for data loading/init).
            navigateTo(viewToLoad, true); 
        }
        
        window.addEventListener('hashchange', handleHashChange);


        // --- 8. APP STARTUP (MODIFIED) ---
        
        document.addEventListener('DOMContentLoaded', () => {
            setupAuth();
            setLanguage(currentLanguage);
            
            // 1. Determine initial view from URL hash, default to 'home'
            const initialHash = window.location.hash.replace('#', '');
            const validViews = ['home', 'test', 'dashboard', 'leaderboard', 'lessons', 'bot-race'];
            let initialView = validViews.includes(initialHash) ? initialHash : 'home';
            
            // 2. Set the initial hash explicitly if it was missing, for a clean URL
            if (window.location.hash === '' || window.location.hash === '#') {
                window.location.hash = 'home';
            }
            
            // 3. Navigate to the determined view (will trigger data load/UI setup)
            navigateTo(initialView, true);
            
            // Initialize all icons on the page
            lucide.createIcons();
            
            // Dashboard pagination listeners
            document.getElementById('dash-prev-btn')?.addEventListener('click', () => {
                if (dashboardCurrentPage > 1) {
                    dashboardCurrentPage--;
                    renderDashboardTable();
                }
            });
            
            document.getElementById('dash-next-btn')?.addEventListener('click', () => {
                const totalPages = Math.ceil(dashboardAllResults.length / dashboardPageSize);
                if (dashboardCurrentPage < totalPages) {
                    dashboardCurrentPage++;
                    renderDashboardTable();
                }
            });
            
            // NEW: Dashboard Chart Filter listener
            document.getElementById('dashboard-chart-filter')?.addEventListener('click', (e) => {
                const button = e.target.closest('button.chart-filter-btn');
                if (!button) return;

                // Update button styles
                document.querySelectorAll('#dashboard-chart-filter .chart-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                });
                button.classList.add('active');
                button.setAttribute('aria-selected', 'true');

                // Update filter state
                dashboardChartFilter = button.dataset.filter;
                
                // Re-render the chart with the new filter
                renderDashboardChart();
            });
            
            // Leaderboard filter listeners
            document.getElementById('leaderboard-filter-panel').addEventListener('click', (e) => {
                const button = e.target.closest('button.leaderboard-filter-btn');
                if (!button) return;

                document.querySelectorAll('#leaderboard-filter-panel .leaderboard-filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                });
                button.classList.add('active');
                button.setAttribute('aria-selected', 'true');
                
                // Update filter state
                leaderboardFilter.mode = button.dataset.mode;
                if (leaderboardFilter.mode === 'time') {
                    leaderboardFilter.duration = parseInt(button.dataset.value, 10);
                    leaderboardFilter.wordCount = 0;
                } else { // words
                    leaderboardFilter.wordCount = parseInt(button.dataset.value, 10);
                    leaderboardFilter.duration = 0;
                }
                
                // Reload data
                loadLeaderboardData();
            });
            
            // Leaderboard pagination listeners
            document.getElementById('lead-prev-btn')?.addEventListener('click', () => {
                if (leaderboardCurrentPage > 1) {
                    leaderboardCurrentPage--;
                    renderLeaderboardTable();
                }
            });
            
            document.getElementById('lead-next-btn')?.addEventListener('click', () => {
                const totalPages = Math.ceil(leaderboardAllResults.length / leaderboardPageSize);
                if (leaderboardCurrentPage < totalPages) {
                    leaderboardCurrentPage++;
                    renderLeaderboardTable();
                }
            });
            // ADD NEW BOT RACE LISTENERS
            botDifficultyOptions.addEventListener('click', (e) => {
                const button = e.target.closest('button.bot-difficulty-btn');
                if (!button || botRaceState.active) return;
                
                botDifficultyOptions.querySelectorAll('button.bot-difficulty-btn').forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                });
                button.classList.add('active');
                button.setAttribute('aria-selected', 'true');
                
                botRaceState.difficulty = button.dataset.difficulty;
                botRaceState.botTargetWPM = botDifficultySettings[botRaceState.difficulty].wpm;
                botWPMDisplay.textContent = `${botRaceState.botTargetWPM} WPM`;
            });
            
            startBotRaceBtn.addEventListener('click', startBotRaceCountdown);
            botRaceRestartBtn.addEventListener('click', () => resetBotRace(true));
            
            botRaceInput.addEventListener('keydown', handleBotRaceKeyInput);
            
            botRaceInput.addEventListener('focus', () => {
                // You can add focus styles if needed
            });
            
            botRaceInput.addEventListener('blur', () => {
                // You can add blur styles if needed
            });
        });

    </script>
</body>
</html>